var to=Object.defineProperty;var so=(a,s,e)=>s in a?to(a,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[s]=e;var p=(a,s,e)=>(so(a,typeof s!="symbol"?s+"":s,e),e);import{t as ao,c as no,r as d,j as t,n as io,l as Le,C as oo,B as ro,N as lo,a as Ga,T as co,G as ho,b as uo,R as mo,F as po,L as fo,d as xo,E as pa,e as go,f as zt,g as bo,S as Ts,A as yo,h as vo,p as So,i as jo,k as be,U as Ta,M as Va,m as wo,o as Dt,q as _,s as U,P as Ra,u as No,v as Co,w as Zo,x as ko,y as Vs,z as Rs,D as Wa,V as Go,H as To,I as La,J as Vo,K as Ro,O as Wo,Q as Lo,W as Xo,X as Io,Y as Fo,Z as Ko,_ as zo,$ as Do,a0 as Yo,a1 as Ho,a2 as Mo,a3 as fa,a4 as Po,a5 as Uo,a6 as Ao,a7 as Bo,a8 as Eo,a9 as Oo,aa as Jo,ab as Qo,ac as xa,ad as _o,ae as $o,af as qo,ag as er,ah as tr,ai as sr,aj as ar,ak as nr,al as ir,am as or,an as rr,ao as lr,ap as cr,aq as dr,ar as hr,as as ur,at as mr,au as pr,av as fr,aw as xr,ax as gr,ay as br,az as yr,aA as vr,aB as Sr,aC as jr,aD as wr,aE as Nr,aF as Cr,aG as Zr,aH as kr,aI as Gr,aJ as Tr,aK as Vr,aL as Rr,aM as Wr,aN as Lr,aO as Xr,aP as Ir,aQ as Fr,aR as Kr,aS as zr,aT as Dr,aU as Yr,aV as Hr,aW as Mr,aX as Pr,aY as Ur,aZ as Ar,a_ as Br,a$ as Er,b0 as Or,b1 as Jr,b2 as Qr,b3 as _r,b4 as $r,b5 as qr,b6 as el,b7 as tl,b8 as Ws,b9 as Xa,ba as Ls,bb as Xs,bc as Is,bd as Fs,be as Ks,bf as Qt,bg as zs,bh as Ds,bi as Ia,bj as Ys,bk as Hs,bl as Fa,bm as Ka,bn as sl,bo as al,bp as vt,bq as za,br as Da,bs as Ya,bt as Ha,bu as nl,bv as Ma,bw as Pa,bx as Ua,by as Aa,bz as Ba,bA as Ea,bB as Oa,bC as il,bD as Ja,bE as Qa,bF as ol,bG as _a,bH as $a,bI as qa,bJ as rl,bK as ll,bL as en,bM as oe,bN as tn,bO as cl,bP as dl,bQ as hl,bR as sn,bS as an,bT as qe,bU as et,bV as nn,bW as ul,bX as on,bY as rn,bZ as ln,b_ as cn,b$ as dn,c0 as hn,c1 as ml,c2 as pl,c3 as un,c4 as mn,c5 as pn,c6 as fl,c7 as xl,c8 as fn,c9 as gl,ca as bl,cb as yl,cc as xn,cd as vl,ce as Sl,cf as gn,cg as jl,ch as bn,ci as wl,cj as Nl,ck as yn,cl as Cl,cm as vn,cn as Sn,co as Zl,cp as kl,cq as jn,cr as Gl,cs as Tl,ct as Vl,cu as wn,cv as Ms,cw as Rl,cx as Wl,cy as Ll,cz as Nn,cA as Cn,cB as Zn,cC as Ps,cD as kn,cE as Gn,cF as Tn,cG as J,cH as Te,cI as Xl,cJ as _t,cK as Us,cL as Il,cM as je,cN as Fl,cO as Kl,cP as Ye,cQ as zl,cR as Dl,cS as Yl,cT as Hl,cU as Ml,cV as Pl,cW as Ul,cX as Al,cY as Bl,cZ as El,c_ as Ol,c$ as As,d0 as Jl,d1 as Ql,d2 as _l,d3 as $l,d4 as dt,d5 as ql,d6 as ec,d7 as Vn,d8 as Rn,d9 as tc,da as y,db as ne,dc as sc,dd as ac,de as nc,df as ic,dg as oc,dh as rc,di as lc,dj as cc,dk as dc,dl as hc,dm as uc,dn as mc,dp as pc,dq as fc,dr as xc,ds as gc,dt as bc,du as Wn,dv as Ln,dw as Xn,dx as In,dy as Fn,dz as Kn,dA as yc,dB as vc,dC as Sc,dD as jc,dE as wc}from"./vendor-fe44eb8f.js";function vm(){import.meta.url,import("_").catch(()=>1);async function*a(){}}(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();function g(...a){return ao(no(a))}function zn(a,s,e="mp4"){const n=document.createElement("a");n.setAttribute("download","".concat(a,".").concat(e)),n.setAttribute("href",s),document.body.appendChild(n),n.click(),document.body.removeChild(n)}function ut(a){const s=a.name.split(".").pop()||"";return{name:a.name.substring(0,a.name.lastIndexOf(".")),ext:s}}function Dn({accept:a="*",multiple:s=!1}={}){return new Promise((e,n)=>{let i=document.createElement("input");i.type="file",i.accept=a,i.multiple=s,i.style.display="none",i.addEventListener("change",o=>{const r=Array.from(o.target.files||[]);r.length>0?e(r):n(new Error("No files selected")),document.body.removeChild(i),i=null}),i.addEventListener("error",()=>{n(new Error("Error selecting files")),document.body.removeChild(i)}),i.addEventListener("cancel",()=>{n(new Error("File deselected!")),document.body.removeChild(i)}),document.body.appendChild(i),i.click()})}function Nc(a){return new Promise((s,e)=>{const n=new FileReader;n.onload=i=>{i.target&&s(i.target.result)},n.onerror=e,n.readAsText(a)})}const $t=d.forwardRef(({className:a,...s},e)=>t.jsx("div",{className:"relative w-full overflow-auto",children:t.jsx("table",{ref:e,className:g("w-full caption-bottom text-sm",a),...s})}));$t.displayName="Table";const qt=d.forwardRef(({className:a,...s},e)=>t.jsx("thead",{ref:e,className:g("[&_tr]:border-b",a),...s}));qt.displayName="TableHeader";const es=d.forwardRef(({className:a,...s},e)=>t.jsx("tbody",{ref:e,className:g("[&_tr:last-child]:border-0",a),...s}));es.displayName="TableBody";const Cc=d.forwardRef(({className:a,...s},e)=>t.jsx("tfoot",{ref:e,className:g("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...s}));Cc.displayName="TableFooter";const Ie=d.forwardRef(({className:a,...s},e)=>t.jsx("tr",{ref:e,className:g("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...s}));Ie.displayName="TableRow";const Fe=d.forwardRef(({className:a,...s},e)=>t.jsx("th",{ref:e,className:g("h-8 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",a),...s}));Fe.displayName="TableHead";const Ke=d.forwardRef(({className:a,...s},e)=>t.jsx("td",{ref:e,className:g("p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",a),...s}));Ke.displayName="TableCell";const Zc=d.forwardRef(({className:a,...s},e)=>t.jsx("caption",{ref:e,className:g("mt-4 text-sm text-muted-foreground",a),...s}));Zc.displayName="TableCaption";async function kc(a,s,e,n){const i=a.sampleRate,o=a.numberOfChannels,r=Math.floor(s*i),l=i*e,c=new OfflineAudioContext(o,l,i);let u=c.createBuffer(o,l,i);const h=new Float32Array(l);for(let m=0;m<a.numberOfChannels;m++)a.copyFromChannel(h,m,r),u.copyToChannel(h,m);if(typeof n<"u"){const m=c.createBufferSource();m.buffer=u;const f=c.createGain();f.gain.value=n,m.connect(f),f.connect(c.destination),m.start(),u=await c.startRendering()}return u}async function Gc(a,s=44100){return new Promise((e,n)=>{const i=new AudioContext({sampleRate:s});i.decodeAudioData(a,e,n).finally(()=>{i.close()})})}async function Tc(a){const s=await(await fetch(a)).arrayBuffer();return await Gc(s)}const Yn={codec:"avc1.42002A",width:1920,height:1080,bitrate:12e6},Hn={codec:"mp4a.40.2",numberOfChannels:2,sampleRate:44100,bitrate:128e3};async function Vc(){let a=!1,s=!1;return typeof VideoEncoder<"u"&&typeof VideoFrame<"u"&&(await VideoEncoder.isConfigSupported(Yn)).supported&&(a=!0),typeof OfflineAudioContext<"u"&&typeof AudioEncoder<"u"&&typeof AudioData<"u"&&(await AudioEncoder.isConfigSupported(Hn)).supported&&(s=!0),{video:a,audio:s}}function te(){return io(8)}Le.setLevel("ERROR");function Rc(a){return new Promise(s=>setTimeout(s,a))}function Wc(a,s,e){return Math.abs(a-s)<e}async function Bs(a,s){if(!s)return[];const e=[];for(const n of s){const i=await Lc(a,n);e.push(i)}return e}async function Lc(a,s){return await a[s.__type].fromJSON(s)}function St(a,s,e=!1){e&&(s.name=a.name),s.label=a.label}function jt(a){return{__type:a.type,label:a.label,name:a.name}}function wt(a,s){s.label=a.label,s.name=a.name}class mt extends oo{constructor(){super();p(this,"label","");p(this,"name",te());p(this,"type","BlackMaskFilter");this.blackAndWhite(!0),this.brightness(0,!0)}clone(e=!1){const n=new mt;return St(this,n,e),n}toJSON(){return jt(this)}static fromJSON(e){const n=new mt;return wt(e,n),n}}class Yt extends ro{constructor(){super(...arguments);p(this,"label","");p(this,"name",te());p(this,"type","BlurFilter")}clone(e=!1){const n=new Yt;return St(this,n,e),n}toJSON(){return jt(this)}static fromJSON(e){const n=new Yt;return wt(e,n),n}}class Ht extends lo{constructor(){super(...arguments);p(this,"label","");p(this,"name",te());p(this,"type","NoiseFilter")}clone(e=!1){const n=new Ht;return St(this,n,e),n}toJSON(){return jt(this)}static fromJSON(e){const n=new Ht;return wt(e,n),n}}class Mt extends Ga{constructor(){super(...arguments);p(this,"label","");p(this,"name",te());p(this,"type","OldFilmFilter")}clone(e=!1){const n=new Mt;return St(this,n,e),n}toJSON(){return jt(this)}static fromJSON(e){const n=new Mt;return wt(e,n),n}}class Pt extends Ga{constructor(){super();p(this,"label","");p(this,"name",te());p(this,"type","VignetteFilter");this.sepia=0,this.noise=0,this.vignetting=.5}clone(e=!1){const n=new Pt;return St(this,n,e),n}toJSON(){return jt(this)}static fromJSON(e){const n=new Pt;return wt(e,n),n}}const Mn={BlackMaskFilter:mt,BlurFilter:Yt,NoiseFilter:Ht,OldFilmFilter:Mt,VignetteFilter:Pt};function Pn(a){return Bs(Mn,a)}function Nt(a,s,e=!1,n=!1){var i;e&&(s.name=a.name),s.label=a.label,s.type=a.type,s.visible=a.visible,s.alpha=a.alpha,s.zIndex=a.zIndex,s.setTransform(...Un(a)),n||(s.width=a.width,s.height=a.height),s.filters=((i=a.filters)==null?void 0:i.map(o=>o.clone(e)))||null}function Ct(a,s=!1){var n;let e={__type:a.type,name:a.name,label:a.label,type:a.type,visible:a.visible,alpha:a.alpha,zIndex:a.zIndex,transform:Un(a),filters:((n=a.filters)==null?void 0:n.map(i=>i.toJSON()))||null};return s||(e={...e,width:a.width,height:a.height}),e}async function Zt(a,s,e=!1){s.name=a.name,s.label=a.label,s.type=a.type,s.visible=a.visible,s.alpha=a.alpha,s.zIndex=a.zIndex,s.setTransform(...a.transform),e||(typeof a.width=="number"&&(s.width=a.width),typeof a.height=="number"&&(s.height=a.height)),s.filters=await Pn(a.filters)}function _e(a){return a.width===a.texture.width&&a.height===a.texture.height&&a.width===1&&a.height===1}function Un(a){return[a.x,a.y,a.scale.x,a.scale.y,a.rotation,a.skew.x,a.skew.y,a.pivot.x,a.pivot.y]}class de extends co{constructor(){super(...arguments);p(this,"name",te());p(this,"label","");p(this,"type","Text");p(this,"disableTextEdit",!1)}async load(){}clone(e=!1){const n=new de(this.text,this.style.clone());return Nt(this,n,e,!0),n.disableTextEdit=this.disableTextEdit,n}toJSON(){return{...Ct(this,!0),text:this.text,disableTextEdit:this.disableTextEdit,style:{fontSize:this.style.fontSize,fontWeight:this.style.fontWeight,fontStyle:this.style.fontStyle,fontFamily:this.style.fontFamily,fill:this.style.fill,wordWrap:this.style.wordWrap,breakWords:this.style.breakWords,wordWrapWidth:this.style.wordWrapWidth,leading:this.style.leading}}}static async fromJSON(e){const n=new de(e.text,e.style);return await Zt(e,n,!0),n.disableTextEdit=e.disableTextEdit,n}}class $e extends ho{constructor(){super(...arguments);p(this,"name",te());p(this,"label","");p(this,"type","Graphics");p(this,"fillColor","")}async load(){}clone(e=!1){const n=new $e(super.clone().geometry);return Nt(this,n,e),n.fillColor=this.fillColor,n}toJSON(){return{...Ct(this),fillColor:this.fillColor,graphicsData:this.geometry.graphicsData.map(e=>[e.shape,{...e.fillStyle,texture:void 0},{...e.lineStyle,texture:void 0}])}}static async fromJSON(e){const n=new uo;n.graphicsData=e.graphicsData.map(o=>{const r=new mo;r.x=o[0].x,r.y=o[0].y,r.width=o[0].width,r.height=o[0].height;const l=new po;l.alpha=o[1].alpha,l.color=o[1].color,l.visible=o[1].visible;const c=new fo;return c.color=o[2].color,c.alpha=o[2].alpha,c.visible=o[2].visible,c.width=o[2].width,c.alignment=o[2].alignment,c.native=o[2].native,c.cap=o[2].cap,c.join=o[2].join,c.miterLimit=o[2].miterLimit,new xo(r,l,c)});const i=new $e(n);return await Zt(e,i),i.fillColor=e.fillColor,i}}const Xc={extension:pa.Asset,detection:{test:async()=>!0,add:async a=>[...a],remove:async a=>a.filter(s=>a.includes(s))},loader:{extension:{type:[pa.LoadParser],priority:go.High},test(a){return a.startsWith("blob:")},async load(a){return zt.from(a)}}};bo.add(Xc);class pt extends Ts{constructor(e){super();p(this,"name");p(this,"label");p(this,"type");p(this,"source");p(this,"assetID");p(this,"assetType");this.name=te(),this.label="",this.type="Sprite",this.source=e.source,this.assetID=0,this.assetType=""}changeSource(e){this.source=e}async load(){this.source&&(this.texture=await yo.load(this.source))}clone(e=!1){const n=new pt({source:this.source});return n.assetID=this.assetID,n.assetType=this.assetType,Nt(this,n,e,_e(this)),n}toJSON(){return{...Ct(this,_e(this)),source:this.source,assetID:this.assetID,assetType:this.assetType}}static async fromJSON(e){const n=new pt({source:e.source});return n.assetID=e.assetID,n.assetType=e.assetType,await Zt(e,n),n}}const Ze=class Ze extends Ts{constructor(e){super(zt.EMPTY);p(this,"name");p(this,"label");p(this,"type");p(this,"source");p(this,"assetID");p(this,"assetType");p(this,"animationSpeed",1);p(this,"loop",!0);p(this,"onComplete");p(this,"onFrameChange");p(this,"onLoop");p(this,"duration",0);p(this,"autoPlay",!0);p(this,"_frames");p(this,"_context");p(this,"dirty",!1);p(this,"_currentFrame",0);p(this,"_autoUpdate",!1);p(this,"_isConnectedToTicker",!1);p(this,"_playing",!1);p(this,"_currentTime",0);this.name=te(),this.label="",this.type="AnimatedGIF",this.source=e.source,this.assetID=0,this.assetType="",this._frames=[],this._context=null}static fromBuffer(e,n){if(!e||e.byteLength===0)throw new Error("Invalid buffer");const i=S=>{var W;let k=null;for(const X of S.frames)k=(W=X.gce)!=null?W:k,"image"in X&&!("gce"in X)&&(X.gce=k)},o=So(e);i(o);const r=jo(o,!0),l=[],c=document.createElement("canvas"),u=c.getContext("2d",{willReadFrequently:!0}),h=document.createElement("canvas"),m=h.getContext("2d");c.width=o.lsd.width,c.height=o.lsd.height;let f=0,x=null;const{fps:b}=Object.assign({},Ze.defaultOptions,n),T=1e3/b;for(let S=0;S<r.length;S++){const{disposalType:k=2,delay:W=T,patch:X,dims:{width:A,height:B,left:$,top:w}}=r[S];h.width=A,h.height=B,m.clearRect(0,0,A,B);const L=m.createImageData(A,B);L.data.set(X),m.putImageData(L,0,0),k===3&&(x=u.getImageData(0,0,c.width,c.height)),u.drawImage(h,$,w);const re=u.getImageData(0,0,c.width,c.height);k===2?u.clearRect(0,0,c.width,c.height):k===3&&u.putImageData(x,0,0),l.push({start:f,end:f+W,imageData:re}),f+=W}c.width=c.height=0,h.width=h.height=0;const{width:G,height:v}=o.lsd;return{frames:l,width:G,height:v}}async load(){const e=await fetch(this.source).then(m=>m.arrayBuffer()),{frames:n,width:i,height:o}=Ze.fromBuffer(e),r=document.createElement("canvas"),l=r.getContext("2d");r.width=i,r.height=o;const{source:c,scaleMode:u,...h}=Ze.defaultOptions;this.texture=zt.from(r,{scaleMode:u}),this.duration=n[n.length-1].end,this._frames=n,this._context=l,this._playing=!1,this._currentTime=0,this._isConnectedToTicker=!1,Object.assign(this,h),this.dirty=!0,this.currentFrame=0}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(be.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(be.shared.add(this.update,this,Ta.HIGH),this._isConnectedToTicker=!0),!this.loop&&this.currentFrame===this._frames.length-1&&(this._currentTime=0))}get progress(){return this._currentTime/this.duration}get playing(){return this._playing}update(e){var r,l;if(!this._playing)return;const n=be.shared.time*1e3,i=n%this.duration,o=this._frames.findIndex(c=>c.start<=i&&c.end>i);n>=this.duration?this.loop?(this._currentTime=i,this.updateFrameIndex(o),(r=this.onLoop)==null||r.call(this)):(this._currentTime=this.duration,this.updateFrameIndex(this._frames.length-1),(l=this.onComplete)==null||l.call(this),this.stop()):(this._currentTime=i,this.updateFrameIndex(o))}updateFrame(){if(!this.dirty)return;const{imageData:e}=this._frames[this._currentFrame];this._context.putImageData(e,0,0),this._context.fillStyle="transparent",this._context.fillRect(0,0,0,1),this.texture.update(),this.dirty=!1}_render(e){this.updateFrame(),super._render(e)}_renderCanvas(e){this.updateFrame(),super._renderCanvas(e)}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(be.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(be.shared.add(this.update,this),this._isConnectedToTicker=!0))}get currentFrame(){return this._currentFrame}set currentFrame(e){this.updateFrameIndex(e),this._currentTime=this._frames[e].start}updateFrameIndex(e){var n;if(e<0||e>=this._frames.length)throw new Error("Frame index out of range, expecting 0 to ".concat(this.totalFrames,", got ").concat(e));this._currentFrame!==e&&(this._currentFrame=e,this.dirty=!0,(n=this.onFrameChange)==null||n.call(this,e))}get totalFrames(){return this._frames.length}destroy(){this.stop(),super.destroy(!0);const e=null;this._context=e,this._frames=e,this.onComplete=e,this.onFrameChange=e,this.onLoop=e}clone(e=!1){const n=new Ze({source:this.source});return n.assetID=this.assetID,n.assetType=this.assetType,Nt(this,n,e,_e(this)),n}toJSON(){return{...Ct(this,_e(this)),source:this.source,assetID:this.assetID,assetType:this.assetType}}static async fromJSON(e){const n=new Ze({source:e.source});return n.assetID=e.assetID,n.assetType=e.assetType,await Zt(e,n),n}};p(Ze,"defaultOptions",{source:"",scaleMode:vo.LINEAR,fps:30,loop:!0,animationSpeed:1,autoPlay:!0,autoUpdate:!0,onComplete:null,onFrameChange:null,onLoop:null});let Ut=Ze;var An=(a=>(a[a.AUDIO_STREAM_TYPE=0]="AUDIO_STREAM_TYPE",a[a.VIDEO_STREAM_TYPE=1]="VIDEO_STREAM_TYPE",a))(An||{});const{DataStream:ga}=Va;function ws(...a){Le.debug(...a)}class Ic{constructor(s){p(this,"fileUri");p(this,"streamType");p(this,"source");p(this,"readySamples");p(this,"_pending_read_resolver");p(this,"audioTrack");p(this,"videoTrack");this.fileUri=s}async initialize(s){this.source=new Fc(this.fileUri),this.readySamples=[],this._pending_read_resolver=void 0,this.streamType=s;const e=await this._tracksReady();return this.streamType==0?this._selectTrack(this.audioTrack):this._selectTrack(this.videoTrack),e}getDecoderConfig(){return this.streamType==0?{codec:this.audioTrack.codec,sampleRate:this.audioTrack.audio.sample_rate,numberOfChannels:this.audioTrack.audio.channel_count,description:this.source.getAudioSpecificConfig()}:{codec:this.videoTrack.codec.startsWith("vp08")?"vp8":this.videoTrack.codec,displayWidth:this.videoTrack.track_width,displayHeight:this.videoTrack.track_height,description:this._getDescription(this.source.getDescriptionBox())}}async getNextChunk(){let s=await this._readSample();const e=s.is_sync?"key":"delta",n=s.cts*1e6/s.timescale,i=s.duration*1e6/s.timescale,o=this.streamType==0?EncodedAudioChunk:EncodedVideoChunk;return new o({type:e,timestamp:n,duration:i,data:s.data})}_getDescription(s){const e=new ga(void 0,0,ga.BIG_ENDIAN);return s.write(e),new Uint8Array(e.buffer,8)}async _tracksReady(){let s=await this.source.getInfo();return this.videoTrack=s.videoTracks[0],this.audioTrack=s.audioTracks[0],{video:this.videoTrack,audio:this.audioTrack}}_selectTrack(s){this.source.selectTrack(s)}async _readSample(){if(this.readySamples.length)return Promise.resolve(this.readySamples.shift());let s=new Promise(e=>{this._pending_read_resolver=e});return this.source.start(this._onSamples.bind(this)),s}_onSamples(s){this.readySamples.push(...s),this.readySamples.length>=50&&this.source.stop();let n=s[0].cts*1e6/s[0].timescale;ws("adding new ".concat(s.length," samples (first = ").concat(n,"). total = ").concat(this.readySamples.length)),this._pending_read_resolver&&(this._pending_read_resolver(this.readySamples.shift()),this._pending_read_resolver=void 0)}destroy(){this.readySamples=[],this.source.close()}}class Fc{constructor(s){p(this,"file");p(this,"_onSamples");p(this,"info");p(this,"_info_resolver");this.file=Va.createFile(),this.file.onError=console.error.bind(console),this.file.onReady=this.onReady.bind(this),this.file.onSamples=this.onSamples.bind(this),ws("fetching file"),fetch(s).then(e=>{ws("fetch responded");const n=e.body.getReader();let i=0,o=this.file;function r({done:l,value:c}){if(l){o.flush();return}let u=c.buffer;return u.fileStart=i,i+=u.byteLength,o.appendBuffer(u),n.read().then(r)}return n.read().then(r)}),this.info=void 0,this._info_resolver=void 0}onReady(s){this.info=s,this._info_resolver&&(this._info_resolver(s),this._info_resolver=void 0)}getInfo(){return this.info?Promise.resolve(this.info):new Promise(s=>{this._info_resolver=s})}getDescriptionBox(){const s=this.file.moov.traks[0].mdia.minf.stbl.stsd.entries[0],e=s.avcC||s.hvcC||s.vpcC||s.av1C;if(!e)throw new Error("avcC, hvcC, vpcC, or av1C box not found!");return e}getAudioSpecificConfig(){try{return this.file.moov.traks[0].mdia.minf.stbl.stsd.entries[0].esds.esd.descs[0].descs[0].data}catch(s){return}}selectTrack(s){this.file.setExtractionOptions(s.id)}start(s){this._onSamples=s,this.file.start()}stop(){this.file.stop()}close(){this.file.flush()}onSamples(s,e,n){this._onSamples(n)}}const fs=3;function Pe(...a){Le.debug(...a)}class Kc{constructor(){p(this,"width");p(this,"height");p(this,"duration");p(this,"demuxer");p(this,"frameBuffer");p(this,"fillInProgress");p(this,"canvasCtx");p(this,"decoder");p(this,"init_resolver")}async initialize(s,e,{width:n,height:i}){this.frameBuffer=[],this.fillInProgress=!1,this.demuxer=new Ic(s);const{video:o}=await this.demuxer.initialize(An.VIDEO_STREAM_TYPE),r=this.demuxer.getDecoderConfig();this.width=n>0?n:r.displayWidth,this.height=i>0?i:r.displayHeight,this.duration=o.duration/o.timescale,this.canvasCtx=e,this.canvasCtx.canvas.width=this.width,this.canvasCtx.canvas.height=this.height,this.decoder=new VideoDecoder({output:this.bufferFrame.bind(this),error:u=>console.error(u)});let l=await VideoDecoder.isConfigSupported(r);console.assert(l.supported),this.decoder.configure(r),this.init_resolver=void 0;let c=new Promise(u=>this.init_resolver=u);return this.fillFrameBuffer(),c}render(s){Pe("render(%d)",s);let e=this.chooseFrame(s);if(this.fillFrameBuffer(),e==null){console.warn("VideoRenderer.render(): no frame ");return}return this.paint(e),e}chooseFrame(s){if(this.frameBuffer.length==0)return null;let e=Number.MAX_VALUE,n=-1;for(let o=0;o<this.frameBuffer.length;o++){let r=Math.abs(s-this.frameBuffer[o].timestamp);if(r<e)e=r,n=o;else break}console.assert(n!=-1),n>0&&Pe("dropping %d stale frames",n);for(let o=0;o<n;o++){let r=this.frameBuffer.shift();r&&r.close()}let i=this.frameBuffer[0];return Pe("frame time delta = %dms (%d vs %d)",e/1e3,s,i.timestamp),i}async fillFrameBuffer(){if(this.frameBufferFull()){Pe("frame buffer full"),this.init_resolver&&(this.init_resolver(!0),this.init_resolver=void 0);return}if(this.fillInProgress)return!1;for(this.fillInProgress=!0;this.frameBuffer.length<fs&&this.decoder.decodeQueueSize<fs;){let s=await this.demuxer.getNextChunk();this.decoder.decode(s)}this.fillInProgress=!1,setTimeout(this.fillFrameBuffer.bind(this),0)}frameBufferFull(){return this.frameBuffer.length>=fs}bufferFrame(s){Pe("bufferFrame(".concat(s.timestamp,")")),this.frameBuffer.push(s)}paint(s){Pe("paint(%d)",s.timestamp),this.canvasCtx.drawImage(s,0,0,this.width,this.height)}async destroy(){this.decoder.state!="closed"&&(this.frameBuffer.forEach(s=>s.close()),await this.decoder.flush(),this.decoder.close()),this.demuxer.destroy()}}class ft extends Ts{constructor(e){var n,i,o,r,l,c,u;super();p(this,"name");p(this,"label");p(this,"type");p(this,"source");p(this,"assetID");p(this,"assetType");p(this,"start");p(this,"duration");p(this,"offset");p(this,"loop");p(this,"volume");p(this,"bufferDuration",0);p(this,"options");p(this,"videoRenderer");p(this,"_isConnectedToTicker",!1);this.options=e,this.name=te(),this.label="",this.type="Video",this.source=e.source,this.assetID=0,this.assetType="",this.width=(n=this.options.width)!=null?n:0,this.height=(i=this.options.height)!=null?i:0,this.start=(o=e.start)!=null?o:0,this.duration=(r=e.duration)!=null?r:0,this.offset=(l=e.offset)!=null?l:0,this.loop=(c=e.loop)!=null?c:!1,this.volume=(u=e.volume)!=null?u:1}async load(){if(this.source){const e=this.source,n=document.createElement("canvas"),i=n.getContext("2d"),o=new Kc;await o.initialize(e,i,{width:this.width,height:this.height}),this.width=o.width,this.height=o.height;const r=o.duration*1e3;this.duration=this.duration||r,this.bufferDuration=r,this.videoRenderer=o,this.texture=zt.from(n),this.videoRenderer.render(0),this.texture.update()}}play(){this._isConnectedToTicker||(be.shared.add(this.update,this,Ta.HIGH),this._isConnectedToTicker=!0)}stop(){this._isConnectedToTicker&&(be.shared.remove(this.update,this),this._isConnectedToTicker=!1)}destroy(){this.stop(),super.destroy(!0),this.videoRenderer=void 0}async update(){var n;const e=be.shared.time*1e3;(n=this.videoRenderer)==null||n.render(e*1e3),this.texture.update()}clone(e=!1){const n=new ft({source:this.source});return n.assetID=this.assetID,n.assetType=this.assetType,Nt(this,n,e,_e(this)),n}toJSON(){return{...Ct(this,_e(this)),source:this.source,assetID:this.assetID,assetType:this.assetType}}static async fromJSON(e){const n=new ft({source:e.source});return n.assetID=e.assetID,n.assetType=e.assetType,await Zt(e,n),n}}const zc={Text:de,Graphics:$e,Sprite:pt,AnimatedGIF:Ut,Video:ft};function Dc(a){return Bs(zc,a)}class xt{constructor(s){p(this,"name");p(this,"label");p(this,"type");p(this,"source");p(this,"assetID");p(this,"assetType");p(this,"buffer");this.name=te(),this.label="",this.type="Sound",this.source=s.source,this.assetID=0,this.assetType=""}changeSource(s){this.source=s}async load(){this.buffer=await Tc(this.source)}clone(s=!1){const e=new xt({source:this.source});return xs(this,e,s),e}toJSON(){const s={};return xs(this,s,!0),{__type:this.type,...s,source:this.source,assetID:this.assetID,assetType:this.assetType}}static async fromJSON(s){const e=new xt({source:s.source});return xs(s,e,!0),e}destroy(){this.buffer=void 0}}function xs(a,s,e=!1){e&&(s.name=a.name),s.label=a.label,s.assetID=a.assetID,s.assetType=a.assetType}function Yc(a){return Bs({Sound:xt},a)}class ye extends wo{constructor(e){super();p(this,"name");p(this,"label");p(this,"config");p(this,"dialogues");p(this,"sounds");this.name=te(),this.label=(e==null?void 0:e.label)||"",this.config={speak:{targetName:"",wordsPerMin:500,interval:.2,effect:"typewriter",speaker:{targetName:"",name:"",autoShowSpeaker:{inEffect:"Show"},autoMaskOtherSpeakers:{alpha:.5}}},autoShowBackground:!0},this.dialogues=[],this.sounds=[],this.sortableChildren=!0}getSoundByName(e){return this.sounds.find(n=>n.name===e)}addSound(e){this.sounds.push(e)}removeSound(e){this.sounds=this.sounds.filter(n=>n.name===e.name?(e.destroy(),!1):!0)}addFilter(e){this.filters?this.filters.push(e):this.filters=[e]}removeFilter(e){this.filters&&(this.filters=this.filters.filter(n=>n!==e))}addDialogue(e,n){typeof n<"u"?this.dialogues.splice(n,0,e):this.dialogues.push(e)}updateDialogue(e,n){this.dialogues[e]=n}removeDialogue(e){this.dialogues=this.dialogues.filter(n=>n!==e)}swapDialogue(e,n){[this.dialogues[e],this.dialogues[n]]=[this.dialogues[n],this.dialogues[e]]}getChildByLabel(e){return this.children.find(n=>n.label===e)}getChildrenByAssetType(e){return this.children.filter(n=>n.assetType===e)}clone(){var i;const e=new ye;e.label=this.label,e.config=Dt(this.config),e.dialogues=Dt(this.dialogues);const n=this.children.map(o=>o.clone(!0));return n.length>0&&e.addChild(...n),e.sounds=this.sounds.map(o=>o.clone(!0)),e.filters=((i=this.filters)==null?void 0:i.map(o=>o.clone(!0)))||null,e}toJSON(){return{__type:"Scene",name:this.name,label:this.label,config:this.config,dialogues:this.dialogues,children:this.children,sounds:this.sounds,filters:this.filters}}static async fromJSON(e,n=!0){const i=new ye;n&&(i.name=e.name),i.label=e.label,i.config=e.config,i.dialogues=e.dialogues;const o=await Dc(e.children);return o.length>0&&i.addChild(...o),i.sounds=await Yc(e.sounds),i.filters=await Pn(e.filters),i}async load(){const e=async n=>{if(typeof n.load=="function"&&await n.load(),n.children&&n.children.length>0)for(const i of n.children)await e(i)};for(const n of this.children)await e(n);for(const n of this.sounds)await n.load()}}const Hc={version:"3.12.2",name:"text",init(a,s,e){var i,o,r;typeof s!="object"&&(s={value:s});let n=s.value;this.startText=((r=(o=(i=e.vars)==null?void 0:i.startAt)==null?void 0:o.text)==null?void 0:r.value)||"",this.target=a,this.startText&&(n=n.replace(this.startText,"")),n=n.split(""),this.from=e._from,this.text=n,this._props.push("text")},render(a,s){a>1?a=1:a<0&&(a=0),s.from&&(a=1-a);const{text:e,target:n,startText:i}=s,o=e.length,r=a*o+.5|0;n.text=i+e.slice(0,r).join("")}};class tt{constructor(s,e){p(this,"options");p(this,"stage");p(this,"executeTime");p(this,"currentTime");var n;this.options=s,this.stage=e,this.executeTime=(n=s.executeTime)!=null?n:0,this.currentTime=0}}class E extends tt{constructor(e,n){super(e,n);p(this,"target");this.options=e,this.target=this.stage.getChildByName(e.targetName,!0)}execute(){if(!this.target)return;const{fromVars:e,toVars:n}=this.options;this.target.visible=!0,typeof this.target.play=="function"&&this.target.play(),e&&n?_.fromTo(this.target,e,n):n&&_.to(this.target,n)}getDuration(){var e,n;return this.options.sequential&&(n=(e=this.options.toVars)==null?void 0:e.duration)!=null?n:0}}class kt extends tt{constructor(e,n){super(e,n);p(this,"target");this.stage=n,this.target=this.stage.getSoundByName(e.targetName)}getDuration(){return 0}}class Bn extends tt{constructor(s,e){super(s,e),this.options=s}execute(){const{fromVars:s,toVars:e}=this.options;s&&e?_.fromTo(this.stage,s,e):e&&_.to(this.stage,e)}getDuration(){var s,e;return this.options.sequential&&(e=(s=this.options.toVars)==null?void 0:s.duration)!=null?e:0}}class Es extends tt{constructor(e,n){super(e,n);p(this,"target");this.options=e,this.stage=n,e.targetName&&(this.target=this.stage.getChildByName(e.targetName))}getDuration(){return 0}}class En extends E{constructor(s,e){super(s,e),this.options=U({toVars:{pixi:{visible:!0},ease:"none",duration:0}},s)}}class On extends E{constructor(s,e){var n;super(s,e),this.options=U({fromVars:{pixi:{alpha:0}},toVars:{pixi:{alpha:(n=this.target.alpha)!=null?n:1},ease:"power1.in",duration:.5}},s)}}const gs="AutoMaskFilter",Mc={Show:En,FadeIn:On};class Jn extends E{constructor(e,n){super(e,n);p(this,"speakerTarget");this.options=U({autoShowSpeaker:{inEffect:"Show"},autoMaskOtherSpeakers:{alpha:.5}},e);const{speakerTargetName:i}=this.options;i&&(this.speakerTarget=this.stage.getChildByName(i))}execute(){const{name:e,autoShowSpeaker:n,autoMaskOtherSpeakers:i,executeTime:o}=this.options;if(this.target&&(this.target.visible=!0,this.target.text=e),n&&this.speakerTarget&&!this.speakerTarget.visible){const{inEffect:r="Show"}=n,l=Mc[r];new l({...n,executeTime:o,targetName:this.speakerTarget.name},this.stage).execute()}if(i){const{alpha:r=.5}=i;this.speakerTarget&&this.checkMaskFilter(this.speakerTarget)&&this.removeMaskFilter(this.speakerTarget),this.stage.children.forEach(l=>{l!==this.speakerTarget&&l.assetType==="Character"&&(this.checkMaskFilter(l)||this.addMaskFilter(l,r))})}}checkMaskFilter(e){var n;return(n=e.filters)==null?void 0:n.some(i=>i.name===gs)}removeMaskFilter(e){var n;e.filters=((n=e.filters)==null?void 0:n.filter(i=>i.name!==gs))||[]}addMaskFilter(e,n){const i=new mt;i.name=gs,i.alpha=n,e.filters?e.filters.push(i):e.filters=[i]}}class Pc{constructor(){p(this,"sliceTaskList",[]);p(this,"soundRecordMap",new Map)}play(s,e){const n=this.soundRecordMap.get(s.name);if(n)U(n,{...e,paused:!1});else{const{start:i,volume:o,loop:r,untilEnd:l}=e;this.soundRecordMap.set(s.name,{sound:s,paused:!1,elapsedTime:0,start:i!=null?i:0,volume:o!=null?o:1,loop:r!=null?r:!1,untilEnd:l!=null?l:!1})}}pause(s){const e=this.soundRecordMap.get(s.name);e&&(e.paused=!0)}stop(s){this.soundRecordMap.delete(s.name)}update(s,e){for(const n of this.soundRecordMap.values()){const{sound:i,paused:o,elapsedTime:r,start:l,loop:c,volume:u}=n;if(!o&&i.buffer){let h=r;const m=i.buffer.duration;if(h>m-l)if(c)h=h%(m-l);else continue;const f=1/e,x=kc(i.buffer,h+l,f,u);n.elapsedTime=r+f,this.sliceTaskList.push(x)}}}async getAudioBuffers(){const s=await Promise.all(this.sliceTaskList);return this.sliceTaskList=[],s}resetExceptUtilEnd(){for(const[s,e]of this.soundRecordMap)e.untilEnd||this.soundRecordMap.delete(s)}reset(){this.sliceTaskList=[],this.soundRecordMap.clear()}}const ke=new Pc;class Uc extends kt{constructor(s,e){super(s,e),this.options=s}execute(){ke.play(this.target,this.options)}getDuration(){var s,e;return this.options.sequential&&(e=(s=this.target.buffer)==null?void 0:s.duration)!=null?e:0}}class Ac extends kt{execute(){ke.pause(this.target)}}class Bc extends kt{execute(){ke.stop(this.target)}}class Qn extends kt{constructor(s,e){super(s,e),this.options=s}execute(){ke.play(this.target,this.options)}getDuration(){var s,e;return this.options.sequential&&(e=(s=this.target.buffer)==null?void 0:s.duration)!=null?e:0}}function _n(a,s){return s.some(([e,n])=>e<=a&&a<=n)}function bs(a){const s=a.charCodeAt(0);return _n(s,[[12352,12447],[19968,40959],[44032,55203],[131072,191456]])}function Ec(a){return" \n\r	".includes(a)}function Oc(a){const s=a.charCodeAt(0);return _n(s,[[33,47],[58,64],[91,96],[123,126],[12288,12351],[65280,65519]])}function Jc(a,s){let e=0,n=0,i=a.length-1;const{wordBound:o=Ec}=s;for(;o(a[n]);)n++;for(;o(a[i]);)i--;const r="".concat(a,"\n");for(let l=n;l<=i;l++)if((bs(r[l])||!o(r[l])&&(o(r[l+1])||bs(r[l+1])))&&e++,bs(r[l]))for(;l<=i&&(Oc(r[l+1])||o(r[l+1]));)l++;return{total:e}}function Qc(a,s={}){const{wordsPerMin:e=500}=s,n=a.total/e;return{seconds:parseFloat((n*60).toFixed(1))}}function _c(a,s={}){const e=Jc(a,s);return{...Qc(e,s),words:e}}class $c extends E{constructor(e,n){super(e,n);p(this,"speakerDirective");p(this,"voiceDirective");this.options=U({interval:.2,sequential:!0,effect:"typewriter",alignWithVoice:!0},e);const{speaker:i,voice:o,executeTime:r}=this.options;i!=null&&i.targetName&&(this.speakerDirective=new Jn({...i,executeTime:r},n)),o!=null&&o.targetName&&(this.voiceDirective=new Qn({...o,executeTime:r,sequential:!0},this.stage))}execute(){var l,c;if(!this.target)return;const{text:e,append:n,effect:i}=this.options;let o="",r=e;switch(this.target.visible=!0,n&&(o=this.target.text,r=this.target.text+e),i){case"typewriter":this.typewriter(o,r);break;case"fadeIn":this.fadeIn(o,r);break;case"none":this.none(o,r);break}(l=this.speakerDirective)==null||l.execute(),(c=this.voiceDirective)==null||c.execute()}typewriter(e,n){const{text:i,wordsPerMin:o}=this.options;_.fromTo(this.target,{text:{value:e}},{text:{value:n},duration:this.readingTime(i,o),ease:"none"})}fadeIn(e,n){_.fromTo(this.target,{pixi:{alpha:0},text:{value:e}},{pixi:{alpha:1},text:{value:n},duration:.5,ease:"none"})}none(e,n){this.target.text=n}getDuration(){const{sequential:e,text:n,wordsPerMin:i,interval:o,voiceDuration:r}=this.options;let l=this.readingTime(n,i);r&&(l=Math.max(l,r));const c=l+(o!=null?o:0);return e?c:0}readingTime(e,n=500){return e?_c(e,{wordsPerMin:n}).seconds:0}}class qc extends E{constructor(s,e){super(s,e),this.options=U({toVars:{pixi:{visible:!1},ease:"none",duration:0}},s)}}class ed extends E{constructor(s,e){super(s,e),this.options=U({toVars:{pixi:{alpha:0},ease:"power1.in",duration:.5}},s)}}class td extends E{constructor(s,e){super(s,e),this.options={...s,immediate:!0}}async execute(){const{source:s,immediate:e}=this.options;this.target.changeSource(s),e?await this.target.load():_.to(this.target,{pixi:{alpha:0},duration:.3,onComplete:()=>{this.target.load().then(()=>{_.to(this.target,{pixi:{alpha:1},duration:.3})})}})}}class sd extends E{constructor(s,e){super(s,e);const n=this.target,i=n.width?n.width*.05:0,o=n.x,r=o-i,l=o+i;this.options=U({toVars:{keyframes:{"0%":{x:o},"15%":{x:r},"30%":{x:l},"45%":{x:r},"60%":{x:l},"75%":{x:r},"90%":{x:l},"100%":{x:o}},duration:.5,ease:"none"}},s)}}class ad extends E{constructor(s,e){super(s,e);const n=this.target,i=n.height?n.height*.05:0,o=n.y,r=o-i,l=o+i;this.options=U({toVars:{keyframes:{"0%":{y:o},"15%":{y:r},"30%":{y:l},"45%":{y:r},"60%":{y:l},"75%":{y:r},"90%":{y:l},"100%":{y:o}},duration:.5,ease:"none"}},s)}}class nd extends E{constructor(s,e){super(s,e);const n=this.target,i=n.x,o=n.y;n.anchor.set(.5),n.x=i+n.width*n.anchor.x,n.y=o+n.height*n.anchor.y,this.options=U({toVars:{pixi:{scale:1.1},ease:"power1.in",duration:.5}},s)}}class id extends E{constructor(s,e){super(s,e);const n=this.target,i=n.x,o=n.y;n.anchor.set(.5),n.x=i+n.width*n.anchor.x,n.y=o+n.height*n.anchor.y,this.options=U({toVars:{pixi:{scale:.9},ease:"power1.out",duration:.5}},s)}}class od extends E{constructor(s,e){var i,o;super(s,e);const n=this.target;this.options=U({fromVars:{pixi:{x:n.x-n.width,alpha:0}},toVars:{pixi:{x:(i=n.x)!=null?i:0,alpha:(o=n.alpha)!=null?o:1},ease:"power1.in",duration:.5}},s)}}class rd extends E{constructor(s,e){super(s,e);const n=this.target;this.options=U({toVars:{pixi:{x:n.x-n.width,alpha:0},ease:"power1.in",duration:.5}},s)}}class ld extends E{constructor(s,e){var i,o;super(s,e);const n=this.target;this.options=U({fromVars:{pixi:{x:n.x+n.width,alpha:0}},toVars:{pixi:{x:(i=n.x)!=null?i:0,alpha:(o=n.alpha)!=null?o:1},ease:"power1.in",duration:.5}},s)}}class cd extends E{constructor(s,e){super(s,e);const n=this.target;this.options=U({toVars:{pixi:{x:n.x+n.width,alpha:0},ease:"power1.in",duration:.5}},s)}}class dd extends tt{constructor(s,e){super(s,e),this.options=U({sequential:!0},s)}execute(){}getDuration(){return this.options.duration}}class hd extends Bn{constructor(s,e){super(s,e),this.options=U({fromVars:{pixi:{alpha:0}},toVars:{pixi:{alpha:1},ease:"power1.in",duration:.3}},s)}}class ud extends Es{constructor(s,e){super(s,e),this.options=s}execute(){const{targetName:s,filterName:e}=this.options;s?this.target&&this.addFilter(this.target,e):this.addFilter(this.stage,e)}addFilter(s,e){const n=new Mn[e];s.filters?s.filters.push(n):s.filters=[n]}}class md extends Es{execute(){const{targetName:s}=this.options;s?this.target&&(this.target.filters=[]):this.stage.filters=[]}}const pd=Object.freeze(Object.defineProperty({__proto__:null,AddFilter:ud,AnimationDirective:E,ChangeSource:td,Directive:tt,EnterFromLeft:od,EnterFromRight:ld,FadeIn:On,FadeInTransition:hd,FadeOut:ed,FilterDirective:Es,Hide:qc,LeaveFromLeft:rd,LeaveFromRight:cd,Pause:Ac,Play:Uc,RemoveFilter:md,ShakeX:sd,ShakeY:ad,Show:En,SoundDirective:kt,Speak:$c,Speaker:Jn,Stop:Bc,TransitionDirective:Bn,Voice:Qn,Wait:dd,ZoomIn:nd,ZoomOut:id},Symbol.toStringTag,{value:"Module"}));_.registerPlugin(Ra);_.registerPlugin(Hc);Ra.registerPIXI(No);_.ticker.remove(_.updateRoot);var j=(a=>(a.ChangeSource="ChangeSource",a.Speak="Speak",a.Speaker="Speaker",a.Show="Show",a.Hide="Hide",a.FadeIn="FadeIn",a.FadeOut="FadeOut",a.ShakeX="ShakeX",a.ShakeY="ShakeY",a.ZoomIn="ZoomIn",a.ZoomOut="ZoomOut",a.EnterFromLeft="EnterFromLeft",a.LeaveFromLeft="LeaveFromLeft",a.EnterFromRight="EnterFromRight",a.LeaveFromRight="LeaveFromRight",a.Wait="Wait",a.Play="Play",a.Pause="Pause",a.Stop="Stop",a.FadeInTransition="FadeInTransition",a.AddFilter="AddFilter",a.RemoveFilter="RemoveFilter",a))(j||{});const Jt=class Jt{constructor(s){p(this,"ticker");p(this,"renderer");p(this,"rendererOptions");p(this,"started");p(this,"connecter");p(this,"cutResolver");var o;this.ticker=be.shared,this.ticker.ctx={},this.ticker.asyncHandlers=[],this.ticker.autoStart=!1,this.ticker.stop(),this.rendererOptions=Object.assign({},Jt.defaultRendererOptions,s),this.started=!1;const{width:e,height:n,background:i}=this.rendererOptions;this.renderer=(o=this.rendererOptions.renderer)!=null?o:Co({view:new OffscreenCanvas(e,n),width:e,height:n,background:i})}connect(s){this.connecter=s,this.connecter.connect()}disconnect(){var s;(s=this.connecter)==null||s.disconnect(),this.connecter=void 0}hasStarted(){return this.started}async action(s){if(this.started)return;const e=performance.now();_.updateRoot(0);try{const n=this.parseScreenplay(s);return this.registerUpdater(),await this.run(n)}finally{this.reset(),Le.info("action cost:",performance.now()-e),this.cutResolver&&this.cutResolver(!0)}}cut(){return new Promise(s=>{this.started=!1,this.cutResolver=s})}reset(){this.started=!1,ke.reset();let s=this.ticker._head.next;for(;s;)s=s.destroy(!0);this.ticker.time=0,this.ticker.lastTime=-1,this.ticker.ctx={},this.ticker.asyncHandlers=[]}parseScreenplay(s){let e=0;const{scenes:n}=s;for(const i of n)e=this.parseSceneScript(i,e);return e}parseSceneScript(s,e){const{scene:n}=s,{directives:i}=s;let o=e;n.children.forEach(r=>{r.visible=!1}),this.ticker.add(()=>{const r=this.ticker.time;r>=e&&r<=o&&this.ticker.ctx.scene!==n&&(this.ticker.ctx.scene&&ke.resetExceptUtilEnd(),this.ticker.ctx.scene=n)});for(const r of i){const{directive:l,params:c}=r,u=pd[l];if(!u){Le.error("Directive ".concat(l," not found"));continue}const h=o,m=new u({...c,executeTime:h},n);this.ticker.add(()=>{const f=this.ticker.time;m.currentTime=f,Wc(f,m.executeTime,1/(this.rendererOptions.fps*2))&&(Le.debug("execute directive:",m.constructor.name,f,m.executeTime),this.ticker.asyncHandlers.push(m.execute()))}),o+=m.getDuration()}return o}registerUpdater(){this.ticker.add(()=>{const s=this.ticker.time;ke.update(s,this.rendererOptions.fps);const e=async()=>{this.ticker.ctx.audioBuffers=await ke.getAudioBuffers()};this.ticker.asyncHandlers.push(e()),_.updateRoot(s),this.ticker.ctx.scene&&(this.renderer.render(this.ticker.ctx.scene),this.ticker.ctx.imageSource=this.renderer.view)})}async run(s){var o,r;const{fps:e}=this.rendererOptions,n=Math.ceil(s*e);this.started=!0;for(let l=0;l<=n;l++){const c=l/e*1e3;if(this.started)this.ticker.time=c/1e3,this.ticker.update(c),await Promise.all(this.ticker.asyncHandlers),(o=this.connecter)!=null&&o.connection&&await this.connecter.handle({timestamp:c,imageSource:this.ticker.ctx.imageSource,audioBuffers:this.ticker.ctx.audioBuffers}),this.rendererOptions.onProgress&&this.rendererOptions.onProgress(l/n*100,c/1e3,s);else break}let i;return this.started&&((r=this.connecter)!=null&&r.connection)&&(i=await this.connecter.finish()),this.started=!1,i}};p(Jt,"defaultRendererOptions",{fps:30,width:1920,height:1080,background:0});let Ns=Jt;class $n{constructor(s){p(this,"connection");p(this,"options");this.connection=!1,this.options=s}connect(){this.connection=!0}disconnect(){this.connection=!1}}const qn="dmFyIGhpPU9iamVjdC5kZWZpbmVQcm9wZXJ0eTt2YXIgdWk9KE4sRCx4KT0+RCBpbiBOP2hpKE4sRCx7ZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITAsdmFsdWU6eH0pOk5bRF09eDt2YXIgRj0oTixELHgpPT4odWkoTix0eXBlb2YgRCE9InN5bWJvbCI/RCsiIjpELHgpLHgpOyhmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgTj1PYmplY3QuZGVmaW5lUHJvcGVydHksRD1PYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzLHg9T2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSxqZT1PYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLEI9TWF0aC5wb3csemU9KGUsdCxpKT0+dCBpbiBlP04oZSx0LHtlbnVtZXJhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMCx3cml0YWJsZTohMCx2YWx1ZTppfSk6ZVt0XT1pLGV0PShlLHQpPT57Zm9yKHZhciBpIGluIHR8fCh0PXt9KSl4LmNhbGwodCxpKSYmemUoZSxpLHRbaV0pO2lmKEQpZm9yKHZhciBpIG9mIEQodCkpamUuY2FsbCh0LGkpJiZ6ZShlLGksdFtpXSk7cmV0dXJuIGV9LHZlPShlLHQsaSk9PntpZighdC5oYXMoZSkpdGhyb3cgVHlwZUVycm9yKCJDYW5ub3QgIitpKX0sbj0oZSx0LGkpPT4odmUoZSx0LCJyZWFkIGZyb20gcHJpdmF0ZSBmaWVsZCIpLGk/aS5jYWxsKGUpOnQuZ2V0KGUpKSxvPShlLHQsaSk9PntpZih0LmhhcyhlKSl0aHJvdyBUeXBlRXJyb3IoIkNhbm5vdCBhZGQgdGhlIHNhbWUgcHJpdmF0ZSBtZW1iZXIgbW9yZSB0aGFuIG9uY2UiKTt0IGluc3RhbmNlb2YgV2Vha1NldD90LmFkZChlKTp0LnNldChlLGkpfSxFPShlLHQsaSxzKT0+KHZlKGUsdCwid3JpdGUgdG8gcHJpdmF0ZSBmaWVsZCIpLHM/cy5jYWxsKGUsaSk6dC5zZXQoZSxpKSxpKSx3PShlLHQsaSk9Pih2ZShlLHQsImFjY2VzcyBwcml2YXRlIG1ldGhvZCIpLGkpLGw9bmV3IFVpbnQ4QXJyYXkoOCksaz1uZXcgRGF0YVZpZXcobC5idWZmZXIpLEE9ZT0+WyhlJTI1NisyNTYpJTI1Nl0sdT1lPT4oay5zZXRVaW50MTYoMCxlLCExKSxbbFswXSxsWzFdXSksdHQ9ZT0+KGsuc2V0SW50MTYoMCxlLCExKSxbbFswXSxsWzFdXSksQmU9ZT0+KGsuc2V0VWludDMyKDAsZSwhMSksW2xbMV0sbFsyXSxsWzNdXSksYT1lPT4oay5zZXRVaW50MzIoMCxlLCExKSxbbFswXSxsWzFdLGxbMl0sbFszXV0pLGl0PWU9PihrLnNldFVpbnQzMigwLE1hdGguZmxvb3IoZS9CKDIsMzIpKSwhMSksay5zZXRVaW50MzIoNCxlLCExKSxbbFswXSxsWzFdLGxbMl0sbFszXSxsWzRdLGxbNV0sbFs2XSxsWzddXSksd2U9ZT0+KGsuc2V0SW50MTYoMCxCKDIsOCkqZSwhMSksW2xbMF0sbFsxXV0pLFA9ZT0+KGsuc2V0SW50MzIoMCxCKDIsMTYpKmUsITEpLFtsWzBdLGxbMV0sbFsyXSxsWzNdXSksZ2U9ZT0+KGsuc2V0SW50MzIoMCxCKDIsMzApKmUsITEpLFtsWzBdLGxbMV0sbFsyXSxsWzNdXSksVz0oZSx0PSExKT0+e2xldCBpPUFycmF5KGUubGVuZ3RoKS5maWxsKG51bGwpLm1hcCgocyxyKT0+ZS5jaGFyQ29kZUF0KHIpKTtyZXR1cm4gdCYmaS5wdXNoKDApLGl9LEg9ZT0+ZSYmZVtlLmxlbmd0aC0xXSxKPShlLHQsaT0hMCk9PntsZXQgcz1lKnQ7cmV0dXJuIGk/TWF0aC5yb3VuZChzKTpzfSxrZT1lPT57bGV0IHQ9ZSooTWF0aC5QSS8xODApLGk9TWF0aC5jb3ModCkscz1NYXRoLnNpbih0KTtyZXR1cm5baSxzLDAsLXMsaSwwLDAsMCwxXX0sbnQ9a2UoMCksRmU9ZT0+W1AoZVswXSksUChlWzFdKSxnZShlWzJdKSxQKGVbM10pLFAoZVs0XSksZ2UoZVs1XSksUChlWzZdKSxQKGVbN10pLGdlKGVbOF0pXSxDPShlLHQsaSk9Pih7dHlwZTplLGNvbnRlbnRzOnQmJm5ldyBVaW50OEFycmF5KHQuZmxhdCgxMCkpLGNoaWxkcmVuOml9KSxfPShlLHQsaSxzLHIpPT5DKGUsW0EodCksQmUoaSkscyE9bnVsbD9zOltdXSxyKSxzdD1lPT5lP0MoImZ0eXAiLFtXKCJpc29tIiksYSgwKSxXKCJpc280IiksVygiaHZjMSIpXSk6QygiZnR5cCIsW1coImlzb20iKSxhKDApLFcoImlzb20iKSxXKCJhdmMxIiksVygibXA0MSIpXSkscnQ9KCk9Pih7dHlwZToibWRhdCIsbGFyZ2VTaXplOiEwfSksYXQ9KGUsdCk9PkMoIm1vb3YiLG51bGwsW290KHQsZSksLi4uZS5tYXAoaT0+bHQoaSx0KSldKSxvdD0oZSx0KT0+e2xldCBpPUooTWF0aC5tYXgoMCwuLi50LmZpbHRlcihyPT5yLnNhbXBsZXMubGVuZ3RoPjApLm1hcChyPT5IKHIuc2FtcGxlcykudGltZXN0YW1wK0goci5zYW1wbGVzKS5kdXJhdGlvbikpLFNlKSxzPU1hdGgubWF4KC4uLnQubWFwKHI9PnIuaWQpKSsxO3JldHVybiBfKCJtdmhkIiwwLDAsW2EoZSksYShlKSxhKFNlKSxhKGkpLFAoMSksd2UoMSksQXJyYXkoMTApLmZpbGwoMCksRmUobnQpLEFycmF5KDI0KS5maWxsKDApLGEocyldKX0sbHQ9KGUsdCk9PkMoInRyYWsiLG51bGwsW2h0KGUsdCksdXQoZSx0KV0pLGh0PShlLHQpPT57bGV0IGk9SChlLnNhbXBsZXMpLHM9SihpP2kudGltZXN0YW1wK2kuZHVyYXRpb246MCxTZSk7cmV0dXJuIF8oInRraGQiLDAsMyxbYSh0KSxhKHQpLGEoZS5pZCksYSgwKSxhKHMpLEFycmF5KDgpLmZpbGwoMCksdSgwKSx1KDApLHdlKGUuaW5mby50eXBlPT09ImF1ZGlvIj8xOjApLHUoMCksRmUoa2UoZS5pbmZvLnR5cGU9PT0idmlkZW8iP2UuaW5mby5yb3RhdGlvbjowKSksUChlLmluZm8udHlwZT09PSJ2aWRlbyI/ZS5pbmZvLndpZHRoOjApLFAoZS5pbmZvLnR5cGU9PT0idmlkZW8iP2UuaW5mby5oZWlnaHQ6MCldKX0sdXQ9KGUsdCk9PkMoIm1kaWEiLG51bGwsW2R0KGUsdCksZnQoZS5pbmZvLnR5cGU9PT0idmlkZW8iPyJ2aWRlIjoic291biIpLGN0KGUpXSksZHQ9KGUsdCk9PntsZXQgaT1IKGUuc2FtcGxlcykscz1KKGk/aS50aW1lc3RhbXAraS5kdXJhdGlvbjowLGUudGltZXNjYWxlKTtyZXR1cm4gXygibWRoZCIsMCwwLFthKHQpLGEodCksYShlLnRpbWVzY2FsZSksYShzKSx1KDIxOTU2KSx1KDApXSl9LGZ0PWU9Pl8oImhkbHIiLDAsMCxbVygibWhsciIpLFcoZSksYSgwKSxhKDApLGEoMCksVygibXA0LW11eGVyLWhkbHIiKV0pLGN0PWU9PkMoIm1pbmYiLG51bGwsW2UuaW5mby50eXBlPT09InZpZGVvIj9wdCgpOnZ0KCksd3QoKSx5dChlKV0pLHB0PSgpPT5fKCJ2bWhkIiwwLDEsW3UoMCksdSgwKSx1KDApLHUoMCldKSx2dD0oKT0+Xygic21oZCIsMCwwLFt1KDApLHUoMCldKSx3dD0oKT0+QygiZGluZiIsbnVsbCxbZ3QoKV0pLGd0PSgpPT5fKCJkcmVmIiwwLDAsW2EoMSldLFttdCgpXSksbXQ9KCk9Pl8oInVybCAiLDAsMSkseXQ9ZT0+Qygic3RibCIsbnVsbCxbQ3QoZSksT3QoZSksTHQoZSksVXQoZSksRHQoZSksUHQoZSldKSxDdD1lPT5fKCJzdHNkIiwwLDAsW2EoMSldLFtlLmluZm8udHlwZT09PSJ2aWRlbyI/X3QoV3RbZS5pbmZvLmNvZGVjXSxlKTpJdChCdFtlLmluZm8uY29kZWNdLGUpXSksX3Q9KGUsdCk9PkMoZSxbQXJyYXkoNikuZmlsbCgwKSx1KDEpLHUoMCksdSgwKSxBcnJheSgxMikuZmlsbCgwKSx1KHQuaW5mby53aWR0aCksdSh0LmluZm8uaGVpZ2h0KSxhKDQ3MTg1OTIpLGEoNDcxODU5MiksYSgwKSx1KDEpLEFycmF5KDMyKS5maWxsKDApLHUoMjQpLHR0KDY1NTM1KV0sW3p0W3QuaW5mby5jb2RlY10odCldKSxUdD1lPT5lLmNvZGVjUHJpdmF0ZSYmQygiYXZjQyIsWy4uLmUuY29kZWNQcml2YXRlXSksU3Q9ZT0+ZS5jb2RlY1ByaXZhdGUmJkMoImh2Y0MiLFsuLi5lLmNvZGVjUHJpdmF0ZV0pLEV0PWU9PmUuY29kZWNQcml2YXRlJiZDKCJ2cGNDIixbLi4uZS5jb2RlY1ByaXZhdGVdKSxidD1lPT5lLmNvZGVjUHJpdmF0ZSYmQygiYXYxQyIsWy4uLmUuY29kZWNQcml2YXRlXSksSXQ9KGUsdCk9PkMoZSxbQXJyYXkoNikuZmlsbCgwKSx1KDEpLHUoMCksdSgwKSxhKDApLHUodC5pbmZvLm51bWJlck9mQ2hhbm5lbHMpLHUoMTYpLHUoMCksdSgwKSxQKHQuaW5mby5zYW1wbGVSYXRlKV0sW2t0W3QuaW5mby5jb2RlY10odCldKSxBdD1lPT5fKCJlc2RzIiwwLDAsW2EoNTg3NTMxNTIpLEEoMzIrZS5jb2RlY1ByaXZhdGUuYnl0ZUxlbmd0aCksdSgxKSxBKDApLGEoNzU1MzAzNjgpLEEoMTgrZS5jb2RlY1ByaXZhdGUuYnl0ZUxlbmd0aCksQSg2NCksQSgyMSksQmUoMCksYSgxMzAwNzEpLGEoMTMwMDcxKSxhKDkyMzA3NTg0KSxBKGUuY29kZWNQcml2YXRlLmJ5dGVMZW5ndGgpLC4uLmUuY29kZWNQcml2YXRlLGEoMTA5MDg0ODAwKSxBKDEpLEEoMildKSxNdD1lPT5DKCJkT3BzIixbQSgwKSxBKGUuaW5mby5udW1iZXJPZkNoYW5uZWxzKSx1KDM4NDApLGEoZS5pbmZvLnNhbXBsZVJhdGUpLHdlKDApLEEoMCldKSxPdD1lPT5fKCJzdHRzIiwwLDAsW2EoZS50aW1lVG9TYW1wbGVUYWJsZS5sZW5ndGgpLGUudGltZVRvU2FtcGxlVGFibGUubWFwKHQ9PlthKHQuc2FtcGxlQ291bnQpLGEodC5zYW1wbGVEZWx0YSldKV0pLEx0PWU9PntpZihlLnNhbXBsZXMuZXZlcnkoaT0+aS50eXBlPT09ImtleSIpKXJldHVybiBudWxsO2xldCB0PVsuLi5lLnNhbXBsZXMuZW50cmllcygpXS5maWx0ZXIoKFssaV0pPT5pLnR5cGU9PT0ia2V5Iik7cmV0dXJuIF8oInN0c3MiLDAsMCxbYSh0Lmxlbmd0aCksdC5tYXAoKFtpXSk9PmEoaSsxKSldKX0sVXQ9ZT0+Xygic3RzYyIsMCwwLFthKGUuY29tcGFjdGx5Q29kZWRDaHVua1RhYmxlLmxlbmd0aCksZS5jb21wYWN0bHlDb2RlZENodW5rVGFibGUubWFwKHQ9PlthKHQuZmlyc3RDaHVuayksYSh0LnNhbXBsZXNQZXJDaHVuayksYSgxKV0pXSksRHQ9ZT0+Xygic3RzeiIsMCwwLFthKDApLGEoZS5zYW1wbGVzLmxlbmd0aCksZS5zYW1wbGVzLm1hcCh0PT5hKHQuc2l6ZSkpXSksUHQ9ZT0+ZS53cml0dGVuQ2h1bmtzLmxlbmd0aD4wJiZIKGUud3JpdHRlbkNodW5rcykub2Zmc2V0Pj1CKDIsMzIpP18oImNvNjQiLDAsMCxbYShlLndyaXR0ZW5DaHVua3MubGVuZ3RoKSxlLndyaXR0ZW5DaHVua3MubWFwKHQ9Pml0KHQub2Zmc2V0KSldKTpfKCJzdGNvIiwwLDAsW2EoZS53cml0dGVuQ2h1bmtzLmxlbmd0aCksZS53cml0dGVuQ2h1bmtzLm1hcCh0PT5hKHQub2Zmc2V0KSldKSxXdD17YXZjOiJhdmMxIixoZXZjOiJodmMxIix2cDk6InZwMDkiLGF2MToiYXYwMSJ9LHp0PXthdmM6VHQsaGV2YzpTdCx2cDk6RXQsYXYxOmJ0fSxCdD17YWFjOiJtcDRhIixvcHVzOiJvcHVzIn0sa3Q9e2FhYzpBdCxvcHVzOk10fSxSZT1jbGFzc3tjb25zdHJ1Y3Rvcigpe3RoaXMuYnVmZmVyPW51bGx9fSxOZT1jbGFzc3tjb25zdHJ1Y3RvcihlLHQsaSl7dGhpcy5vbkRhdGE9ZSx0aGlzLm9uRG9uZT10LHRoaXMub3B0aW9ucz1pfX0sRnQ9Y2xhc3N7Y29uc3RydWN0b3IoZSx0KXt0aGlzLnN0cmVhbT1lLHRoaXMub3B0aW9ucz10fX0sVixZLG1lPWNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5wb3M9MCxvKHRoaXMsVixuZXcgVWludDhBcnJheSg4KSksbyh0aGlzLFksbmV3IERhdGFWaWV3KG4odGhpcyxWKS5idWZmZXIpKSx0aGlzLm9mZnNldHM9bmV3IFdlYWtNYXB9c2VlayhlKXt0aGlzLnBvcz1lfXdyaXRlVTMyKGUpe24odGhpcyxZKS5zZXRVaW50MzIoMCxlLCExKSx0aGlzLndyaXRlKG4odGhpcyxWKS5zdWJhcnJheSgwLDQpKX13cml0ZVU2NChlKXtuKHRoaXMsWSkuc2V0VWludDMyKDAsTWF0aC5mbG9vcihlL0IoMiwzMikpLCExKSxuKHRoaXMsWSkuc2V0VWludDMyKDQsZSwhMSksdGhpcy53cml0ZShuKHRoaXMsVikuc3ViYXJyYXkoMCw4KSl9d3JpdGVBc2NpaShlKXtmb3IobGV0IHQ9MDt0PGUubGVuZ3RoO3QrKyluKHRoaXMsWSkuc2V0VWludDgodCU4LGUuY2hhckNvZGVBdCh0KSksdCU4PT09NyYmdGhpcy53cml0ZShuKHRoaXMsVikpO2UubGVuZ3RoJTghPT0wJiZ0aGlzLndyaXRlKG4odGhpcyxWKS5zdWJhcnJheSgwLGUubGVuZ3RoJTgpKX13cml0ZUJveChlKXt2YXIgdCxpO2lmKHRoaXMub2Zmc2V0cy5zZXQoZSx0aGlzLnBvcyksZS5jb250ZW50cyYmIWUuY2hpbGRyZW4pdGhpcy53cml0ZUJveEhlYWRlcihlLCh0PWUuc2l6ZSkhPW51bGw/dDplLmNvbnRlbnRzLmJ5dGVMZW5ndGgrOCksdGhpcy53cml0ZShlLmNvbnRlbnRzKTtlbHNle2xldCBzPXRoaXMucG9zO2lmKHRoaXMud3JpdGVCb3hIZWFkZXIoZSwwKSxlLmNvbnRlbnRzJiZ0aGlzLndyaXRlKGUuY29udGVudHMpLGUuY2hpbGRyZW4pZm9yKGxldCBmIG9mIGUuY2hpbGRyZW4pZiYmdGhpcy53cml0ZUJveChmKTtsZXQgcj10aGlzLnBvcyxkPShpPWUuc2l6ZSkhPW51bGw/aTpyLXM7dGhpcy5zZWVrKHMpLHRoaXMud3JpdGVCb3hIZWFkZXIoZSxkKSx0aGlzLnNlZWsocil9fXdyaXRlQm94SGVhZGVyKGUsdCl7dGhpcy53cml0ZVUzMihlLmxhcmdlU2l6ZT8xOnQpLHRoaXMud3JpdGVBc2NpaShlLnR5cGUpLGUubGFyZ2VTaXplJiZ0aGlzLndyaXRlVTY0KHQpfXBhdGNoQm94KGUpe2xldCB0PXRoaXMucG9zO3RoaXMuc2Vlayh0aGlzLm9mZnNldHMuZ2V0KGUpKSx0aGlzLndyaXRlQm94KGUpLHRoaXMuc2Vlayh0KX19O1Y9bmV3IFdlYWtNYXAsWT1uZXcgV2Vha01hcDt2YXIgc2UsJCxaLHJlLHllLFJ0PWNsYXNzIGV4dGVuZHMgbWV7Y29uc3RydWN0b3IoZSl7c3VwZXIoKSxvKHRoaXMscmUpLG8odGhpcyxzZSx2b2lkIDApLG8odGhpcywkLG5ldyBBcnJheUJ1ZmZlcihCKDIsMTYpKSksbyh0aGlzLFosbmV3IFVpbnQ4QXJyYXkobih0aGlzLCQpKSksRSh0aGlzLHNlLGUpfXdyaXRlKGUpe3codGhpcyxyZSx5ZSkuY2FsbCh0aGlzLHRoaXMucG9zK2UuYnl0ZUxlbmd0aCksbih0aGlzLFopLnNldChlLHRoaXMucG9zKSx0aGlzLnBvcys9ZS5ieXRlTGVuZ3RofWZpbmFsaXplKCl7dyh0aGlzLHJlLHllKS5jYWxsKHRoaXMsdGhpcy5wb3MpLG4odGhpcyxzZSkuYnVmZmVyPW4odGhpcywkKS5zbGljZSgwLHRoaXMucG9zKX19O3NlPW5ldyBXZWFrTWFwLCQ9bmV3IFdlYWtNYXAsWj1uZXcgV2Vha01hcCxyZT1uZXcgV2Vha1NldCx5ZT1mdW5jdGlvbihlKXtsZXQgdD1uKHRoaXMsJCkuYnl0ZUxlbmd0aDtmb3IoO3Q8ZTspdCo9MjtpZih0PT09bih0aGlzLCQpLmJ5dGVMZW5ndGgpcmV0dXJuO2xldCBpPW5ldyBBcnJheUJ1ZmZlcih0KSxzPW5ldyBVaW50OEFycmF5KGkpO3Muc2V0KG4odGhpcyxaKSwwKSxFKHRoaXMsJCxpKSxFKHRoaXMsWixzKX07dmFyIGosRyx4ZT1jbGFzcyBleHRlbmRzIG1le2NvbnN0cnVjdG9yKGUpe3N1cGVyKCksbyh0aGlzLGosdm9pZCAwKSxvKHRoaXMsRyxbXSksRSh0aGlzLGosZSl9d3JpdGUoZSl7bih0aGlzLEcpLnB1c2goe2RhdGE6ZS5zbGljZSgpLHN0YXJ0OnRoaXMucG9zfSksdGhpcy5wb3MrPWUuYnl0ZUxlbmd0aH1mbHVzaCgpe2lmKG4odGhpcyxHKS5sZW5ndGg9PT0wKXJldHVybjtsZXQgZT1bXSx0PVsuLi5uKHRoaXMsRyldLnNvcnQoKGkscyk9Pmkuc3RhcnQtcy5zdGFydCk7ZS5wdXNoKHtzdGFydDp0WzBdLnN0YXJ0LHNpemU6dFswXS5kYXRhLmJ5dGVMZW5ndGh9KTtmb3IobGV0IGk9MTtpPHQubGVuZ3RoO2krKyl7bGV0IHM9ZVtlLmxlbmd0aC0xXSxyPXRbaV07ci5zdGFydDw9cy5zdGFydCtzLnNpemU/cy5zaXplPU1hdGgubWF4KHMuc2l6ZSxyLnN0YXJ0K3IuZGF0YS5ieXRlTGVuZ3RoLXMuc3RhcnQpOmUucHVzaCh7c3RhcnQ6ci5zdGFydCxzaXplOnIuZGF0YS5ieXRlTGVuZ3RofSl9Zm9yKGxldCBpIG9mIGUpe2kuZGF0YT1uZXcgVWludDhBcnJheShpLnNpemUpO2ZvcihsZXQgcyBvZiBuKHRoaXMsRykpaS5zdGFydDw9cy5zdGFydCYmcy5zdGFydDxpLnN0YXJ0K2kuc2l6ZSYmaS5kYXRhLnNldChzLmRhdGEscy5zdGFydC1pLnN0YXJ0KTtuKHRoaXMsaikub25EYXRhKGkuZGF0YSxpLnN0YXJ0KX1uKHRoaXMsRykubGVuZ3RoPTB9ZmluYWxpemUoKXt2YXIgZSx0Oyh0PShlPW4odGhpcyxqKSkub25Eb25lKT09bnVsbHx8dC5jYWxsKGUpfX07aj1uZXcgV2Vha01hcCxHPW5ldyBXZWFrTWFwO3ZhciBOdD1CKDIsMjQpLHh0PTIsZWUsTCxJLGFlLENlLF9lLEhlLFRlLFZlLHRlLG9lLCRlPWNsYXNzIGV4dGVuZHMgbWV7Y29uc3RydWN0b3IoZSl7dmFyIHQsaTtpZihzdXBlcigpLG8odGhpcyxhZSksbyh0aGlzLF9lKSxvKHRoaXMsVGUpLG8odGhpcyx0ZSksbyh0aGlzLGVlLHZvaWQgMCksbyh0aGlzLEwsdm9pZCAwKSxvKHRoaXMsSSxbXSksRSh0aGlzLGVlLGUpLEUodGhpcyxMLChpPSh0PWUub3B0aW9ucyk9PW51bGw/dm9pZCAwOnQuY2h1bmtTaXplKSE9bnVsbD9pOk50KSwhTnVtYmVyLmlzSW50ZWdlcihuKHRoaXMsTCkpfHxuKHRoaXMsTCk8QigyLDEwKSl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgU3RyZWFtVGFyZ2V0IG9wdGlvbnM6IGNodW5rU2l6ZSBtdXN0IGJlIGFuIGludGVnZXIgbm90IHNtYWxsZXIgdGhhbiAxMDI0LiIpfXdyaXRlKGUpe3codGhpcyxhZSxDZSkuY2FsbCh0aGlzLGUsdGhpcy5wb3MpLHcodGhpcyx0ZSxvZSkuY2FsbCh0aGlzKSx0aGlzLnBvcys9ZS5ieXRlTGVuZ3RofWZpbmFsaXplKCl7dmFyIGUsdDt3KHRoaXMsdGUsb2UpLmNhbGwodGhpcywhMCksKHQ9KGU9bih0aGlzLGVlKSkub25Eb25lKT09bnVsbHx8dC5jYWxsKGUpfX07ZWU9bmV3IFdlYWtNYXAsTD1uZXcgV2Vha01hcCxJPW5ldyBXZWFrTWFwLGFlPW5ldyBXZWFrU2V0LENlPWZ1bmN0aW9uKGUsdCl7bGV0IGk9bih0aGlzLEkpLmZpbmRJbmRleChwPT5wLnN0YXJ0PD10JiZ0PHAuc3RhcnQrbih0aGlzLEwpKTtpPT09LTEmJihpPXcodGhpcyxUZSxWZSkuY2FsbCh0aGlzLHQpKTtsZXQgcz1uKHRoaXMsSSlbaV0scj10LXMuc3RhcnQsZD1lLnN1YmFycmF5KDAsTWF0aC5taW4obih0aGlzLEwpLXIsZS5ieXRlTGVuZ3RoKSk7cy5kYXRhLnNldChkLHIpO2xldCBmPXtzdGFydDpyLGVuZDpyK2QuYnl0ZUxlbmd0aH07aWYodyh0aGlzLF9lLEhlKS5jYWxsKHRoaXMscyxmKSxzLndyaXR0ZW5bMF0uc3RhcnQ9PT0wJiZzLndyaXR0ZW5bMF0uZW5kPT09bih0aGlzLEwpJiYocy5zaG91bGRGbHVzaD0hMCksbih0aGlzLEkpLmxlbmd0aD54dCl7Zm9yKGxldCBwPTA7cDxuKHRoaXMsSSkubGVuZ3RoLTE7cCsrKW4odGhpcyxJKVtwXS5zaG91bGRGbHVzaD0hMDt3KHRoaXMsdGUsb2UpLmNhbGwodGhpcyl9ZC5ieXRlTGVuZ3RoPGUuYnl0ZUxlbmd0aCYmdyh0aGlzLGFlLENlKS5jYWxsKHRoaXMsZS5zdWJhcnJheShkLmJ5dGVMZW5ndGgpLHQrZC5ieXRlTGVuZ3RoKX0sX2U9bmV3IFdlYWtTZXQsSGU9ZnVuY3Rpb24oZSx0KXtsZXQgaT0wLHM9ZS53cml0dGVuLmxlbmd0aC0xLHI9LTE7Zm9yKDtpPD1zOyl7bGV0IGQ9TWF0aC5mbG9vcihpKyhzLWkrMSkvMik7ZS53cml0dGVuW2RdLnN0YXJ0PD10LnN0YXJ0PyhpPWQrMSxyPWQpOnM9ZC0xfWZvcihlLndyaXR0ZW4uc3BsaWNlKHIrMSwwLHQpLChyPT09LTF8fGUud3JpdHRlbltyXS5lbmQ8dC5zdGFydCkmJnIrKztyPGUud3JpdHRlbi5sZW5ndGgtMSYmZS53cml0dGVuW3JdLmVuZD49ZS53cml0dGVuW3IrMV0uc3RhcnQ7KWUud3JpdHRlbltyXS5lbmQ9TWF0aC5tYXgoZS53cml0dGVuW3JdLmVuZCxlLndyaXR0ZW5bcisxXS5lbmQpLGUud3JpdHRlbi5zcGxpY2UocisxLDEpfSxUZT1uZXcgV2Vha1NldCxWZT1mdW5jdGlvbihlKXtsZXQgaT17c3RhcnQ6TWF0aC5mbG9vcihlL24odGhpcyxMKSkqbih0aGlzLEwpLGRhdGE6bmV3IFVpbnQ4QXJyYXkobih0aGlzLEwpKSx3cml0dGVuOltdLHNob3VsZEZsdXNoOiExfTtyZXR1cm4gbih0aGlzLEkpLnB1c2goaSksbih0aGlzLEkpLnNvcnQoKHMscik9PnMuc3RhcnQtci5zdGFydCksbih0aGlzLEkpLmluZGV4T2YoaSl9LHRlPW5ldyBXZWFrU2V0LG9lPWZ1bmN0aW9uKGU9ITEpe2ZvcihsZXQgdD0wO3Q8bih0aGlzLEkpLmxlbmd0aDt0Kyspe2xldCBpPW4odGhpcyxJKVt0XTtpZighKCFpLnNob3VsZEZsdXNoJiYhZSkpe2ZvcihsZXQgcyBvZiBpLndyaXR0ZW4pbih0aGlzLGVlKS5vbkRhdGEoaS5kYXRhLnN1YmFycmF5KHMuc3RhcnQscy5lbmQpLGkuc3RhcnQrcy5zdGFydCk7bih0aGlzLEkpLnNwbGljZSh0LS0sMSl9fX07dmFyIEh0PWNsYXNzIGV4dGVuZHMgJGV7Y29uc3RydWN0b3IoZSl7dmFyIHQ7c3VwZXIobmV3IE5lKChpLHMpPT5lLnN0cmVhbS53cml0ZSh7dHlwZToid3JpdGUiLGRhdGE6aSxwb3NpdGlvbjpzfSksdm9pZCAwLHtjaHVua1NpemU6KHQ9ZS5vcHRpb25zKT09bnVsbD92b2lkIDA6dC5jaHVua1NpemV9KSl9fSxTZT0xZTMsVnQ9WyJhdmMiLCJoZXZjIiwidnA5IiwiYXYxIl0sJHQ9WyJhYWMiLCJvcHVzIl0sR3Q9MjA4Mjg0NDgwMCxYdD0uNSxxdD1bInN0cmljdCIsIm9mZnNldCJdLGcsVCxYLHEsSyxFZSxsZSxiZSxHZSxJZSxYZSxBZSxxZSxNZSxLZSxoZSxPZSxMZSxRZSxpZSx1ZSxuZSxkZSxmZSxVZSxLdD1jbGFzc3tjb25zdHJ1Y3RvcihlKXtvKHRoaXMsYmUpLG8odGhpcyxJZSksbyh0aGlzLEFlKSxvKHRoaXMsTWUpLG8odGhpcyxoZSksbyh0aGlzLExlKSxvKHRoaXMsaWUpLG8odGhpcyxuZSksbyh0aGlzLGZlKSxvKHRoaXMsZyx2b2lkIDApLG8odGhpcyxULHZvaWQgMCksbyh0aGlzLFgsdm9pZCAwKSxvKHRoaXMscSxudWxsKSxvKHRoaXMsSyxudWxsKSxvKHRoaXMsRWUsTWF0aC5mbG9vcihEYXRlLm5vdygpLzFlMykrR3QpLG8odGhpcyxsZSwhMSk7dmFyIHQ7aWYodyh0aGlzLGJlLEdlKS5jYWxsKHRoaXMsZSksdGhpcy50YXJnZXQ9ZS50YXJnZXQsRSh0aGlzLGcsZXQoe2ZpcnN0VGltZXN0YW1wQmVoYXZpb3I6InN0cmljdCJ9LGUpKSxlLnRhcmdldCBpbnN0YW5jZW9mIFJlKUUodGhpcyxULG5ldyBSdChlLnRhcmdldCkpO2Vsc2UgaWYoZS50YXJnZXQgaW5zdGFuY2VvZiBOZSlFKHRoaXMsVCwodD1lLnRhcmdldC5vcHRpb25zKSE9bnVsbCYmdC5jaHVua2VkP25ldyAkZShlLnRhcmdldCk6bmV3IHhlKGUudGFyZ2V0KSk7ZWxzZSBpZihlLnRhcmdldCBpbnN0YW5jZW9mIEZ0KUUodGhpcyxULG5ldyBIdChlLnRhcmdldCkpO2Vsc2UgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHRhcmdldDogIi5jb25jYXQoZS50YXJnZXQpKTt3KHRoaXMsSWUsWGUpLmNhbGwodGhpcyksdyh0aGlzLEFlLHFlKS5jYWxsKHRoaXMpfWFkZFZpZGVvQ2h1bmsoZSx0LGkpe2xldCBzPW5ldyBVaW50OEFycmF5KGUuYnl0ZUxlbmd0aCk7ZS5jb3B5VG8ocyksdGhpcy5hZGRWaWRlb0NodW5rUmF3KHMsZS50eXBlLGkhPW51bGw/aTplLnRpbWVzdGFtcCxlLmR1cmF0aW9uLHQpfWFkZFZpZGVvQ2h1bmtSYXcoZSx0LGkscyxyKXtpZih3KHRoaXMsZmUsVWUpLmNhbGwodGhpcyksIW4odGhpcyxnKS52aWRlbyl0aHJvdyBuZXcgRXJyb3IoIk5vIHZpZGVvIHRyYWNrIGRlY2xhcmVkLiIpO3codGhpcyxoZSxPZSkuY2FsbCh0aGlzLG4odGhpcyxxKSxlLHQsaSxzLHIpfWFkZEF1ZGlvQ2h1bmsoZSx0LGkpe2xldCBzPW5ldyBVaW50OEFycmF5KGUuYnl0ZUxlbmd0aCk7ZS5jb3B5VG8ocyksdGhpcy5hZGRBdWRpb0NodW5rUmF3KHMsZS50eXBlLGkhPW51bGw/aTplLnRpbWVzdGFtcCxlLmR1cmF0aW9uLHQpfWFkZEF1ZGlvQ2h1bmtSYXcoZSx0LGkscyxyKXtpZih3KHRoaXMsZmUsVWUpLmNhbGwodGhpcyksIW4odGhpcyxnKS5hdWRpbyl0aHJvdyBuZXcgRXJyb3IoIk5vIGF1ZGlvIHRyYWNrIGRlY2xhcmVkLiIpO3codGhpcyxoZSxPZSkuY2FsbCh0aGlzLG4odGhpcyxLKSxlLHQsaSxzLHIpfWZpbmFsaXplKCl7bih0aGlzLHEpJiZ3KHRoaXMsaWUsdWUpLmNhbGwodGhpcyxuKHRoaXMscSkpLG4odGhpcyxLKSYmdyh0aGlzLGllLHVlKS5jYWxsKHRoaXMsbih0aGlzLEspKTtsZXQgZT1uKHRoaXMsVCkub2Zmc2V0cy5nZXQobih0aGlzLFgpKSx0PW4odGhpcyxUKS5wb3MtZTtuKHRoaXMsWCkuc2l6ZT10LG4odGhpcyxUKS5wYXRjaEJveChuKHRoaXMsWCkpO2xldCBpPWF0KFtuKHRoaXMscSksbih0aGlzLEspXS5maWx0ZXIoQm9vbGVhbiksbih0aGlzLEVlKSk7bih0aGlzLFQpLndyaXRlQm94KGkpLHcodGhpcyxuZSxkZSkuY2FsbCh0aGlzKSxuKHRoaXMsVCkuZmluYWxpemUoKSxFKHRoaXMsbGUsITApfX07Zz1uZXcgV2Vha01hcCxUPW5ldyBXZWFrTWFwLFg9bmV3IFdlYWtNYXAscT1uZXcgV2Vha01hcCxLPW5ldyBXZWFrTWFwLEVlPW5ldyBXZWFrTWFwLGxlPW5ldyBXZWFrTWFwLGJlPW5ldyBXZWFrU2V0LEdlPWZ1bmN0aW9uKGUpe2lmKGUudmlkZW8pe2lmKCFWdC5pbmNsdWRlcyhlLnZpZGVvLmNvZGVjKSl0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIHZpZGVvIGNvZGVjOiAiLmNvbmNhdChlLnZpZGVvLmNvZGVjKSk7aWYoZS52aWRlby5yb3RhdGlvbiE9PXZvaWQgMCYmIVswLDkwLDE4MCwyNzBdLmluY2x1ZGVzKGUudmlkZW8ucm90YXRpb24pKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCB2aWRlbyByb3RhdGlvbjogIi5jb25jYXQoZS52aWRlby5yb3RhdGlvbiwiLiBIYXMgdG8gYmUgMCwgOTAsIDE4MCBvciAyNzAuIikpfWlmKGUuYXVkaW8mJiEkdC5pbmNsdWRlcyhlLmF1ZGlvLmNvZGVjKSl0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIGF1ZGlvIGNvZGVjOiAiLmNvbmNhdChlLmF1ZGlvLmNvZGVjKSk7aWYoZS5maXJzdFRpbWVzdGFtcEJlaGF2aW9yJiYhcXQuaW5jbHVkZXMoZS5maXJzdFRpbWVzdGFtcEJlaGF2aW9yKSl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZmlyc3QgdGltZXN0YW1wIGJlaGF2aW9yOiAiLmNvbmNhdChlLmZpcnN0VGltZXN0YW1wQmVoYXZpb3IpKX0sSWU9bmV3IFdlYWtTZXQsWGU9ZnVuY3Rpb24oKXt2YXIgZTtsZXQgdD0oKGU9bih0aGlzLGcpLnZpZGVvKT09bnVsbD92b2lkIDA6ZS5jb2RlYyk9PT0iaGV2YyI7bih0aGlzLFQpLndyaXRlQm94KHN0KHQpKSxFKHRoaXMsWCxydCgpKSxuKHRoaXMsVCkud3JpdGVCb3gobih0aGlzLFgpKSx3KHRoaXMsbmUsZGUpLmNhbGwodGhpcyl9LEFlPW5ldyBXZWFrU2V0LHFlPWZ1bmN0aW9uKCl7dmFyIGU7aWYobih0aGlzLGcpLnZpZGVvJiZFKHRoaXMscSx7aWQ6MSxpbmZvOnt0eXBlOiJ2aWRlbyIsY29kZWM6bih0aGlzLGcpLnZpZGVvLmNvZGVjLHdpZHRoOm4odGhpcyxnKS52aWRlby53aWR0aCxoZWlnaHQ6bih0aGlzLGcpLnZpZGVvLmhlaWdodCxyb3RhdGlvbjooZT1uKHRoaXMsZykudmlkZW8ucm90YXRpb24pIT1udWxsP2U6MH0sdGltZXNjYWxlOjcyMCxjb2RlY1ByaXZhdGU6bmV3IFVpbnQ4QXJyYXkoMCksc2FtcGxlczpbXSx3cml0dGVuQ2h1bmtzOltdLGN1cnJlbnRDaHVuazpudWxsLGZpcnN0VGltZXN0YW1wOnZvaWQgMCxsYXN0VGltZXN0YW1wOi0xLHRpbWVUb1NhbXBsZVRhYmxlOltdLGxhc3RUaW1lc2NhbGVVbml0czpudWxsLGNvbXBhY3RseUNvZGVkQ2h1bmtUYWJsZTpbXX0pLG4odGhpcyxnKS5hdWRpbyl7bGV0IHQ9dyh0aGlzLE1lLEtlKS5jYWxsKHRoaXMsMixuKHRoaXMsZykuYXVkaW8uc2FtcGxlUmF0ZSxuKHRoaXMsZykuYXVkaW8ubnVtYmVyT2ZDaGFubmVscyk7RSh0aGlzLEsse2lkOm4odGhpcyxnKS52aWRlbz8yOjEsaW5mbzp7dHlwZToiYXVkaW8iLGNvZGVjOm4odGhpcyxnKS5hdWRpby5jb2RlYyxudW1iZXJPZkNoYW5uZWxzOm4odGhpcyxnKS5hdWRpby5udW1iZXJPZkNoYW5uZWxzLHNhbXBsZVJhdGU6bih0aGlzLGcpLmF1ZGlvLnNhbXBsZVJhdGV9LHRpbWVzY2FsZTpuKHRoaXMsZykuYXVkaW8uc2FtcGxlUmF0ZSxjb2RlY1ByaXZhdGU6dCxzYW1wbGVzOltdLHdyaXR0ZW5DaHVua3M6W10sY3VycmVudENodW5rOm51bGwsZmlyc3RUaW1lc3RhbXA6dm9pZCAwLGxhc3RUaW1lc3RhbXA6LTEsdGltZVRvU2FtcGxlVGFibGU6W10sbGFzdFRpbWVzY2FsZVVuaXRzOm51bGwsY29tcGFjdGx5Q29kZWRDaHVua1RhYmxlOltdfSl9fSxNZT1uZXcgV2Vha1NldCxLZT1mdW5jdGlvbihlLHQsaSl7bGV0IHI9Wzk2ZTMsODgyMDAsNjRlMyw0OGUzLDQ0MTAwLDMyZTMsMjRlMywyMjA1MCwxNmUzLDEyZTMsMTEwMjUsOGUzLDczNTBdLmluZGV4T2YodCksZD1pLGY9IiI7Zis9ZS50b1N0cmluZygyKS5wYWRTdGFydCg1LCIwIiksZis9ci50b1N0cmluZygyKS5wYWRTdGFydCg0LCIwIikscj09PTE1JiYoZis9dC50b1N0cmluZygyKS5wYWRTdGFydCgyNCwiMCIpKSxmKz1kLnRvU3RyaW5nKDIpLnBhZFN0YXJ0KDQsIjAiKTtsZXQgcD1NYXRoLmNlaWwoZi5sZW5ndGgvOCkqODtmPWYucGFkRW5kKHAsIjAiKTtsZXQgYj1uZXcgVWludDhBcnJheShmLmxlbmd0aC84KTtmb3IobGV0IFM9MDtTPGYubGVuZ3RoO1MrPTgpYltTLzhdPXBhcnNlSW50KGYuc2xpY2UoUyxTKzgpLDIpO3JldHVybiBifSxoZT1uZXcgV2Vha1NldCxPZT1mdW5jdGlvbihlLHQsaSxzLHIsZCl7dmFyIGY7bGV0IHA9cy8xZTYsYj1yLzFlNjtpZihlLmZpcnN0VGltZXN0YW1wPT09dm9pZCAwJiYoZS5maXJzdFRpbWVzdGFtcD1wKSxwPXcodGhpcyxMZSxRZSkuY2FsbCh0aGlzLHAsZSksZS5sYXN0VGltZXN0YW1wPXAsKCFlLmN1cnJlbnRDaHVua3x8cC1lLmN1cnJlbnRDaHVuay5zdGFydFRpbWVzdGFtcD49WHQpJiYoZS5jdXJyZW50Q2h1bmsmJncodGhpcyxpZSx1ZSkuY2FsbCh0aGlzLGUpLGUuY3VycmVudENodW5rPXtzdGFydFRpbWVzdGFtcDpwLHNhbXBsZURhdGE6W10sc2FtcGxlQ291bnQ6MH0pLGUuY3VycmVudENodW5rLnNhbXBsZURhdGEucHVzaCh0KSxlLmN1cnJlbnRDaHVuay5zYW1wbGVDb3VudCsrLChmPWQ9PW51bGw/dm9pZCAwOmQuZGVjb2RlckNvbmZpZykhPW51bGwmJmYuZGVzY3JpcHRpb24mJihlLmNvZGVjUHJpdmF0ZT1uZXcgVWludDhBcnJheShkLmRlY29kZXJDb25maWcuZGVzY3JpcHRpb24pKSxlLnNhbXBsZXMucHVzaCh7dGltZXN0YW1wOnAsZHVyYXRpb246YixzaXplOnQuYnl0ZUxlbmd0aCx0eXBlOml9KSxlLmxhc3RUaW1lc2NhbGVVbml0cyE9PW51bGwpe2xldCBTPUoocCxlLnRpbWVzY2FsZSwhMSksTT1NYXRoLnJvdW5kKFMtZS5sYXN0VGltZXNjYWxlVW5pdHMpO2UubGFzdFRpbWVzY2FsZVVuaXRzKz1NO2xldCBPPUgoZS50aW1lVG9TYW1wbGVUYWJsZSk7Ty5zYW1wbGVDb3VudD09PTE/KE8uc2FtcGxlRGVsdGE9TSxPLnNhbXBsZUNvdW50KyspOk8uc2FtcGxlRGVsdGE9PT1NP08uc2FtcGxlQ291bnQrKzooTy5zYW1wbGVDb3VudC0tLGUudGltZVRvU2FtcGxlVGFibGUucHVzaCh7c2FtcGxlQ291bnQ6MixzYW1wbGVEZWx0YTpNfSkpfWVsc2UgZS5sYXN0VGltZXNjYWxlVW5pdHM9MCxlLnRpbWVUb1NhbXBsZVRhYmxlLnB1c2goe3NhbXBsZUNvdW50OjEsc2FtcGxlRGVsdGE6SihiLGUudGltZXNjYWxlKX0pfSxMZT1uZXcgV2Vha1NldCxRZT1mdW5jdGlvbihlLHQpe2lmKG4odGhpcyxnKS5maXJzdFRpbWVzdGFtcEJlaGF2aW9yPT09InN0cmljdCImJnQubGFzdFRpbWVzdGFtcD09PS0xJiZlIT09MCl0aHJvdyBuZXcgRXJyb3IoIlRoZSBmaXJzdCBjaHVuayBmb3IgeW91ciBtZWRpYSB0cmFjayBtdXN0IGhhdmUgYSB0aW1lc3RhbXAgb2YgMCAocmVjZWl2ZWQgIi5jb25jYXQoZSwiKS4gTm9uLXplcm8gZmlyc3QgdGltZXN0YW1wcyBhcmUgb2Z0ZW4gY2F1c2VkIGJ5IGRpcmVjdGx5IHBpcGluZyBmcmFtZXMgb3IgYXVkaW8gZGF0YSBmcm9tIGEgTWVkaWFTdHJlYW1UcmFjayBpbnRvIHRoZSBlbmNvZGVyLiBUaGVpciB0aW1lc3RhbXBzIGFyZSB0eXBpY2FsbHkgcmVsYXRpdmUgdG8gdGhlIGFnZSBvZiB0aGUgZG9jdW1lbnQsIHdoaWNoIGlzIHByb2JhYmx5IHdoYXQgeW91IHdhbnQuXG5cbklmIHlvdSB3YW50IHRvIG9mZnNldCBhbGwgdGltZXN0YW1wcyBvZiBhIHRyYWNrIHN1Y2ggdGhhdCB0aGUgZmlyc3Qgb25lIGlzIHplcm8sIHNldCBmaXJzdFRpbWVzdGFtcEJlaGF2aW9yOiAnb2Zmc2V0JyBpbiB0aGUgb3B0aW9ucy5cbiIpKTtpZihuKHRoaXMsZykuZmlyc3RUaW1lc3RhbXBCZWhhdmlvcj09PSJvZmZzZXQiJiYoZS09dC5maXJzdFRpbWVzdGFtcCksZTx0Lmxhc3RUaW1lc3RhbXApdGhyb3cgbmV3IEVycm9yKCJUaW1lc3RhbXBzIG11c3QgYmUgbW9ub3RvbmljYWxseSBpbmNyZWFzaW5nICh3ZW50IGZyb20gIi5jb25jYXQodC5sYXN0VGltZXN0YW1wKjFlNiwiIHRvICIpLmNvbmNhdChlKjFlNiwiKS4iKSk7cmV0dXJuIGV9LGllPW5ldyBXZWFrU2V0LHVlPWZ1bmN0aW9uKGUpe2lmKGUuY3VycmVudENodW5rKXtlLmN1cnJlbnRDaHVuay5vZmZzZXQ9bih0aGlzLFQpLnBvcztmb3IobGV0IHQgb2YgZS5jdXJyZW50Q2h1bmsuc2FtcGxlRGF0YSluKHRoaXMsVCkud3JpdGUodCk7ZS5jdXJyZW50Q2h1bmsuc2FtcGxlRGF0YT1udWxsLChlLmNvbXBhY3RseUNvZGVkQ2h1bmtUYWJsZS5sZW5ndGg9PT0wfHxIKGUuY29tcGFjdGx5Q29kZWRDaHVua1RhYmxlKS5zYW1wbGVzUGVyQ2h1bmshPT1lLmN1cnJlbnRDaHVuay5zYW1wbGVDb3VudCkmJmUuY29tcGFjdGx5Q29kZWRDaHVua1RhYmxlLnB1c2goe2ZpcnN0Q2h1bms6ZS53cml0dGVuQ2h1bmtzLmxlbmd0aCsxLHNhbXBsZXNQZXJDaHVuazplLmN1cnJlbnRDaHVuay5zYW1wbGVDb3VudH0pLGUud3JpdHRlbkNodW5rcy5wdXNoKGUuY3VycmVudENodW5rKSx3KHRoaXMsbmUsZGUpLmNhbGwodGhpcyl9fSxuZT1uZXcgV2Vha1NldCxkZT1mdW5jdGlvbigpe24odGhpcyxUKWluc3RhbmNlb2YgeGUmJm4odGhpcyxUKS5mbHVzaCgpfSxmZT1uZXcgV2Vha1NldCxVZT1mdW5jdGlvbigpe2lmKG4odGhpcyxsZSkpdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgYWRkIG5ldyB2aWRlbyBvciBhdWRpbyBjaHVua3MgYWZ0ZXIgdGhlIGZpbGUgaGFzIGJlZW4gZmluYWxpemVkLiIpfTt2YXIgUXQ9dHlwZW9mIGdsb2JhbFRoaXM8InUiP2dsb2JhbFRoaXM6dHlwZW9mIHdpbmRvdzwidSI/d2luZG93OnR5cGVvZiBnbG9iYWw8InUiP2dsb2JhbDp0eXBlb2Ygc2VsZjwidSI/c2VsZjp7fTtmdW5jdGlvbiBZdChlKXtyZXR1cm4gZSYmZS5fX2VzTW9kdWxlJiZPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSwiZGVmYXVsdCIpP2UuZGVmYXVsdDplfXZhciBZZT17ZXhwb3J0czp7fX07KGZ1bmN0aW9uKGUpeyhmdW5jdGlvbih0LGkpe2UuZXhwb3J0cz9lLmV4cG9ydHM9aSgpOnQubG9nPWkoKX0pKFF0LGZ1bmN0aW9uKCl7dmFyIHQ9ZnVuY3Rpb24oKXt9LGk9InVuZGVmaW5lZCIscz10eXBlb2Ygd2luZG93IT09aSYmdHlwZW9mIHdpbmRvdy5uYXZpZ2F0b3IhPT1pJiYvVHJpZGVudFwvfE1TSUUgLy50ZXN0KHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KSxyPVsidHJhY2UiLCJkZWJ1ZyIsImluZm8iLCJ3YXJuIiwiZXJyb3IiXTtmdW5jdGlvbiBkKHYsbSl7dmFyIHk9dlttXTtpZih0eXBlb2YgeS5iaW5kPT0iZnVuY3Rpb24iKXJldHVybiB5LmJpbmQodik7dHJ5e3JldHVybiBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKHksdil9Y2F0Y2goYyl7cmV0dXJuIGZ1bmN0aW9uKCl7cmV0dXJuIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5hcHBseSh5LFt2LGFyZ3VtZW50c10pfX19ZnVuY3Rpb24gZigpe2NvbnNvbGUubG9nJiYoY29uc29sZS5sb2cuYXBwbHk/Y29uc29sZS5sb2cuYXBwbHkoY29uc29sZSxhcmd1bWVudHMpOkZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5hcHBseShjb25zb2xlLmxvZyxbY29uc29sZSxhcmd1bWVudHNdKSksY29uc29sZS50cmFjZSYmY29uc29sZS50cmFjZSgpfWZ1bmN0aW9uIHAodil7cmV0dXJuIHY9PT0iZGVidWciJiYodj0ibG9nIiksdHlwZW9mIGNvbnNvbGU9PT1pPyExOnY9PT0idHJhY2UiJiZzP2Y6Y29uc29sZVt2XSE9PXZvaWQgMD9kKGNvbnNvbGUsdik6Y29uc29sZS5sb2chPT12b2lkIDA/ZChjb25zb2xlLCJsb2ciKTp0fWZ1bmN0aW9uIGIodixtKXtmb3IodmFyIHk9MDt5PHIubGVuZ3RoO3krKyl7dmFyIGM9clt5XTt0aGlzW2NdPXk8dj90OnRoaXMubWV0aG9kRmFjdG9yeShjLHYsbSl9dGhpcy5sb2c9dGhpcy5kZWJ1Z31mdW5jdGlvbiBTKHYsbSx5KXtyZXR1cm4gZnVuY3Rpb24oKXt0eXBlb2YgY29uc29sZSE9PWkmJihiLmNhbGwodGhpcyxtLHkpLHRoaXNbdl0uYXBwbHkodGhpcyxhcmd1bWVudHMpKX19ZnVuY3Rpb24gTSh2LG0seSl7cmV0dXJuIHAodil8fFMuYXBwbHkodGhpcyxhcmd1bWVudHMpfWZ1bmN0aW9uIE8odixtLHkpe3ZhciBjPXRoaXMsSmU7bT1tPT1udWxsPyJXQVJOIjptO3ZhciBVPSJsb2dsZXZlbCI7dHlwZW9mIHY9PSJzdHJpbmciP1UrPSI6Iit2OnR5cGVvZiB2PT0ic3ltYm9sIiYmKFU9dm9pZCAwKTtmdW5jdGlvbiBhaShoKXt2YXIgUT0ocltoXXx8InNpbGVudCIpLnRvVXBwZXJDYXNlKCk7aWYoISh0eXBlb2Ygd2luZG93PT09aXx8IVUpKXt0cnl7d2luZG93LmxvY2FsU3RvcmFnZVtVXT1RO3JldHVybn1jYXRjaChwZSl7fXRyeXt3aW5kb3cuZG9jdW1lbnQuY29va2llPWVuY29kZVVSSUNvbXBvbmVudChVKSsiPSIrUSsiOyJ9Y2F0Y2gocGUpe319fWZ1bmN0aW9uIFplKCl7dmFyIGg7aWYoISh0eXBlb2Ygd2luZG93PT09aXx8IVUpKXt0cnl7aD13aW5kb3cubG9jYWxTdG9yYWdlW1VdfWNhdGNoKGxpKXt9aWYodHlwZW9mIGg9PT1pKXRyeXt2YXIgUT13aW5kb3cuZG9jdW1lbnQuY29va2llLHBlPVEuaW5kZXhPZihlbmNvZGVVUklDb21wb25lbnQoVSkrIj0iKTtwZSE9PS0xJiYoaD0vXihbXjtdKykvLmV4ZWMoUS5zbGljZShwZSkpWzFdKX1jYXRjaChsaSl7fXJldHVybiBjLmxldmVsc1toXT09PXZvaWQgMCYmKGg9dm9pZCAwKSxofX1mdW5jdGlvbiBvaSgpe2lmKCEodHlwZW9mIHdpbmRvdz09PWl8fCFVKSl7dHJ5e3dpbmRvdy5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShVKTtyZXR1cm59Y2F0Y2goaCl7fXRyeXt3aW5kb3cuZG9jdW1lbnQuY29va2llPWVuY29kZVVSSUNvbXBvbmVudChVKSsiPTsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIFVUQyJ9Y2F0Y2goaCl7fX19Yy5uYW1lPXYsYy5sZXZlbHM9e1RSQUNFOjAsREVCVUc6MSxJTkZPOjIsV0FSTjozLEVSUk9SOjQsU0lMRU5UOjV9LGMubWV0aG9kRmFjdG9yeT15fHxNLGMuZ2V0TGV2ZWw9ZnVuY3Rpb24oKXtyZXR1cm4gSmV9LGMuc2V0TGV2ZWw9ZnVuY3Rpb24oaCxRKXtpZih0eXBlb2YgaD09InN0cmluZyImJmMubGV2ZWxzW2gudG9VcHBlckNhc2UoKV0hPT12b2lkIDAmJihoPWMubGV2ZWxzW2gudG9VcHBlckNhc2UoKV0pLHR5cGVvZiBoPT0ibnVtYmVyIiYmaD49MCYmaDw9Yy5sZXZlbHMuU0lMRU5UKXtpZihKZT1oLFEhPT0hMSYmYWkoaCksYi5jYWxsKGMsaCx2KSx0eXBlb2YgY29uc29sZT09PWkmJmg8Yy5sZXZlbHMuU0lMRU5UKXJldHVybiJObyBjb25zb2xlIGF2YWlsYWJsZSBmb3IgbG9nZ2luZyJ9ZWxzZSB0aHJvdyJsb2cuc2V0TGV2ZWwoKSBjYWxsZWQgd2l0aCBpbnZhbGlkIGxldmVsOiAiK2h9LGMuc2V0RGVmYXVsdExldmVsPWZ1bmN0aW9uKGgpe209aCxaZSgpfHxjLnNldExldmVsKGgsITEpfSxjLnJlc2V0TGV2ZWw9ZnVuY3Rpb24oKXtjLnNldExldmVsKG0sITEpLG9pKCl9LGMuZW5hYmxlQWxsPWZ1bmN0aW9uKGgpe2Muc2V0TGV2ZWwoYy5sZXZlbHMuVFJBQ0UsaCl9LGMuZGlzYWJsZUFsbD1mdW5jdGlvbihoKXtjLnNldExldmVsKGMubGV2ZWxzLlNJTEVOVCxoKX07dmFyIFdlPVplKCk7V2U9PW51bGwmJihXZT1tKSxjLnNldExldmVsKFdlLCExKX12YXIgej1uZXcgTyxQZT17fTt6LmdldExvZ2dlcj1mdW5jdGlvbihtKXtpZih0eXBlb2YgbSE9InN5bWJvbCImJnR5cGVvZiBtIT0ic3RyaW5nInx8bT09PSIiKXRocm93IG5ldyBUeXBlRXJyb3IoIllvdSBtdXN0IHN1cHBseSBhIG5hbWUgd2hlbiBjcmVhdGluZyBhIGxvZ2dlci4iKTt2YXIgeT1QZVttXTtyZXR1cm4geXx8KHk9UGVbbV09bmV3IE8obSx6LmdldExldmVsKCksei5tZXRob2RGYWN0b3J5KSkseX07dmFyIHJpPXR5cGVvZiB3aW5kb3chPT1pP3dpbmRvdy5sb2c6dm9pZCAwO3JldHVybiB6Lm5vQ29uZmxpY3Q9ZnVuY3Rpb24oKXtyZXR1cm4gdHlwZW9mIHdpbmRvdyE9PWkmJndpbmRvdy5sb2c9PT16JiYod2luZG93LmxvZz1yaSksen0sei5nZXRMb2dnZXJzPWZ1bmN0aW9uKCl7cmV0dXJuIFBlfSx6LmRlZmF1bHQ9eix6fSl9KShZZSk7dmFyIEp0PVllLmV4cG9ydHMsY2U9WXQoSnQpO2NlLnNldExldmVsKCJFUlJPUiIpO2Z1bmN0aW9uIFp0KGUpe3JldHVybiBuZXcgUHJvbWlzZSh0PT57Y29uc3QgaT0oKT0+e2UoKT90KCk6cmVxdWVzdEFuaW1hdGlvbkZyYW1lKGkpfTtpKCl9KX1jbGFzcyBqdHtjb25zdHJ1Y3Rvcih0KXtGKHRoaXMsImNvbm5lY3Rpb24iKTtGKHRoaXMsIm9wdGlvbnMiKTt0aGlzLmNvbm5lY3Rpb249ITEsdGhpcy5vcHRpb25zPXR9Y29ubmVjdCgpe3RoaXMuY29ubmVjdGlvbj0hMH1kaXNjb25uZWN0KCl7dGhpcy5jb25uZWN0aW9uPSExfX12YXIgUj0oZT0+KGUuTE9BREVEPSJsb2FkZWQiLGUuSU5JVD0iaW5pdCIsZS5TRU5EPSJzZW5kIixlLkZJTklTSD0iZmluaXNoIixlKSkoUnx8e30pO2Z1bmN0aW9uIGVpKGUpe2NlLmVycm9yKCJub29wIGVycm9yIixlKX1jbGFzcyB0aSBleHRlbmRzIGp0e2NvbnN0cnVjdG9yKGkpe3N1cGVyKGkpO0YodGhpcywidmlkZW9Db25maWciKTtGKHRoaXMsImF1ZGlvQ29uZmlnIik7Rih0aGlzLCJtdXhlciIpO0YodGhpcywidmlkZW9FbmNvZGVyIik7Rih0aGlzLCJhdWRpb0VuY29kZXIiKTtGKHRoaXMsImVycm9yUmVqZWN0IixlaSk7dGhpcy52aWRlb0NvbmZpZz1pLnZpZGVvQ29uZmlnLHRoaXMuYXVkaW9Db25maWc9aS5hdWRpb0NvbmZpZyx0aGlzLmNyZWF0ZU11eGVyQW5kRW5jb2RlcigpfWFzeW5jIGhhbmRsZShpKXt2YXIgZixwLGIsUztjb25zdHt2aWRlb0ZyYW1lOnMsYXVkaW9JbmZvOnIsdGltZXN0YW1wOmR9PWk7aWYocyYmKChmPXRoaXMudmlkZW9FbmNvZGVyKSE9bnVsbCYmZi5lbmNvZGVRdWV1ZVNpemUmJigocD10aGlzLnZpZGVvRW5jb2Rlcik9PW51bGw/dm9pZCAwOnAuZW5jb2RlUXVldWVTaXplKT4yMCYmYXdhaXQgWnQoKCk9Pnt2YXIgTSxPO3JldHVybihNPXRoaXMudmlkZW9FbmNvZGVyKSE9bnVsbCYmTS5lbmNvZGVRdWV1ZVNpemU/KChPPXRoaXMudmlkZW9FbmNvZGVyKT09bnVsbD92b2lkIDA6Ty5lbmNvZGVRdWV1ZVNpemUpPDEwOiEwfSksKGI9dGhpcy52aWRlb0VuY29kZXIpPT1udWxsfHxiLmVuY29kZShzLHtrZXlGcmFtZTpkLygxZTMvdGhpcy5vcHRpb25zLmZwcyklMTUwPT09MH0pLHMuY2xvc2UoKSkscil7Y29uc3QgTT1uZXcgQXVkaW9EYXRhKHsuLi5yfSk7KFM9dGhpcy5hdWRpb0VuY29kZXIpPT1udWxsfHxTLmVuY29kZShNKSxNLmNsb3NlKCl9fWNyZWF0ZU11eGVyQW5kRW5jb2Rlcigpe3RoaXMubXV4ZXI9bmV3IEt0KHt0YXJnZXQ6bmV3IFJlLHZpZGVvOntjb2RlYzoiYXZjIix3aWR0aDp0aGlzLnZpZGVvQ29uZmlnLndpZHRoLGhlaWdodDp0aGlzLnZpZGVvQ29uZmlnLmhlaWdodH0sYXVkaW86e2NvZGVjOiJhYWMiLG51bWJlck9mQ2hhbm5lbHM6dGhpcy5hdWRpb0NvbmZpZy5udW1iZXJPZkNoYW5uZWxzLHNhbXBsZVJhdGU6dGhpcy5hdWRpb0NvbmZpZy5zYW1wbGVSYXRlfX0pLHRoaXMudmlkZW9FbmNvZGVyPW5ldyBWaWRlb0VuY29kZXIoe291dHB1dDooaSxzKT0+e3ZhciByO3JldHVybihyPXRoaXMubXV4ZXIpPT1udWxsP3ZvaWQgMDpyLmFkZFZpZGVvQ2h1bmsoaSxzKX0sZXJyb3I6aT0+e2NlLmVycm9yKCJ2aWRlbyBlbmNvZGVyIGVycm9yIixpKSx0aGlzLmVycm9yUmVqZWN0KGkpfX0pLHRoaXMudmlkZW9FbmNvZGVyLmNvbmZpZ3VyZSh0aGlzLnZpZGVvQ29uZmlnKSx0aGlzLm9wdGlvbnMuZGlzYWJsZUF1ZGlvfHwodGhpcy5hdWRpb0VuY29kZXI9bmV3IEF1ZGlvRW5jb2Rlcih7b3V0cHV0OihpLHMpPT57dmFyIHI7cmV0dXJuKHI9dGhpcy5tdXhlcik9PW51bGw/dm9pZCAwOnIuYWRkQXVkaW9DaHVuayhpLHMpfSxlcnJvcjppPT57Y2UuZXJyb3IoImF1ZGlvIGVuY29kZXIgZXJyb3IiLGkpLHRoaXMuZXJyb3JSZWplY3QoaSl9fSksdGhpcy5hdWRpb0VuY29kZXIuY29uZmlndXJlKHRoaXMuYXVkaW9Db25maWcpKX1hc3luYyBlbmRFbmNvZGluZygpe3ZhciBzLHIsZCxmLHAsYixTO3JldHVybiBhd2FpdCgocz10aGlzLnZpZGVvRW5jb2Rlcik9PW51bGw/dm9pZCAwOnMuZmx1c2goKSksKHI9dGhpcy52aWRlb0VuY29kZXIpPT1udWxsfHxyLmNsb3NlKCksYXdhaXQoKGQ9dGhpcy5hdWRpb0VuY29kZXIpPT1udWxsP3ZvaWQgMDpkLmZsdXNoKCkpLChmPXRoaXMuYXVkaW9FbmNvZGVyKT09bnVsbHx8Zi5jbG9zZSgpLChwPXRoaXMubXV4ZXIpPT1udWxsfHxwLmZpbmFsaXplKCksKFM9KGI9dGhpcy5tdXhlcik9PW51bGw/dm9pZCAwOmIudGFyZ2V0KT09bnVsbD92b2lkIDA6Uy5idWZmZXJ9YXN5bmMgZmluaXNoKCl7cmV0dXJuIGF3YWl0IHRoaXMuZW5kRW5jb2RpbmcoKX19bGV0IERlO3NlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsYXN5bmMgZT0+e2NvbnN0e3R5cGU6dCxkYXRhOml9PWUuZGF0YTt0cnl7c3dpdGNoKHQpe2Nhc2UgUi5JTklUOnJldHVybiBpaShpKTtjYXNlIFIuU0VORDpyZXR1cm4gYXdhaXQgbmkoaSk7Y2FzZSBSLkZJTklTSDpyZXR1cm4gYXdhaXQgc2koKTtkZWZhdWx0OnJldHVybn19Y2F0Y2gocyl7c2VsZi5wb3N0TWVzc2FnZSh7dHlwZTp0LGVyck1zZzpzIGluc3RhbmNlb2YgRXJyb3I/cy5tZXNzYWdlOiJVbmtub3duIEVycm9yIn0pfX0pLHNlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6Ui5MT0FERUR9KTtmdW5jdGlvbiBpaShlKXtEZT1uZXcgdGkoZSksc2VsZi5wb3N0TWVzc2FnZSh7dHlwZTpSLklOSVR9KX1hc3luYyBmdW5jdGlvbiBuaShlKXthd2FpdCBEZS5oYW5kbGUoZSksc2VsZi5wb3N0TWVzc2FnZSh7dHlwZTpSLlNFTkR9KX1hc3luYyBmdW5jdGlvbiBzaSgpe2NvbnN0IGU9YXdhaXQgRGUuZmluaXNoKCk7c2VsZi5wb3N0TWVzc2FnZSh7dHlwZTpSLkZJTklTSCxyZXN1bHQ6ZX0sZT9bZV06W10pfX0pKCk7Cg==",ba=typeof window<"u"&&window.Blob&&new Blob([atob(qn)],{type:"text/javascript;charset=utf-8"});function fd(){let a;try{if(a=ba&&(window.URL||window.webkitURL).createObjectURL(ba),!a)throw"";return new Worker(a)}catch(s){return new Worker("data:application/javascript;base64,"+qn)}finally{a&&(window.URL||window.webkitURL).revokeObjectURL(a)}}var ot=(a=>(a.LOADED="loaded",a.INIT="init",a.SEND="send",a.FINISH="finish",a))(ot||{});class xd extends $n{constructor(e){var n,i;super(e);p(this,"compositorWorker");p(this,"initialized");p(this,"videoConfig");p(this,"audioConfig");this.videoConfig=(n=e.videoConfig)!=null?n:Yn,this.audioConfig=(i=e.audioConfig)!=null?i:Hn,this.compositorWorker=new fd,this.initialized=new Promise((o,r)=>{this.compositorWorker.addEventListener("message",l=>{const{type:c}=l.data;c===ot.LOADED&&this.getFromWorker(ot.INIT,{videoConfig:this.videoConfig,audioConfig:this.audioConfig,...e}).then(()=>{o()}).catch(u=>{r(u)})})})}getFromWorker(e,n,i){return new Promise((o,r)=>{const l=({data:c})=>{c.type===e&&(c.errMsg?r(c.errMsg):o(c.result),this.compositorWorker.removeEventListener("message",l))};this.compositorWorker.addEventListener("message",l),this.compositorWorker.postMessage({type:e,data:n},i||[])})}async genAudioInfo(e,n){const i=this.audioConfig.sampleRate,o=this.audioConfig.numberOfChannels,r=this.audioConfig.sampleRate*(1/this.options.fps),c=new OfflineAudioContext(o,r,i).createBuffer(o,r,i);let u;if(n){n.forEach((h,m)=>{for(let f=0;f<o;f++){const x=f<h.numberOfChannels?h.getChannelData(f):new Float32Array(r).fill(0),b=c.getChannelData(f);if(m===0)b.set(x);else for(let T=0;T<b.length;T++)b[T]+=x[T]}}),u=new Float32Array(r*o);for(let h=0;h<c.numberOfChannels;h++)u.set(c.getChannelData(h),h*c.length)}else u=new Float32Array(r*o).fill(0);return{timestamp:e,sampleRate:i,numberOfChannels:o,numberOfFrames:r,data:u,format:"f32-planar"}}async handle(e){await this.initialized;const{timestamp:n,imageSource:i,audioBuffers:o}=e,r=new VideoFrame(i,{timestamp:n*1e3}),l=[r];let c;return this.options.disableAudio||(c=await this.genAudioInfo(n,o),l.push(c.data.buffer)),this.getFromWorker(ot.SEND,{timestamp:n,videoFrame:r,audioInfo:c},l)}async finish(){await this.initialized;const e=await this.getFromWorker(ot.FINISH);if(e)return new Blob([e],{type:"video/mp4"})}}class gd extends $n{constructor(e){super(e);p(this,"context");p(this,"audioContext");p(this,"audioPlayTime");p(this,"lastHandleTime");this.options=e,this.audioContext=e.disableAudio?null:new AudioContext,this.audioPlayTime=0,this.lastHandleTime=0;const{canvas:n,width:i,height:o}=this.options;n.width=i,n.height=o,this.context=n.getContext("2d")}async handle(e){const{imageSource:n,audioBuffers:i}=e,o=performance.now(),r=this.lastHandleTime>0?o-this.lastHandleTime:0;this.options.disableAudio||this.playAudioBuffers(i),this.context&&n&&this.playVideoFrame(n),await Rc(1e3/this.options.fps-r-4),this.lastHandleTime=performance.now()}playVideoFrame(e){const{width:n,height:i}=this.options;this.context.drawImage(e,0,0,n,i)}playAudioBuffers(e){if(e.length===0||!this.audioContext)return;let n=0;this.audioContext.currentTime>this.audioPlayTime&&(this.audioPlayTime=this.audioContext.currentTime);for(const i of e){const o=this.audioContext.createBufferSource();o.buffer=i,o.connect(this.audioContext.destination),o.onended=()=>{o.disconnect()},o.start(this.audioPlayTime),n=Math.max(n,i.duration)}this.audioPlayTime+=n}async finish(){var e;(e=this.audioContext)==null||e.close()}}var Q=(a=>(a[a.Background=0]="Background",a[a.Character=10]="Character",a[a.Dialog=20]="Dialog",a[a.Text=30]="Text",a))(Q||{}),Qe;let bd=(Qe=class{constructor(s){p(this,"options");p(this,"app");p(this,"scenes");p(this,"activeScene");p(this,"activeChild");p(this,"activeTransformer");this.options=Object.assign({},Qe.defaultEditorOptions,s);const{view:e,width:n,height:i,background:o}=this.options;this.app=new Zo({view:e,width:n,height:i,background:o}),this.scenes=[]}addTransformer(){var s;this.activeTransformer=new ko({wireframeStyle:{thickness:4,color:41471}}).on("pointertap",()=>{this.activeTransformer&&(this.activeTransformer.__isTapped?(this.activeChild=void 0,this.activeTransformer.group=[],this.options.onChangeActiveChild(void 0),this.activeTransformer.__doubleTapTimer&&clearTimeout(this.activeTransformer.__doubleTapTimer),this.activeTransformer.__isTapped=!1):(this.activeTransformer.__isTapped=!0,this.activeTransformer.__doubleTapTimer=setTimeout(()=>{this.activeTransformer&&(this.activeTransformer.__isTapped=!1)},600)))}),(s=this.activeScene)==null||s.addChild(this.activeTransformer)}removeTransformer(){var s;this.activeTransformer&&((s=this.activeScene)==null||s.removeChild(this.activeTransformer),this.activeTransformer.destroy(),this.activeTransformer=void 0)}addChildTransformListener(s){s.interactive=!0,s.on("pointerdown",()=>{this.setActiveChild(s)})}setActiveChild(s){this.activeChild=s,s&&(this.activeTransformer||this.addTransformer(),this.activeTransformer&&(this.activeTransformer.group=[s],this.moveChildToTop(this.activeTransformer))),this.options.onChangeActiveChild(s)}setActiveChildByName(s){const e=this.activeScene;if(e){const n=e.children.find(i=>i.name===s);n&&this.setActiveChild(n)}}updateActiveChild(s){this.activeChild&&(s(this.activeChild),this.options.onChangeActiveChild(this.activeChild))}removeChildTransformListener(s){s.removeAllListeners("pointerdown")}addScene(s,e){typeof e>"u"?this.scenes.push(s):this.scenes.splice(e,0,s);const n=i=>{if(i.children&&i.children.length>0)for(const o of i.children)n(o);else this.addChildTransformListener(i)};for(const i of s.children)n(i);this.options.onChangeScenes(this.scenes)}loadScenes(s){s.forEach(e=>{this.addScene(e)}),this.options.onChangeScenes(this.scenes)}removeScene(s){this.scenes=this.scenes.filter(e=>e!==s),this.activeScene===s&&(this.stageRemoveChild(this.activeScene),this.activeScene.destroy(),this.activeScene=void 0),this.options.onChangeScenes(this.scenes)}removeSceneByIndex(s){this.removeScene(this.scenes[s])}removeSceneByName(s){const e=this.getSceneByName(s);e&&this.removeScene(e)}getSceneByName(s){return this.scenes.find(e=>e.name===s)}cloneScene(s){this.removeTransformer();const e=s!=null?s:this.activeScene;if(e)return e.clone()}cloneSceneByIndex(s){return this.cloneScene(this.scenes[s])}cloneSceneByName(s){const e=this.getSceneByName(s);if(e)return this.cloneScene(e)}swapScene(s,e){[this.scenes[s],this.scenes[e]]=[this.scenes[e],this.scenes[s]],this.options.onChangeScenes(this.scenes)}setActiveScene(s){this.activeScene&&(this.stageRemoveChild(this.activeScene),this.removeTransformer()),this.activeScene=s,s&&(this.activeScene.load(),this.addTransformer(),this.stageAddChild(s)),this.options.onChangeActiveScene(s)}setActiveSceneByName(s){const e=this.scenes.find(n=>n.name===s);e&&this.setActiveScene(e)}setActiveSceneByIndex(s){this.setActiveScene(this.scenes[s])}getActiveSceneIndex(){return this.activeScene?this.scenes.indexOf(this.activeScene):-1}updateActiveScene(s){this.activeScene&&(s(this.activeScene),this.options.onChangeActiveScene(this.activeScene))}addChild(s){const e=this.activeScene;e&&(this.addChildTransformListener(s),e.addChild(s),this.options.onChangeActiveScene(e))}removeChild(s){var n;const e=this.activeScene;e&&(((n=this.activeChild)==null?void 0:n.name)===s.name&&(this.setActiveChild(void 0),this.removeTransformer()),this.removeChildTransformListener(s),e.removeChild(s),s.destroy(),this.options.onChangeActiveScene(e))}removeChildByName(s){const e=this.activeScene;if(e){const n=e.children.find(i=>i.name===s);n&&this.removeChild(n)}}toggleChildVisibleByName(s){const e=this.activeScene;if(e){const n=e.children.find(i=>i.name===s);n&&(n.visible=!n.visible),this.options.onChangeActiveScene(e)}}toggleChildInteractiveByName(s){const e=this.activeScene;if(e){const n=e.children.find(i=>i.name===s);n&&(n.interactive=!n.interactive),this.options.onChangeActiveScene(e)}}cloneChild(s){const e=s!=null?s:this.activeChild;if(e)return e.clone()}addSound(s){const e=this.activeScene;e&&(e.addSound(s),this.options.onChangeActiveScene(e))}removeSound(s){const e=this.activeScene;e&&(e.removeSound(s),this.options.onChangeActiveScene(e))}removeSoundByName(s){const e=this.activeScene;if(e){const n=e.sounds.find(i=>i.name===s);n&&this.removeSound(n)}}cloneDialogue(s){return Dt(s)}cloneDialogueSpeak(s){return Dt(s)}addDialogue(s,e){const n=this.activeScene;n&&(n.addDialogue(s,e),this.options.onChangeActiveScene(n))}updateDialogue(s,e){const n=this.activeScene;n&&(n.updateDialogue(s,e),this.options.onChangeActiveScene(n))}removeDialogue(s){const e=this.activeScene;e&&(e.removeDialogue(s),this.options.onChangeActiveScene(e))}swapDialogue(s,e){const n=this.activeScene;n&&(n.swapDialogue(s,e),this.options.onChangeActiveScene(n))}swapChildren(s,e){var n;(n=this.activeScene)==null||n.swapChildren(s,e)}moveChildTo(s,e){const n=e!=null?e:this.activeChild;n&&(n.zIndex=s)}moveChildToTop(s){const e=s!=null?s:this.activeChild;this.activeScene&&e&&(e.zIndex=Q.Text,this.activeScene.setChildIndex(e,this.activeScene.children.length-1))}moveChildToBottom(s){var n;const e=s!=null?s:this.activeChild;this.activeScene&&e&&(e.zIndex=Q.Background,(n=this.activeScene)==null||n.setChildIndex(e,0))}moveUpChild(s){const e=s!=null?s:this.activeChild;if(this.activeScene&&e){const n=this.activeScene.children.indexOf(e);if(n<this.activeScene.children.length-1){const i=this.activeScene.children[n+1];i.zIndex>e.zIndex&&(e.zIndex=i.zIndex),this.swapChildren(e,i)}}}moveDownChild(s){const e=s!=null?s:this.activeChild;if(this.activeScene&&e){const n=this.activeScene.children.indexOf(e);if(n>0){const i=this.activeScene.children[n-1];i.zIndex<e.zIndex&&(e.zIndex=i.zIndex),this.swapChildren(e,i)}}}stageAddChild(s){this.app.stage.addChild(s)}stageRemoveChild(s){const e=this.app.stage.children.find(n=>n.name===s.name);e&&this.app.stage.removeChild(e)}setChildPosition(s,e){const n=e!=null?e:this.activeChild,{width:i,height:o}=this.options;if(n)switch(s){case"top":n.y=0;break;case"middle":n.y=o/2-n.height/2;break;case"bottom":n.y=o-n.height;break;case"left":n.x=0;break;case"near-left":n.x=i/3-n.width/2;break;case"center":n.x=i/2-n.width/2;break;case"near-right":n.x=i/3*2-n.width/2;break;case"right":n.x=i-n.width;break}}genSceneScript(s){var l,c,u;const{dialogues:e,config:n}=s,i=n.speak,o=[],r=s.children.find(h=>h.assetType==="Background");r&&n.autoShowBackground&&o.push({directive:j.Show,params:{targetName:r.name}});for(const h of e){const{speak:m,lines:f}=h;i!=null&&i.dialogTargetName&&o.push({directive:j.Show,params:{targetName:i.dialogTargetName}});const x=[];f.forEach(S=>{if(S.type==="p")for(let k=0;k<S.children.length;k++){const W=S.children[k];if(W.type==="directive")x.push({type:"directive",value:W.value});else if(W.text&&(i!=null&&i.targetName)){let X=W.text;k===S.children.length-1&&(X+="\n"),x.push({type:"speak",value:X})}}});let b=!1,T,G="";(l=m.voice)!=null&&l.targetName&&(G=x.filter(S=>S.type==="speak").map(S=>S.value).join(""),T=(u=(c=s.sounds.find(S=>{var k;return S.name===((k=m.voice)==null?void 0:k.targetName)}))==null?void 0:c.buffer)==null?void 0:u.duration);const v=S=>{var X,A,B,$,w;const k=S.join("");let W;G&&T&&(W=k.length/G.length*T),o.push({directive:j.Speak,params:{targetName:i.targetName,text:k,append:b,voiceDuration:W,wordsPerMin:m.wordsPerMin,interval:m.interval,effect:m.effect,speaker:i.speaker.targetName?{targetName:i.speaker.targetName,name:((X=m.speaker)==null?void 0:X.name)||"",speakerTargetName:(A=m.speaker)==null?void 0:A.speakerTargetName,autoShowSpeaker:(B=m.speaker)==null?void 0:B.autoShowSpeaker,autoMaskOtherSpeakers:($=m.speaker)==null?void 0:$.autoMaskOtherSpeakers}:void 0,voice:b?void 0:(w=m.voice)!=null&&w.targetName?m.voice:void 0}}),b=!0};x.forEach(S=>{if(S.type==="directive"){const k=S.value;o.push(k)}else v([S.value])})}return{scene:s,config:n,directives:o}}async exportScreenplay(s=0,e){const n=this.exportScenes(s,e);for(const o of n)await o.load();const i=n.map(this.genSceneScript);return{config:{},scenes:i}}exportScenes(s=0,e){this.removeTransformer();const n=performance.now(),i=this.scenes.slice(s,e).map(o=>o.clone());return Le.info("editor export cost:",performance.now()-n),i}saveAsJSON(){return this.removeTransformer(),JSON.stringify({version:"2.0",config:{},scenes:this.scenes})}async loadFromJSON(s){const e=JSON.parse(s),n=[];for(const i of e.scenes){const o=await ye.fromJSON(i);n.push(o)}this.loadScenes(n)}clear(){this.scenes.forEach(s=>{this.removeScene(s)}),this.setActiveScene(void 0),this.setActiveChild(void 0),this.removeTransformer()}},p(Qe,"defaultEditorOptions",{width:1920,height:1080,background:0,onChangeActiveChild:()=>{},onChangeActiveScene:()=>{},onChangeScenes:()=>{}}),Qe);function ei(){const a=new ye,s=new $e;s.alpha=.7,s.beginFill(0),s.drawRect(0,0,1920,400),s.endFill(),s.x=0,s.y=680,s.zIndex=Q.Dialog,s.label="对话框",s.fillColor="#000000";const e=new de("角色名",{fill:16777215,fontSize:44,fontWeight:"bold"});e.x=160,e.y=700,e.zIndex=Q.Text,e.label="角色名",e.disableTextEdit=!0;const n=new de("角色台词",{fill:16777215,wordWrap:!0,breakWords:!0,wordWrapWidth:1600,fontSize:38,leading:15});return n.x=160,n.y=770,n.zIndex=Q.Text,n.label="角色台词",n.disableTextEdit=!0,a.addChild(s),a.addChild(e),a.addChild(n),a.config.speak.targetName=n.name,a.config.speak.dialogTargetName=s.name,a.config.speak.speaker.targetName=e.name,a.config.speak.speaker.name=e.text,a}function yd(){const a=new ye,s=new $e;s.alpha=.7,s.beginFill(0),s.drawRect(0,0,1920,1080),s.endFill(),s.x=0,s.y=0,s.zIndex=Q.Dialog,s.label="独白遮罩";const e=new de("独白台词",{fill:16777215,breakWords:!0,wordWrap:!0,wordWrapWidth:1600,fontSize:45,leading:15});return e.x=160,e.y=160,e.zIndex=Q.Text,e.label="独白台词",e.disableTextEdit=!0,a.addChild(s),a.addChild(e),a.config.speak.targetName=e.name,a.config.speak.dialogTargetName=s.name,a}function vd(){const a=new ye,s=new de("主标题",{fill:16777215,breakWords:!0,fontSize:100,fontWeight:"bold"});s.x=1920/2-s.width/2,s.y=1080/2-200,s.zIndex=Q.Text,s.label="主标题";const e=new de("副标题",{fill:16777215,breakWords:!0,fontSize:60});return e.x=1920/2-e.width/2,e.y=1080/2-40,e.zIndex=Q.Text,e.label="副标题",a.addChild(s),a.addChild(e),a.dialogues=[{speak:{wordsPerMin:500,interval:.2,effect:"typewriter",speaker:{targetName:"",name:"",autoShowSpeaker:{inEffect:"Show"},autoMaskOtherSpeakers:{alpha:.5},speakerTargetName:"Narrator"}},lines:[{children:[{text:""},{children:[{text:""}],type:"directive",value:{directive:"FadeIn",params:{targetName:s.name},label:"渐入:主标题"}},{text:""},{children:[{text:""}],type:"directive",value:{directive:"FadeIn",params:{targetName:e.name},label:"渐入:副标题"}},{text:""},{children:[{text:""}],type:"directive",value:{directive:"Wait",params:{duration:3},label:"停顿:3秒"}},{text:""}],type:"p"}]}],a}const R=Vs()(Rs(a=>{let s;return{project:null,editor:null,activeChild:null,activeScene:null,scenes:[],setProject(e){a(n=>{n.project={id:e.id,name:e.name}})},initEditor(e){s=new bd({view:e,onChangeActiveChild(n){a(i=>{if(!n){i.activeChild=null;return}let o={...n,width:n.width,height:n.height,x:n.x,y:n.y};if(n.type==="Text"){const r=n;o={...o,text:r.text,style:r.style&&{...r.style,fontFamily:r.style.fontFamily,fontWeight:r.style.fontWeight,fontStyle:r.style.fontStyle,fontSize:r.style.fontSize,fill:r.style.fill}}}i.activeChild=o})},onChangeActiveScene(n){a(i=>{n?i.activeScene={...n}:i.activeScene=null})},onChangeScenes(n){a(i=>{i.scenes=[...n]})}}),a(n=>{n.editor=s})}}})),le=Vs()(Rs(a=>({isOpen:!1,type:null,disableSelect:!1,confirm:null,cancel:null,setConfirm(s){a(e=>{e.confirm=s})},setCancel(s){a(e=>{e.cancel=s})},setOpen(s){a(e=>{e.isOpen=s})},setType(s){a(e=>{e.type=s})},setDisableSelect(s){a(e=>{e.disableSelect=s})}}))),At=Vs()(Rs(a=>({isOpen:!1,loadingText:"",setOpen(s){a(e=>{e.isOpen=s})},setLoadingText(s){a(e=>{e.loadingText=s})}}))),He=d.forwardRef(({className:a,...s},e)=>t.jsx("div",{ref:e,className:g("rounded-xl border bg-card text-card-foreground shadow",a),...s}));He.displayName="Card";const Sd=d.forwardRef(({className:a,...s},e)=>t.jsx("div",{ref:e,className:g("flex flex-col space-y-1.5 p-6",a),...s}));Sd.displayName="CardHeader";const jd=d.forwardRef(({className:a,...s},e)=>t.jsx("h3",{ref:e,className:g("font-semibold leading-none tracking-tight",a),...s}));jd.displayName="CardTitle";const wd=d.forwardRef(({className:a,...s},e)=>t.jsx("p",{ref:e,className:g("text-sm text-muted-foreground",a),...s}));wd.displayName="CardDescription";const Ve=d.forwardRef(({className:a,...s},e)=>t.jsx("div",{ref:e,className:g("p-6 pt-0",a),...s}));Ve.displayName="CardContent";const ts=d.forwardRef(({className:a,...s},e)=>t.jsx("div",{ref:e,className:g("flex items-center p-6 pt-0",a),...s}));ts.displayName="CardFooter";const we=d.forwardRef(({className:a,children:s,...e},n)=>{const i=d.useRef(null);return d.useImperativeHandle(n,()=>({scrollToBottom:()=>{i.current&&i.current.scrollTo({top:i.current.scrollHeight,behavior:"smooth"})}})),t.jsxs(Wa,{className:g("relative overflow-hidden",a),...e,children:[t.jsx(Go,{ref:i,className:"h-full w-full rounded-[inherit]",children:s}),t.jsx(Os,{}),t.jsx(To,{})]})});we.displayName=Wa.displayName;const Os=d.forwardRef(({className:a,orientation:s="vertical",...e},n)=>t.jsx(La,{ref:n,orientation:s,className:g("flex touch-none select-none transition-colors",s==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",s==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...e,children:t.jsx(Vo,{className:"relative flex-1 rounded-full bg-border"})}));Os.displayName=La.displayName;const Nd=a=>t.jsx("svg",{viewBox:"0 0 24 24",height:"48",width:"48",focusable:"false",role:"img",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",...a,children:t.jsx("path",{d:"M3 6a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v12a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6zm10 13h5a1 1 0 0 0 1-1v-5h-6v6zm-2-6H5v5a1 1 0 0 0 1 1h5v-6zm2-2h6V6a1 1 0 0 0-1-1h-5v6zm-2-6H6a1 1 0 0 0-1 1v5h6V5z"})}),Cd=a=>t.jsx("svg",{viewBox:"0 0 24 24",height:"48",width:"48",focusable:"false",role:"img",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",...a,children:t.jsx("path",{d:"M13 5a1 1 0 1 0 0-2h-2a1 1 0 1 0 0 2h2zm-8 6a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0v-2zm-2 7a1 1 0 1 1 2 0 1 1 0 0 0 1 1h12a1 1 0 0 0 1-1 1 1 0 1 1 2 0 3 3 0 0 1-3 3H6a3 3 0 0 1-3-3zm17-8a1 1 0 0 0-1 1v2a1 1 0 1 0 2 0v-2a1 1 0 0 0-1-1zM7 4a1 1 0 0 0-1-1 3 3 0 0 0-3 3 1 1 0 0 0 2 0 1 1 0 0 1 1-1 1 1 0 0 0 1-1zm11-1a1 1 0 1 0 0 2 1 1 0 0 1 1 1 1 1 0 1 0 2 0 3 3 0 0 0-3-3z"})}),Zd=a=>t.jsx("svg",{viewBox:"0 0 24 24",height:"48",width:"48",focusable:"false",role:"img",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",...a,children:t.jsx("path",{d:"M6 21a1 1 0 1 0 0-2 1 1 0 0 1-1-1V6a1 1 0 0 1 1-1 1 1 0 0 0 0-2 3 3 0 0 0-3 3v12a3 3 0 0 0 3 3zm7-16a1 1 0 1 0 0-2h-2a1 1 0 1 0 0 2h2zm6 6a1 1 0 1 1 2 0v2a1 1 0 1 1-2 0v-2zm-5 9a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zm4-17a1 1 0 1 0 0 2 1 1 0 0 1 1 1 1 1 0 1 0 2 0 3 3 0 0 0-3-3zm-1 17a1 1 0 0 0 1 1 3 3 0 0 0 3-3 1 1 0 1 0-2 0 1 1 0 0 1-1 1 1 1 0 0 0-1 1z"})}),kd=a=>t.jsx("svg",{viewBox:"0 0 24 24",height:"48",width:"48",focusable:"false",role:"img",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",...a,children:t.jsx("path",{d:"M14 4a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zm-9 7a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0v-2zm14 0a1 1 0 1 1 2 0v2a1 1 0 1 1-2 0v-2zm-6 10a1 1 0 1 0 0-2h-2a1 1 0 1 0 0 2h2zM7 4a1 1 0 0 0-1-1 3 3 0 0 0-3 3 1 1 0 0 0 2 0 1 1 0 0 1 1-1 1 1 0 0 0 1-1zm11-1a1 1 0 1 0 0 2 1 1 0 0 1 1 1 1 1 0 1 0 2 0 3 3 0 0 0-3-3zM7 20a1 1 0 0 1-1 1 3 3 0 0 1-3-3 1 1 0 1 1 2 0 1 1 0 0 0 1 1 1 1 0 0 1 1 1zm11 1a1 1 0 1 1 0-2 1 1 0 0 0 1-1 1 1 0 1 1 2 0 3 3 0 0 1-3 3z"})}),Gd=a=>t.jsx("svg",{viewBox:"0 0 24 24",height:"48",width:"48",focusable:"false",role:"img",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",...a,children:t.jsx("path",{d:"M13 5a1 1 0 1 0 0-2h-2a1 1 0 1 0 0 2h2zm-8 6a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0v-2zm9 9a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zM6 3a1 1 0 0 1 0 2 1 1 0 0 0-1 1 1 1 0 0 1-2 0 3 3 0 0 1 3-3zm1 17a1 1 0 0 1-1 1 3 3 0 0 1-3-3 1 1 0 1 1 2 0 1 1 0 0 0 1 1 1 1 0 0 1 1 1zm11 1a1 1 0 1 1 0-2 1 1 0 0 0 1-1V6a1 1 0 0 0-1-1 1 1 0 1 1 0-2 3 3 0 0 1 3 3v12a3 3 0 0 1-3 3z"})}),Td=a=>t.jsx("svg",{viewBox:"0 0 24 24",height:"48",width:"48",focusable:"false",role:"img",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",...a,children:t.jsx("path",{d:"M3 6a1 1 0 0 0 2 0 1 1 0 0 1 1-1h12a1 1 0 0 1 1 1 1 1 0 1 0 2 0 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3zm2 5a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0v-2zm14 0a1 1 0 1 1 2 0v2a1 1 0 1 1-2 0v-2zm-5 9a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zm-8 1a1 1 0 1 0 0-2 1 1 0 0 1-1-1 1 1 0 1 0-2 0 3 3 0 0 0 3 3zm11-1a1 1 0 0 0 1 1 3 3 0 0 0 3-3 1 1 0 1 0-2 0 1 1 0 0 1-1 1 1 1 0 0 0-1 1z"})}),Z={add:Ro,alignCenter:Wo,alignJustify:Lo,alignLeft:Xo,alignRight:Io,arrowDown:Fo,bg:Ko,blockquote:zo,bold:Do,borderAll:Nd,borderBottom:Cd,borderLeft:Zd,borderNone:kd,borderRight:Gd,borderTop:Td,check:Yo,chevronRight:Ho,chevronsUpDown:Mo,clear:fa,close:fa,code:Po,codeblock:Uo,color:Ao,column:Bo,combine:Eo,ungroup:Oo,comment:Jo,commentAdd:Qo,delete:xa,dragHandle:_o,editing:$o,emoji:qo,externalLink:er,h1:tr,h2:sr,h3:ar,h4:nr,h5:ir,h6:or,image:rr,indent:lr,italic:cr,kbd:dr,lineHeight:hr,link:ur,minus:mr,more:pr,ol:fr,outdent:xr,paragraph:gr,refresh:br,row:yr,search:vr,settings:Sr,strikethrough:jr,subscript:wr,superscript:Nr,table:Cr,text:Zr,trash:kr,trash2:xa,ul:Gr,underline:Tr,unlink:Vr,viewing:Rr,viewingOff:Wr,lock:Lr,lockOpen:Xr,type:Ir,fontSize:Fr,bookOpenText:Kr,copy:zr,moveUp:Dr,moveDown:Yr,squarePlus:Hr,folder:Mr,bookmark:Pr,mic:Ur,download:Ar,edit:Br,library:Er,scene:Or,images:Jr,preview:Qr,tip:_r,wandSparkles:$r,sparkles:qr,gitHub:a=>t.jsx("svg",{viewBox:"0 0 438.549 438.549",...a,children:t.jsx("path",{fill:"currentColor",d:"M409.132 114.573c-19.608-33.596-46.205-60.194-79.798-79.8-33.598-19.607-70.277-29.408-110.063-29.408-39.781 0-76.472 9.804-110.063 29.408-33.596 19.605-60.192 46.204-79.8 79.8C9.803 148.168 0 184.854 0 224.63c0 47.78 13.94 90.745 41.827 128.906 27.884 38.164 63.906 64.572 108.063 79.227 5.14.954 8.945.283 11.419-1.996 2.475-2.282 3.711-5.14 3.711-8.562 0-.571-.049-5.708-.144-15.417a2549.81 2549.81 0 01-.144-25.406l-6.567 1.136c-4.187.767-9.469 1.092-15.846 1-6.374-.089-12.991-.757-19.842-1.999-6.854-1.231-13.229-4.086-19.13-8.559-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-.951-2.568-2.098-3.711-3.429-1.142-1.331-1.997-2.663-2.568-3.997-.572-1.335-.098-2.43 1.427-3.289 1.525-.859 4.281-1.276 8.28-1.276l5.708.853c3.807.763 8.516 3.042 14.133 6.851 5.614 3.806 10.229 8.754 13.846 14.842 4.38 7.806 9.657 13.754 15.846 17.847 6.184 4.093 12.419 6.136 18.699 6.136 6.28 0 11.704-.476 16.274-1.423 4.565-.952 8.848-2.383 12.847-4.285 1.713-12.758 6.377-22.559 13.988-29.41-10.848-1.14-20.601-2.857-29.264-5.14-8.658-2.286-17.605-5.996-26.835-11.14-9.235-5.137-16.896-11.516-22.985-19.126-6.09-7.614-11.088-17.61-14.987-29.979-3.901-12.374-5.852-26.648-5.852-42.826 0-23.035 7.52-42.637 22.557-58.817-7.044-17.318-6.379-36.732 1.997-58.24 5.52-1.715 13.706-.428 24.554 3.853 10.85 4.283 18.794 7.952 23.84 10.994 5.046 3.041 9.089 5.618 12.135 7.708 17.705-4.947 35.976-7.421 54.818-7.421s37.117 2.474 54.823 7.421l10.849-6.849c7.419-4.57 16.18-8.758 26.262-12.565 10.088-3.805 17.802-4.853 23.134-3.138 8.562 21.509 9.325 40.922 2.279 58.24 15.036 16.18 22.559 35.787 22.559 58.817 0 16.178-1.958 30.497-5.853 42.966-3.9 12.471-8.941 22.457-15.125 29.979-6.191 7.521-13.901 13.85-23.131 18.986-9.232 5.14-18.182 8.85-26.84 11.136-8.662 2.286-18.415 4.004-29.263 5.146 9.894 8.562 14.842 22.077 14.842 40.539v60.237c0 3.422 1.19 6.279 3.572 8.562 2.379 2.279 6.136 2.95 11.276 1.995 44.163-14.653 80.185-41.062 108.068-79.226 27.88-38.161 41.825-81.126 41.825-128.906-.01-39.771-9.818-76.454-29.414-110.049z"})}),logo:a=>t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",...a,children:t.jsx("path",{fill:"currentColor",d:"M11.572 0c-.176 0-.31.001-.358.007a19.76 19.76 0 0 1-.364.033C7.443.346 4.25 2.185 2.228 5.012a11.875 11.875 0 0 0-2.119 5.243c-.096.659-.108.854-.108 1.747s.012 1.089.108 1.748c.652 4.506 3.86 8.292 8.209 9.695.779.25 1.6.422 2.534.525.363.04 1.935.04 2.299 0 1.611-.178 2.977-.577 4.323-1.264.207-.106.247-.134.219-.158-.02-.013-.9-1.193-1.955-2.62l-1.919-2.592-2.404-3.558a338.739 338.739 0 0 0-2.422-3.556c-.009-.002-.018 1.579-.023 3.51-.007 3.38-.01 3.515-.052 3.595a.426.426 0 0 1-.206.214c-.075.037-.14.044-.495.044H7.81l-.108-.068a.438.438 0 0 1-.157-.171l-.05-.106.006-4.703.007-4.705.072-.092a.645.645 0 0 1 .174-.143c.096-.047.134-.051.54-.051.478 0 .558.018.682.154.035.038 1.337 1.999 2.895 4.361a10760.433 10760.433 0 0 0 4.735 7.17l1.9 2.879.096-.063a12.317 12.317 0 0 0 2.466-2.163 11.944 11.944 0 0 0 2.824-6.134c.096-.66.108-.854.108-1.748 0-.893-.012-1.088-.108-1.747-.652-4.506-3.859-8.292-8.208-9.695a12.597 12.597 0 0 0-2.499-.523A33.119 33.119 0 0 0 11.573 0zm4.069 7.217c.347 0 .408.005.486.047a.473.473 0 0 1 .237.277c.018.06.023 1.365.018 4.304l-.006 4.218-.744-1.14-.746-1.14v-3.066c0-1.982.01-3.097.023-3.15a.478.478 0 0 1 .233-.296c.096-.05.13-.054.5-.054z"})}),moon:el,sun:tl},Js=Fa,Qs=Ka,Vd=Xs,Rd=sl,ti=d.forwardRef(({className:a,inset:s,children:e,...n},i)=>t.jsxs(Ws,{ref:i,className:g("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",s&&"pl-8",a),...n,children:[e,t.jsx(Xa,{className:"ml-auto h-4 w-4"})]}));ti.displayName=Ws.displayName;const si=d.forwardRef(({className:a,...s},e)=>t.jsx(Ls,{ref:e,className:g("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...s}));si.displayName=Ls.displayName;const ss=d.forwardRef(({className:a,sideOffset:s=4,...e},n)=>t.jsx(Xs,{children:t.jsx(Is,{ref:n,sideOffset:s,className:g("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e})}));ss.displayName=Is.displayName;const q=d.forwardRef(({className:a,inset:s,...e},n)=>t.jsx(Fs,{ref:n,className:g("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s&&"pl-8",a),...e}));q.displayName=Fs.displayName;const Wd=d.forwardRef(({className:a,children:s,checked:e,...n},i)=>t.jsxs(Ks,{ref:i,className:g("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:e,...n,children:[t.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:t.jsx(Qt,{children:t.jsx(zs,{className:"h-4 w-4"})})}),s]}));Wd.displayName=Ks.displayName;const Ld=d.forwardRef(({className:a,children:s,...e},n)=>t.jsxs(Ds,{ref:n,className:g("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...e,children:[t.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:t.jsx(Qt,{children:t.jsx(Ia,{className:"h-4 w-4 fill-current"})})}),s]}));Ld.displayName=Ds.displayName;const Xd=d.forwardRef(({className:a,inset:s,...e},n)=>t.jsx(Ys,{ref:n,className:g("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",a),...e}));Xd.displayName=Ys.displayName;const _s=d.forwardRef(({className:a,...s},e)=>t.jsx(Hs,{ref:e,className:g("-mx-1 my-1 h-px bg-muted",a),...s}));_s.displayName=Hs.displayName;const Id=function(){const a=["monospace","sans-serif","serif"],s="mmmmmmmmmmlli",e="72px",n=document.getElementsByTagName("body")[0],i=document.createElement("span");i.style.fontSize=e,i.innerHTML=s;const o={},r={};for(const c in a)i.style.fontFamily=a[c],n.appendChild(i),o[a[c]]=i.offsetWidth,r[a[c]]=i.offsetHeight,n.removeChild(i);function l(c){let u=!1;for(const h in a){i.style.fontFamily=c+","+a[h],n.appendChild(i);const m=i.offsetWidth!=o[a[h]]||i.offsetHeight!=r[a[h]];n.removeChild(i),u=u||m}return u}this.detect=l},It={windows:[{ch:"宋体",en:"SimSun"},{ch:"黑体",en:"SimHei"},{ch:"微软雅黑",en:"Microsoft Yahei"},{ch:"微软正黑体",en:"Microsoft JhengHei"},{ch:"楷体",en:"KaiTi"},{ch:"新宋体",en:"NSimSun"},{ch:"仿宋",en:"FangSong"}],"OS X":[{ch:"苹方",en:"PingFang SC"},{ch:"冬青黑体简",en:"Hiragino Sans GB"},{ch:"兰亭黑-简",en:"Lantinghei SC"},{ch:"翩翩体-简",en:"Hanzipen SC"},{ch:"手札体-简",en:"Hannotate SC"},{ch:"宋体-简",en:"Songti SC"},{ch:"娃娃体-简",en:"Wawati SC"},{ch:"魏碑-简",en:"Weibei SC"},{ch:"行楷-简",en:"Xingkai SC"},{ch:"雅痞-简",en:"Yapi SC"},{ch:"圆体-简",en:"Yuanti SC"}],office:[{ch:"幼圆",en:"YouYuan"},{ch:"隶书",en:"LiSu"},{ch:"华文细黑",en:"STXihei"},{ch:"华文黑体",en:"STHeiti"},{ch:"华文楷体",en:"STKaiti"},{ch:"华文宋体",en:"STSong"},{ch:"华文仿宋",en:"STFangsong"},{ch:"华文中宋",en:"STZhongsong"},{ch:"华文彩云",en:"STCaiyun"},{ch:"华文琥珀",en:"STHupo"},{ch:"华文新魏",en:"STXinwei"},{ch:"华文隶书",en:"STLiti"},{ch:"华文行楷",en:"STXingkai"},{ch:"方正舒体",en:"FZShuTi"},{ch:"方正姚体",en:"FZYaoti"}],open:[{ch:"思源黑体",en:"Source Han Sans CN"},{ch:"思源宋体",en:"Source Han Serif SC"},{ch:"文泉驿微米黑",en:"WenQuanYi Micro Hei"},{ch:"霞鹜文楷",en:"LXGW WenKai"},{ch:"方舟像素",en:"Ark Pixel 12px Monospaced zh_cn"},{ch:"DW Pica Roman V",en:"DW Pica Roman V"}]},Fd=new Id,Kd=[{ch:"Arial",en:"Arial"}].concat([...It["OS X"],...It.windows,...It.open,...It.office].filter(a=>Fd.detect(a.en)));var rt=(a=>(a.NORMAL="normal",a.BOLD="bold",a))(rt||{}),lt=(a=>(a.NORMAL="normal",a.ITALIC="italic",a))(lt||{});async function Cs(a,s){const e=new FontFace(a,typeof s=="string"?"url(".concat(s,")"):s);document.fonts.add(e),await e.load()}var C=(a=>(a.Character="Character",a.Background="Background",a.Thing="Thing",a.Dialog="Dialog",a.Audio="Audio",a.Font="Font",a))(C||{});const $s=[{name:"角色",value:"Character"},{name:"背景",value:"Background"},{name:"物品",value:"Thing"},{name:"对话框",value:"Dialog"},{name:"音频",value:"Audio"},{name:"字体",value:"Font"}],zd=$s.reduce((a,{name:s,value:e})=>(a[e]=s,a),{});class Dd extends al{constructor(){super("vnve2");p(this,"asset");p(this,"assetSource");p(this,"template");p(this,"project");this.version(3).stores({asset:"++id, name, type, states, [name+type]",assetSource:"++id, mime, blob, ext",template:"++id, name, type, content",project:"++id, name, time, content"})}}const st=new Dd,O=st.asset,Ge=st.assetSource,Bt=st.template,We=st.project;function ie(a){return a.url||"https://s/".concat(a.id,".").concat(a.ext)}function ai(a){switch(a){case"Background":case"Character":case"Thing":case"Dialog":return".webp, .png, .jpg, .jpeg, .gif, .mp4";case"Audio":return".mp3, .wav, .m4a, .aac";case"Font":return".ttf, .woff, .woff2";default:return""}}async function Yd(){const a=await window.showDirectoryPicker();for(const s of $s){const e=await a.getDirectoryHandle(s.name).catch(()=>{});if(e){for await(const[n,i]of e.entries())if(i.kind==="directory"){const o=await O.add({name:n,type:s.value,states:[]});for await(const[,r]of i.entries())if(r.kind==="file"){const l=await r.getFile(),{name:c,ext:u}=ut(l);if(ai(s.value).includes(u)){const m=await Ge.add({mime:l.type,blob:l,ext:u});await O.where("id").equals(o).modify(f=>{f.states.push({id:m,name:c,ext:u})})}}}}}}async function Hd(){await Ge.clear(),await O.clear()}async function Md(){const a=await O.where("type").equals("Font").toArray();for(const s of a)for(const e of s.states)await Cs(e.name,ie(e))}async function ya(a,s,e){const n={name:a};e&&(n.type=e);const i=await O.where(n).first();if(s){const o=i.states.find(r=>r.name===s);return o?{...i,stateId:o.id}:void 0}return i}async function Pd(){const a=await st.export();zn("book",URL.createObjectURL(a),"vnve")}async function Ud(){const s=(await Dn({accept:".vnve"}))[0];s&&await st.import(s)}async function va(a){return(await O.where("type").equals(a).toArray()).map(e=>e.name)}const Ad="/assets/day-b6ef6b0c.webp",Bd="/assets/night-da7c9955.webp",Ed="/assets/day-c525641b.webp",Od="/assets/night-61088675.webp",Jd="/assets/default-9e36bbf3.webp",Qd="/assets/happy-61fa7adf.webp",_d="/assets/default-6a415d65.webp",$d="/assets/happy-77097254.webp",qd="/assets/red-628f973d.webp",eh="/assets/bgm1-865a2e82.mp3",th="/assets/bgm2-9df28d45.mp3",sh="/assets/thunder-fcdc6cdf.mp3",ah="/assets/rain-2ed4ca49.mp3",nh="/assets/open-door-0aa9286c.mp3",ih="/assets/knock-door-25770f6b.mp3",oh="/assets/zh-hans-17f9a740.woff2",rh="/assets/zh-hant-df9154bf.woff2",lh=[{type:C.Background,assets:[{name:"教室",states:[{name:"白天",url:Ad},{name:"夜晚",url:Bd}]},{name:"学校",states:[{name:"白天",url:Ed},{name:"夜晚",url:Od}]}]},{type:C.Character,assets:[{name:"男主",states:[{name:"默认",url:Jd},{name:"开心",url:Qd}]},{name:"女主",states:[{name:"默认",url:_d},{name:"开心",url:$d}]}]},{type:C.Thing,assets:[{name:"书",states:[{name:"红色",url:qd}]}]},{type:C.Audio,assets:[{name:"BGM",states:[{name:"bgm1",url:eh},{name:"bgm2",url:th}]},{name:"日常声音",states:[{name:"开门声",url:nh},{name:"敲门声",url:ih},{name:"雨声",url:ah},{name:"雷声",url:sh}]}]},{type:C.Font,assets:[{name:"缝合像素字体",states:[{name:"缝合像素简中",url:oh},{name:"缝合像素繁中",url:rh}]}]}];async function ch(){for(const a of lh){const{type:s,assets:e}=a;for(const n of e){const{name:i,states:o}=n,r=await O.add({name:i,type:s,states:[]});for(const l of o){const{name:c,url:u}=l,h=u.split(".").pop(),m=null,f="",x=await Ge.add({mime:f,ext:h,blob:m,url:u});await O.where("id").equals(r).modify(b=>{b.states.push({id:x,name:c,ext:h,url:u})})}}}}const Sa="IS_PRESET_IMPORTED";async function dh(){try{if(localStorage.getItem(Sa))return;localStorage.setItem(Sa,"true"),await Ge.count()===0&&await ch()}catch(a){console.error("导入预设资源失败",a)}}const hh=[{name:"对话",content:ei},{name:"独白",content:yd},{name:"标题",content:vd},{name:"空白",content:()=>new ye}];function ni(){const a=R(i=>i.editor),s=vt(()=>Bt.reverse().toArray());return{defaultTemplates:hh,customTemplates:s||[],handleAddDefaultTemplate:(i,o)=>()=>{const r=i();a.addScene(r,o),a.setActiveSceneByName(r.name)},handleAddCustomTemplate:async(i,o)=>{const r=await ye.fromJSON(JSON.parse(i),!1);a.addScene(r,o),a.setActiveSceneByName(r.name)}}}function uh({onOpenSceneDetailDialog:a}){const s=R(f=>f.editor),e=R(f=>f.activeScene),n=R(f=>f.scenes),{defaultTemplates:i,customTemplates:o,handleAddDefaultTemplate:r,handleAddCustomTemplate:l}=ni(),c=d.useRef(null);d.useEffect(()=>{c.current&&c.current.scrollIntoView({behavior:"smooth"})},[n.length]);const u=f=>{f.name===(e==null?void 0:e.name)&&s.setActiveScene(void 0),s.removeSceneByName(f.name)},h=(f,x)=>{const b=s.cloneSceneByName(f.name);s.addScene(b,x),s.setActiveSceneByName(b.name)},m=(f,x)=>{s.swapScene(f,x)};return t.jsx(He,{className:"flex-1 shrink-0 max-h-[50%] sm:max-h-full rounded-md",children:t.jsx(Ve,{className:"h-full p-1",children:t.jsx(we,{className:"h-full p-2",children:t.jsxs($t,{children:[t.jsx(qt,{children:t.jsxs(Ie,{children:[t.jsx(Fe,{children:"场景"}),t.jsx(Fe,{className:"w-[3rem] text-right",children:"操作"})]})}),t.jsx(es,{children:n.map((f,x)=>t.jsxs(Ie,{ref:(e==null?void 0:e.name)===f.name?c:null,className:"".concat((e==null?void 0:e.name)===f.name?"bg-muted":""," cursor-pointer"),children:[t.jsxs(Ke,{onClick:()=>{s.setActiveSceneByName(f.name)},children:[t.jsxs("span",{className:"font-medium mr-1",children:[x+1,"."]}),f.label]}),t.jsxs(Ke,{className:"flex gap-1 justify-end",children:[x>0&&t.jsx(Z.moveUp,{className:"size-4 cursor-pointer",onClick:()=>m(x,x-1)}),x<n.length-1&&t.jsx(Z.moveDown,{className:"size-4 cursor-pointer",onClick:()=>m(x,x+1),children:"下移"}),t.jsxs(Js,{modal:!1,children:[t.jsx(Qs,{children:t.jsx(Z.more,{className:"size-4 cursor-pointer"})}),t.jsxs(ss,{children:[t.jsx(q,{className:"flex md:hidden",onClick:a,children:"编辑"}),t.jsxs(Rd,{children:[t.jsx(ti,{children:"插入"}),t.jsx(Vd,{children:t.jsxs(si,{children:[i.map(b=>t.jsx(q,{onClick:r(b.content,x+1),children:b.name},b.name)),o.length>0&&t.jsx(_s,{}),o.map(b=>t.jsx(q,{onClick:()=>l(b.content,x+1),children:b.name},b.id))]})})]}),t.jsx(q,{onClick:()=>h(f,x+1),children:"复制"}),t.jsx(q,{className:"text-destructive",onClick:()=>u(f),children:"删除"})]})]})]})]},f.name))})]})})})})}function Gt(){const a=le(r=>r.setConfirm),s=le(r=>r.setCancel),e=le(r=>r.setOpen),n=le(r=>r.setType),i=le(r=>r.setDisableSelect);return{selectAsset:(r,l)=>new Promise(c=>{a(u=>{c(u),e(!1)}),s(()=>{c(void 0),e(!1)}),e(!0),n(r),i(l)})}}async function gt(a,s){var o;const e=a.states,n=(o=e.find(r=>r.id===a.stateId))!=null?o:e[0];let i;return n.ext==="gif"?i=new Ut({source:ie(n)}):n.ext==="mp4"?i=new ft({source:ie(n)}):i=new pt({source:ie(n)}),i.label=a.name,i.assetID=a.id,i.assetType=a.type,await i.load(),a.type===C.Character?(i.zIndex=Q.Character,i.x=s.options.width/2-i.width/2,i.y=s.options.height-i.height):a.type===C.Background?(i.zIndex=Q.Background,i.width=s.options.width,i.height=s.options.height):a.type===C.Dialog&&(i.zIndex=Q.Dialog,i.x=s.options.width/2-i.width/2,i.y=s.options.height-i.height),i}function mh(a){const s=new de("自定义文案",{fill:16777215,breakWords:!0,wordWrap:!0,wordWrapWidth:1600,fontSize:60,leading:15});return s.x=a.options.width/2-s.width/2,s.y=a.options.height/2-s.height/2,s.zIndex=Q.Text,s.label="自定义文案"+s.name,s}function ii(a){var i;const s=a.states,e=(i=s.find(o=>o.id===a.stateId))!=null?i:s[0],n=new xt({source:ie(e)});return n.label=e.name,n.assetID=a.id,n.assetType=a.type,n}let oi=!1;function ph(a){oi=a}function ja(){return oi}function ys(a){let s=a,e;const n=a.match(/^(.+)\[(.+)\]$/);return n&&(s=n[1],e=n[2]),{name:s,stateName:e}}async function qs(a,s,e=!1){var o;const n=a.split(/\n\s*\n/).filter(r=>r.trim()!=="").map(r=>{const[l,...c]=r.split("\n");return{name:l,value:c.join("\n")}}),i=[];n.forEach(r=>{r.name==="标题"?i.push({name:r.value,background:"",dialogues:[]}):r.name==="场景"?((!i[i.length-1]||i[i.length-1].background)&&i.push({name:"",background:"",dialogues:[]}),i[i.length-1].background=r.value):i[i.length-1].dialogues.push(r)}),console.log("screenplay",i);for(const r of i)try{const l=ei();if(l.label=r.name,s.addScene(l),s.setActiveScene(l),r.background){const{name:m,stateName:f}=ys(r.background),x=await ya(m,f,C.Background);if(x){const b=await gt(x,s);s.addChild(b)}else{const b='素材库中没有找到名称为"'.concat(m).concat(f?"[".concat(f,"]"):"",'"的背景素材');if(e)console.warn(b);else throw new Error(b)}}let c=1;const u=new Set;r.dialogues.forEach(m=>{const{name:f}=ys(m.name);f!=="旁白"&&u.add(f)});const h=u.size;for(const m of r.dialogues){const f={targetName:"",speakerTargetName:"",name:""};let x;if(m.name==="旁白")f.speakerTargetName="Narrator";else{const{name:T,stateName:G}=ys(m.name),v=await ya(T,G,C.Character),S='素材库中没有找到名称为"'.concat(T).concat(G?"[".concat(G,"]"):"",'"的角色素材');if(v){const k=l.getChildByLabel(T);if(k){if(f.speakerTargetName=k.name,f.name=k.label,G){const W=v.states,X=(o=W.find(A=>A.id===v.stateId))!=null?o:W[0];x={type:"directive",value:{directive:"ChangeSource",params:{targetName:k.name,source:ie(X)},label:"变更:".concat(k.label,":").concat(G)},children:[{text:""}]}}}else{const W=await gt(v,s);W.x=s.options.width/(h+1)*c-W.width/2,c++,s.addChild(W),f.speakerTargetName=W.name,f.name=W.label}}else if(f.name=T,e)console.warn(S);else throw new Error(S)}let b=[];x&&(b=[{text:""},x,{text:""}]),s.addDialogue({speak:{speaker:f},lines:[{type:"p",children:[...b,{text:m.value}]}]})}}catch(l){throw new Error("".concat(r.name,"中存在语法错误：").concat(l.message))}}const it=il,ri=d.forwardRef(({className:a,...s},e)=>t.jsx(za,{ref:e,className:g("flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm",a),...s}));ri.displayName=za.displayName;const Ue=d.forwardRef(({className:a,...s},e)=>t.jsx(Da,{ref:e,className:g("flex cursor-default select-none items-center rounded-sm px-2 sm:px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",a),...s}));Ue.displayName=Da.displayName;const fh=d.forwardRef(({className:a,inset:s,children:e,...n},i)=>t.jsxs(Ya,{ref:i,className:g("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",s&&"pl-8",a),...n,children:[e,t.jsx(Xa,{className:"ml-auto h-4 w-4"})]}));fh.displayName=Ya.displayName;const xh=d.forwardRef(({className:a,...s},e)=>t.jsx(Ha,{ref:e,className:g("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...s}));xh.displayName=Ha.displayName;const Ae=d.forwardRef(({className:a,align:s="start",alignOffset:e=-4,sideOffset:n=8,...i},o)=>t.jsx(nl,{children:t.jsx(Ma,{ref:o,align:s,alignOffset:e,sideOffset:n,className:g("z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...i})}));Ae.displayName=Ma.displayName;const H=d.forwardRef(({className:a,inset:s,...e},n)=>t.jsx(Pa,{ref:n,className:g("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s&&"pl-8",a),...e}));H.displayName=Pa.displayName;const gh=d.forwardRef(({className:a,children:s,checked:e,...n},i)=>t.jsxs(Ua,{ref:i,className:g("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:e,...n,children:[t.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:t.jsx(Aa,{children:t.jsx(zs,{className:"h-4 w-4"})})}),s]}));gh.displayName=Ua.displayName;const bh=d.forwardRef(({className:a,children:s,...e},n)=>t.jsxs(Ba,{ref:n,className:g("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...e,children:[t.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:t.jsx(Aa,{children:t.jsx(Ia,{className:"h-4 w-4 fill-current"})})}),s]}));bh.displayName=Ba.displayName;const yh=d.forwardRef(({className:a,inset:s,...e},n)=>t.jsx(Ea,{ref:n,className:g("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",a),...e}));yh.displayName=Ea.displayName;const Be=d.forwardRef(({className:a,...s},e)=>t.jsx(Oa,{ref:e,className:g("-mx-1 my-1 h-px bg-muted",a),...s}));Be.displayName=Oa.displayName;const Ne=rl,vh=ll,li=d.forwardRef(({className:a,...s},e)=>t.jsx(Ja,{ref:e,className:g("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...s}));li.displayName=Ja.displayName;const me=d.forwardRef(({className:a,children:s,disableClose:e,...n},i)=>t.jsxs(vh,{children:[t.jsx(li,{}),t.jsxs(Qa,{ref:i,className:g("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...n,children:[s,!e&&t.jsxs(ol,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[t.jsx(_a,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));me.displayName=Qa.displayName;const pe=({className:a,...s})=>t.jsx("div",{className:g("flex flex-col space-y-1.5 text-center sm:text-left",a),...s});pe.displayName="DialogHeader";const ea=({className:a,...s})=>t.jsx("div",{className:g("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...s});ea.displayName="DialogFooter";const fe=d.forwardRef(({className:a,...s},e)=>t.jsx($a,{ref:e,className:g("text-lg font-semibold leading-none tracking-tight",a),...s}));fe.displayName=$a.displayName;const xe=d.forwardRef(({className:a,...s},e)=>t.jsx(qa,{ref:e,className:g("text-sm text-muted-foreground",a),...s}));xe.displayName=qa.displayName;const Sh=oe("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),ce=d.forwardRef(({className:a,...s},e)=>t.jsx(en,{ref:e,className:g(Sh(),a),...s}));ce.displayName=en.displayName;const at=hl,ci=d.createContext({}),D=({...a})=>t.jsx(ci.Provider,{value:{name:a.name},children:t.jsx(cl,{...a})}),as=()=>{const a=d.useContext(ci),s=d.useContext(di),{getFieldState:e,formState:n}=dl(),i=e(a.name,n);if(!a)throw new Error("useFormField should be used within <FormField>");const{id:o}=s;return{id:o,name:a.name,formItemId:"".concat(o,"-form-item"),formDescriptionId:"".concat(o,"-form-item-description"),formMessageId:"".concat(o,"-form-item-message"),...i}},di=d.createContext({}),I=d.forwardRef(({className:a,...s},e)=>{const n=d.useId();return t.jsx(di.Provider,{value:{id:n},children:t.jsx("div",{ref:e,className:g("space-y-2",a),...s})})});I.displayName="FormItem";const K=d.forwardRef(({className:a,...s},e)=>{const{error:n,formItemId:i}=as();return t.jsx(ce,{ref:e,className:g(n&&"text-destructive",a),htmlFor:i,...s})});K.displayName="FormLabel";const F=d.forwardRef(({...a},s)=>{const{error:e,formItemId:n,formDescriptionId:i,formMessageId:o}=as();return t.jsx(tn,{ref:s,id:n,"aria-describedby":e?"".concat(i," ").concat(o):"".concat(i),"aria-invalid":!!e,...a})});F.displayName="FormControl";const ct=d.forwardRef(({className:a,...s},e)=>{const{formDescriptionId:n}=as();return t.jsx("p",{ref:e,id:n,className:g("text-[0.8rem] text-muted-foreground",a),...s})});ct.displayName="FormDescription";const Y=d.forwardRef(({className:a,children:s,...e},n)=>{const{error:i,formMessageId:o}=as(),r=i?String(i==null?void 0:i.message):s;return r?t.jsx("p",{ref:n,id:o,className:g("text-[0.8rem] font-medium text-destructive",a),...e,children:r}):null});Y.displayName="FormMessage";const M=d.forwardRef(({className:a,type:s,...e},n)=>t.jsx("input",{type:s,className:g("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",a),ref:n,...e}));M.displayName="Input";const ta=oe("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),V=d.forwardRef(({className:a,variant:s,size:e,asChild:n=!1,...i},o)=>{const r=n?tn:"button";return t.jsx(r,{className:g(ta({variant:s,size:e,className:a})),ref:o,...i})});V.displayName="Button";const jh=sn({templateName:an().min(1,"模板名称不能为空")});function wh({isOpen:a,sceneName:s,onClose:e}){const n=R(l=>l.editor),i=qe({resolver:et(jh),defaultValues:{templateName:""}}),o=l=>{l||e()},r=async l=>{await Bt.add({name:l.templateName,type:"",content:JSON.stringify(n.cloneSceneByName(s))}),e(),i.reset()};return t.jsx(Ne,{open:a,onOpenChange:o,children:t.jsxs(me,{children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"保存为模板"}),t.jsx(xe,{})]}),t.jsx(at,{...i,children:t.jsxs("form",{onSubmit:i.handleSubmit(r),className:"space-y-8",children:[t.jsx(D,{control:i.control,name:"templateName",render:({field:l})=>t.jsxs(I,{children:[t.jsx(K,{children:"模板名称"}),t.jsx(F,{children:t.jsx(M,{placeholder:"输入模板名称",...l})}),t.jsx(Y,{})]})}),t.jsxs("div",{className:"flex justify-end space-x-4",children:[t.jsx(V,{type:"button",variant:"outline",onClick:e,children:"取消"}),t.jsx(V,{type:"submit",children:"保存"})]})]})})]})})}function Nh({isOpen:a,onClose:s}){const e=vt(()=>Bt.reverse().toArray()),n=async o=>{await Bt.delete(o)},i=o=>{o||s()};return t.jsx(Ne,{open:a,onOpenChange:i,children:t.jsxs(me,{className:"max-h-[80vh] overflow-auto",children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"模板列表"}),t.jsx(xe,{})]}),t.jsxs($t,{children:[t.jsx(qt,{children:t.jsxs(Ie,{children:[t.jsx(Fe,{children:"模板名称"}),t.jsx(Fe,{className:"w-[100px]",children:"操作"})]})}),t.jsx(es,{children:e==null?void 0:e.map(o=>t.jsxs(Ie,{children:[t.jsx(Ke,{children:o.name}),t.jsx(Ke,{children:t.jsxs(V,{variant:"ghost",size:"icon",onClick:()=>n(o.id),children:[t.jsx(Z.delete,{className:"h-4 w-4"}),t.jsx("span",{className:"sr-only",children:"删除"})]})})]},o.id))})]})]})})}const sa=d.forwardRef(({className:a,value:s,...e},n)=>t.jsx(nn,{ref:n,className:g("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",a),...e,children:t.jsx(ul,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:"translateX(-".concat(100-(s||0),"%)")}})}));sa.displayName=nn.displayName;function Ch({progress:a,url:s,isOpen:e,onClose:n}){const i=R(l=>l.project),o=l=>{l||n()},r=()=>{zn(i.name,s)};return t.jsx(Ne,{open:e,onOpenChange:o,children:t.jsxs(me,{className:"min-w-[80vw]",onPointerDownOutside:l=>l.preventDefault(),children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"导出"}),t.jsx(xe,{})]}),!s&&t.jsx(sa,{value:a.value}),s&&t.jsx("video",{src:s,className:"w-full aspect-[16/9]",controls:!0}),t.jsx(ea,{children:s&&t.jsxs(V,{onClick:r,children:[t.jsx(Z.download,{className:"size-4 mr-1"}),"保存视频"]})})]})})}const Zh=d.forwardRef(({progress:a,isOpen:s,onReplay:e,onClose:n,onExport:i},o)=>{const r=d.useRef(null);d.useImperativeHandle(o,()=>({getPreviewCanvas:()=>r.current}));const l=c=>{c||n()};return t.jsx(Ne,{open:s,onOpenChange:l,children:t.jsxs(me,{className:"min-w-[80vw]",onPointerDownOutside:c=>c.preventDefault(),children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"预览"}),t.jsx(xe,{}),t.jsx("canvas",{ref:r,className:"w-full aspect-[16/9]"}),t.jsx(sa,{value:a.value,className:"mt-2"})]}),t.jsxs(ea,{children:[t.jsx(V,{variant:"ghost",onClick:e,children:t.jsx(Z.refresh,{className:"size-5"})}),t.jsxs(V,{onClick:i,children:[t.jsx(Z.download,{className:"size-4 mr-1"}),"导出视频"]})]})]})})}),kh=1,Gh=1e6;let vs=0;function Th(){return vs=(vs+1)%Number.MAX_SAFE_INTEGER,vs.toString()}const Ss=new Map,wa=a=>{if(Ss.has(a))return;const s=setTimeout(()=>{Ss.delete(a),ht({type:"REMOVE_TOAST",toastId:a})},Gh);Ss.set(a,s)},Vh=(a,s)=>{switch(s.type){case"ADD_TOAST":return{...a,toasts:[s.toast,...a.toasts].slice(0,kh)};case"UPDATE_TOAST":return{...a,toasts:a.toasts.map(e=>e.id===s.toast.id?{...e,...s.toast}:e)};case"DISMISS_TOAST":{const{toastId:e}=s;return e?wa(e):a.toasts.forEach(n=>{wa(n.id)}),{...a,toasts:a.toasts.map(n=>n.id===e||e===void 0?{...n,open:!1}:n)}}case"REMOVE_TOAST":return s.toastId===void 0?{...a,toasts:[]}:{...a,toasts:a.toasts.filter(e=>e.id!==s.toastId)}}},Ft=[];let Kt={toasts:[]};function ht(a){Kt=Vh(Kt,a),Ft.forEach(s=>{s(Kt)})}function Rh({...a}){const s=Th(),e=i=>ht({type:"UPDATE_TOAST",toast:{...i,id:s}}),n=()=>ht({type:"DISMISS_TOAST",toastId:s});return ht({type:"ADD_TOAST",toast:{...a,id:s,open:!0,onOpenChange:i=>{i||n()}}}),{id:s,dismiss:n,update:e}}function ns(){const[a,s]=d.useState(Kt);return d.useEffect(()=>(Ft.push(s),()=>{const e=Ft.indexOf(s);e>-1&&Ft.splice(e,1)}),[a]),{...a,toast:Rh,dismiss:e=>ht({type:"DISMISS_TOAST",toastId:e})}}const Wh=sn({projectName:an().min(1,"作品名称不能为空")});function Lh({isOpen:a,onClose:s}){const e=R(c=>c.editor),n=R(c=>c.setProject),{toast:i}=ns(),o=qe({resolver:et(Wh),defaultValues:{projectName:""}}),r=c=>{c||s()},l=async c=>{const u={name:c.projectName,content:"",time:Date.now()},h=await We.add(u);e.clear(),n({id:h,...u}),s(),o.reset(),i({title:"新作品创建成功!",description:"可以开始添加场景了～",duration:1e3})};return t.jsx(Ne,{open:a,onOpenChange:r,children:t.jsxs(me,{children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"创建新作品"}),t.jsx(xe,{})]}),t.jsx(at,{...o,children:t.jsxs("form",{onSubmit:o.handleSubmit(l),className:"space-y-8",children:[t.jsx(D,{control:o.control,name:"projectName",render:({field:c})=>t.jsxs(I,{children:[t.jsx(K,{children:"作品名称"}),t.jsx(F,{children:t.jsx(M,{placeholder:"输入作品名称",...c})}),t.jsx(Y,{})]})}),t.jsxs("div",{className:"flex justify-end space-x-4",children:[t.jsx(V,{type:"button",variant:"outline",onClick:s,children:"取消"}),t.jsx(V,{type:"submit",children:"创建"})]})]})})]})})}function Xh({isOpen:a,onClose:s}){const e=R(h=>h.editor),n=R(h=>h.setProject),i=vt(()=>We.reverse().toArray()),o=d.useRef(!1),r=h=>{h||s()},l=async h=>{if(o.current)return;o.current=!0;const m=await We.get(h);e.clear(),m.content&&(await e.loadFromJSON(m.content),e.setActiveSceneByIndex(0)),n(m),s(),setTimeout(()=>{o.current=!1},100)},c=async h=>{await We.delete(h)},u=async h=>{const m=await We.get(h);await We.add({name:"".concat(m.name," - 副本"),content:m.content,time:Date.now()})};return t.jsx(Ne,{open:a,onOpenChange:r,children:t.jsxs(me,{className:"max-h-[80vh] overflow-auto",children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"作品列表"}),t.jsx(xe,{})]}),t.jsxs($t,{children:[t.jsx(qt,{children:t.jsxs(Ie,{children:[t.jsx(Fe,{children:"作品名称"}),t.jsx(Fe,{className:"w-[80px]",children:"操作"})]})}),t.jsx(es,{children:i==null?void 0:i.map(h=>t.jsxs(Ie,{children:[t.jsx(Ke,{onClick:()=>l(h.id),children:t.jsx("span",{className:"cursor-pointer",children:h.name})}),t.jsxs(Ke,{className:"flex gap-2",children:[t.jsx(Z.copy,{className:"h-4 w-4 cursor-pointer",onClick:()=>u(h.id)}),t.jsx(Z.delete,{className:"h-4 w-4 cursor-pointer",onClick:()=>c(h.id)})]})]},h.id))})]})]})})}const Ih=pl,Fh=ml,hi=d.forwardRef(({className:a,...s},e)=>t.jsx(on,{className:g("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...s,ref:e}));hi.displayName=on.displayName;const ui=d.forwardRef(({className:a,...s},e)=>t.jsxs(Fh,{children:[t.jsx(hi,{}),t.jsx(rn,{ref:e,className:g("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...s})]}));ui.displayName=rn.displayName;const mi=({className:a,...s})=>t.jsx("div",{className:g("flex flex-col space-y-2 text-center sm:text-left",a),...s});mi.displayName="AlertDialogHeader";const pi=({className:a,...s})=>t.jsx("div",{className:g("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...s});pi.displayName="AlertDialogFooter";const fi=d.forwardRef(({className:a,...s},e)=>t.jsx(ln,{ref:e,className:g("text-lg font-semibold",a),...s}));fi.displayName=ln.displayName;const xi=d.forwardRef(({className:a,...s},e)=>t.jsx(cn,{ref:e,className:g("text-sm text-muted-foreground",a),...s}));xi.displayName=cn.displayName;const gi=d.forwardRef(({className:a,...s},e)=>t.jsx(dn,{ref:e,className:g(ta(),a),...s}));gi.displayName=dn.displayName;const bi=d.forwardRef(({className:a,...s},e)=>t.jsx(hn,{ref:e,className:g(ta({variant:"outline"}),"mt-2 sm:mt-0",a),...s}));bi.displayName=hn.displayName;function Kh({isOpen:a,onConfirm:s,onClose:e}){const n=o=>{o||e()},i=()=>{s(),e()};return t.jsx(Ih,{open:a,onOpenChange:n,children:t.jsxs(ui,{children:[t.jsxs(mi,{children:[t.jsx(fi,{children:"确认清空素材库？"}),t.jsx(xi,{})]}),t.jsxs(pi,{children:[t.jsx(bi,{children:"取消"}),t.jsx(gi,{onClick:i,children:"确认"})]})]})})}const aa=fl,is=d.forwardRef(({className:a,...s},e)=>t.jsx(un,{ref:e,className:g("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",a),...s}));is.displayName=un.displayName;const Xe=d.forwardRef(({className:a,...s},e)=>t.jsx(mn,{ref:e,className:g("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",a),...s}));Xe.displayName=mn.displayName;const Oe=d.forwardRef(({className:a,...s},e)=>t.jsx(pn,{ref:e,className:g("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...s}));Oe.displayName=pn.displayName;const Zs=d.forwardRef(({className:a,...s},e)=>t.jsx("textarea",{className:g("flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",a),ref:e,...s}));Zs.displayName="Textarea";function zh({isOpen:a,onClose:s,onConfirm:e}){const n=r=>{r||s()},[i,o]=d.useState("");return d.useEffect(()=>{a&&o("")},[a]),t.jsx(Ne,{open:a,onOpenChange:n,children:t.jsxs(me,{className:"min-w-[60vw]",onPointerDownOutside:r=>r.preventDefault(),children:[t.jsxs(pe,{children:[t.jsxs(fe,{className:"flex items-center gap-2",children:[t.jsx(Z.sparkles,{className:"size-5"}),"智能剧本"]}),t.jsx(xe,{})]}),t.jsxs(aa,{defaultValue:"convert",onValueChange:()=>o(""),children:[t.jsxs(is,{className:"grid w-full grid-cols-2",children:[t.jsx(Xe,{value:"convert",children:"转换剧本"}),t.jsx(Xe,{value:"generate",children:"生成剧本"})]}),t.jsx(Oe,{value:"convert",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx(Zs,{placeholder:"请在此处输入您的小说、故事内容",rows:12,value:i,onChange:r=>o(r.target.value)}),t.jsx("div",{className:"flex justify-center",children:t.jsxs(V,{onClick:()=>e("convert",i),children:[t.jsx(Z.wandSparkles,{className:"size-4 mr-1"}),"一键转换"]})})]})}),t.jsx(Oe,{value:"generate",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx(Zs,{placeholder:"请输入您的故事剧情大纲",rows:12,value:i,onChange:r=>o(r.target.value)}),t.jsx("div",{className:"flex justify-center",children:t.jsxs(V,{onClick:()=>e("generate",i),children:[t.jsx(Z.wandSparkles,{className:"size-4 mr-1"}),"一键生成"]})})]})})]})]})})}async function yi(){const a=(await va(C.Character)).join("、"),s=(await va(C.Background)).join("、");return{characters:a,backgrounds:s}}async function vi(a,s){var u,h,m;const e=new URLSearchParams(window.location.search),n=e.get("key"),i=e.get("model"),o=(u=e.get("platform"))!=null?u:"ark";let c=(m=(h=(await new xl({apiKey:n,baseURL:"".concat(location.origin,"/api/").concat(o),dangerouslyAllowBrowser:!0}).chat.completions.create({messages:[{role:"system",content:a},{role:"user",content:s}],model:i})).choices[0])==null?void 0:h.message)==null?void 0:m.content;return console.log(c),c&&(c=c.replace(/^```[\r\n]?|```[\r\n]?$/g,"")),c}async function Dh(a,s){const{characters:e,backgrounds:n}=await yi(),i="请你扮演一位专业的视觉小说剧本作家，将我提供的故事原文改编为符合视觉小说格式的剧本。改编时请注意以下几点要求：\n\n1. 角色名：所有角色名必须使用中文，不得使用任何其他语言或符号。请确保所有角色名只能是以下列表中的名字：".concat(e,"。不要使用其他名字。\n2. 场景：请确保所有场景只能是在以下列表中的：").concat(n,"。不要使用其他场景。\n3. 内容结构：剧本内容必须包括详细的场景描述、旁白以及角色台词，且必须严格遵循以下的输出格式：\n```\n场景\n{场景名称}\n\n旁白\n{详细的旁白内容，尽可能营造氛围并推动剧情发展。}\n\n{角色名}\n{角色的台词内容，需符合角色的性格与当前情景。}\n\n```\n4. 格式规范：输出格式必须与示例完全一致，不得增加或减少任何多余的符号、空行或内容。\n5. 语言风格：剧本语言需具有叙事性和文学性，旁白需渲染场景氛围，台词需贴合角色个性。\n\n以下是输出格式示例：\n示例：\n```\n场景\n密室\n\n旁白\n旁白内容\n\n男主\n男主的台词\n\n女主\n女主的台词\n```\n请根据以上要求，将以下故事原文改编为视觉小说剧本："),o="故事原文：".concat(a),r=await vi(i,o);return qs(r,s,!0)}async function Yh(a,s){const{characters:e,backgrounds:n}=await yi(),i="请你扮演一位专业的视觉小说剧本作家，根据我提供的剧情大纲创作视觉小说剧本。创作时请注意以下几点要求：\n\n1. 角色名：所有角色名必须使用中文，不得使用任何其他语言或符号。请确保所有角色名只能是以下列表中的名字：".concat(e,"。不要使用其他名字。\n2. 场景：请确保所有场景只能是在以下列表中的：").concat(n,"。不要使用其他场景。\n3. 内容结构：剧本内容必须包括详细的场景描述、旁白以及角色台词，且必须严格遵循以下的输出格式：\n```\n场景\n{场景名称}\n\n旁白\n{详细的旁白内容，尽可能营造氛围并推动剧情发展。}\n\n{角色名}\n{角色的台词内容，需符合角色的性格与当前情景。}\n\n```\n4. 格式规范：输出格式必须与示例完全一致，不得增加或减少任何多余的符号、空行或内容。\n5. 语言风格：剧本语言需具有叙事性和文学性，旁白需渲染场景氛围，台词需贴合角色个性。\n\n以下是输出格式示例：\n示例：\n```\n场景\n密室\n\n旁白\n旁白内容\n\n男主\n男主的台词\n\n女主\n女主的台词\n```\n请根据以上要求，按照以下剧情大纲创作视觉小说剧本："),o="剧情大纲是：".concat(a),r=await vi(i,o);return qs(r,s,!0)}function Hh(){const a=At(i=>i.setOpen),s=At(i=>i.setLoadingText);return{showLoading:i=>{a(!0),s(i)},hideLoading:()=>{a(!1),s("")}}}function Mh(){const a=R(N=>N.initEditor),s=R(N=>N.project),e=R(N=>N.editor),n=R(N=>N.activeScene),i=R(N=>N.scenes),{selectAsset:o}=Gt(),r=d.useRef(null),l=d.useRef(null),{defaultTemplates:c,customTemplates:u,handleAddDefaultTemplate:h,handleAddCustomTemplate:m}=ni(),[f,x]=d.useState(!1),[b,T]=d.useState(!1),[G,v]=d.useState(!1),[S,k]=d.useState(!1),[W,X]=d.useState(!1),[A,B]=d.useState(!1),[$,w]=d.useState(!1),L=d.useRef(null),[re,nt]=d.useState([]),[ls,cs]=d.useState(null),se=d.useRef(null),[ha,ds]=d.useState({value:0,currentTime:0,duration:0}),Me=d.useRef(0),[ua,Mi]=d.useState(""),{toast:ae}=ns(),{showLoading:Vt,hideLoading:Rt}=Hh(),Pi=async()=>{try{await Pd()}catch(N){ae({title:"导出作品失败！",description:N.message,variant:"destructive"})}},Ui=async()=>{Vt("作品导入中");try{await Ud()}catch(N){ae({title:"导入作品失败！",description:N.message,variant:"destructive"})}finally{Rt()}},Ai=(N,z,P)=>{if(N>=100){ds({value:N,currentTime:z,duration:P}),Me.current&&clearTimeout(Me.current),Me.current=0;return}Me.current||(Me.current=setTimeout(()=>{ds({value:N,currentTime:z,duration:P}),Me.current=0},1e3/30))},ma=()=>{ds({value:0,currentTime:0,duration:0})},hs=()=>{const N=r.current,z=l.current;if(N&&z){const P=N.clientWidth,Re=N.clientHeight,Ce=16/9;let Xt=P,ps=P/Ce;ps>Re&&(ps=Re,Xt=Re*Ce),z.style.width="".concat(Xt,"px"),z.style.height="".concat(ps,"px")}},us=d.useCallback(async N=>{try{const z=new Date;await We.update(s.id,{content:e.saveAsJSON(),time:z.getTime()}),Mi(z.toLocaleString()),N||ae({title:"保存成功！",duration:1500})}catch(z){ae({title:"保存失败！",description:z.message,variant:"destructive"})}},[ae,e,s]),ms=N=>async()=>{const z=await o(N);if(z){const P=await gt(z,e);e.addChild(P)}},Bi=()=>{const N=mh(e);e.addChild(N)},Wt=async(N=0,z)=>{ma(),nt([N,z]),X(!0);const P=await e.exportScreenplay(N,z),Re=new gd({canvas:L.current.getPreviewCanvas(),width:1920,height:1080,fps:30,disableAudio:ja()});se.current.connect(Re),se.current.action(P).then(()=>{console.log("预览完成")}).catch(Ce=>{X(!1),ae({title:"预览失败！",description:Ce.message,variant:"destructive"})})},Ei=async()=>{se.current.hasStarted()&&await se.current.cut(),Wt(...re)},Lt=async(N=0,z)=>{ma(),k(!0),cs(null);const P=await e.exportScreenplay(N,z),Re=new xd({width:1920,height:1080,fps:30,disableAudio:ja()});se.current.connect(Re),se.current.action(P).then(Ce=>{const Xt=URL.createObjectURL(Ce);cs(Xt)}).catch(Ce=>{k(!1),ae({title:"导出失败！",description:Ce.message,variant:"destructive"})})},Oi=()=>{k(!1),se.current.hasStarted()&&se.current.cut(),ls&&URL.revokeObjectURL(ls),cs(null)},Ji=()=>{X(!1),se.current.hasStarted()&&se.current.cut()},Qi=()=>{X(!1),Lt(...re)},_i=async()=>{const z=(await Dn({accept:".txt"}))[0];Vt("剧本导入中");try{const P=await Nc(z);await qs(P,e)}catch(P){ae({title:"导入失败！",description:P.message,variant:"destructive"})}finally{Rt()}},$i=async(N,z)=>{w(!1),Vt(N==="convert"?"智能转换中":"智能生成中");try{N==="convert"?await Dh(z,e):await Yh(z,e)}catch(P){ae({title:"".concat(N==="convert"?"转换":"生成","失败！"),description:P.message,variant:"destructive"})}finally{Rt()}},qi=async()=>{Vt("素材导入中");try{await Yd()}catch(N){ae({title:"导入失败！",description:N.message,variant:"destructive"})}finally{Rt()}},eo=async()=>{await Hd(),ae({title:"清空成功！",duration:1500})};return d.useEffect(()=>{if(s){const N=setInterval(async()=>{us(!0)},6e4);return()=>{clearInterval(N)}}},[s,us]),d.useEffect(()=>(window.addEventListener("resize",hs),hs(),a(l.current),se.current=new Ns({onProgress(N,z,P){Ai(N,z,P)}}),l.current.onselectstart=function(){return!1},()=>{window.removeEventListener("resize",hs)}),[a]),t.jsxs("div",{className:"flex flex-col gap-2 flex-1",children:[t.jsxs(ri,{children:[t.jsxs(it,{children:[t.jsxs(Ue,{className:"data-[disabled]:text-gray-400",children:[t.jsx(Z.library,{className:"size-4 mr-0.5"}),"作品"]}),t.jsxs(Ae,{children:[t.jsx(H,{onClick:()=>x(!0),children:"创建新作品"}),t.jsx(H,{onClick:()=>T(!0),children:"打开..."}),t.jsx(H,{disabled:!s,onClick:()=>us(),children:"保存"}),ua&&t.jsxs(H,{className:"text-muted-foreground",children:["自动保存于",ua]}),t.jsx(Be,{}),t.jsx(H,{onClick:Pi,children:"导出..."}),t.jsx(H,{onClick:Ui,children:"导入..."})]})]}),t.jsxs(it,{children:[t.jsxs(Ue,{className:"data-[disabled]:text-gray-400",disabled:!s,children:[t.jsx(Z.scene,{className:"size-4 mr-0.5"}),"场景"]}),t.jsxs(Ae,{children:[c.map(N=>t.jsxs(H,{onClick:h(N.content),children:["新建",N.name]},N.name)),u.length>0&&t.jsx(Be,{}),u.map(N=>t.jsxs(H,{onClick:()=>m(N.content),children:["新建",N.name]},N.id)),t.jsx(Be,{}),t.jsx(H,{onClick:_i,children:"导入剧本..."}),location.search.includes("key=")&&t.jsx(H,{onClick:()=>w(!0),children:"智能剧本..."}),t.jsx(Be,{}),t.jsx(H,{onClick:()=>v(!0),children:"管理模版..."})]})]}),t.jsxs(it,{children:[t.jsxs(Ue,{className:"data-[disabled]:text-gray-400",disabled:!s,children:[t.jsx(Z.images,{className:"size-4 mr-0.5"}),"素材"]}),t.jsxs(Ae,{children:[t.jsx(H,{disabled:!n,onClick:ms(C.Character),children:"添加角色"}),t.jsx(H,{disabled:!n,onClick:ms(C.Background),children:"添加背景"}),t.jsx(H,{disabled:!n,onClick:ms(C.Thing),children:"添加物品"}),t.jsx(H,{disabled:!n,onClick:Bi,children:"添加文字"}),t.jsx(Be,{}),t.jsx(H,{onClick:qi,children:"导入素材库..."}),t.jsx(H,{onClick:()=>o(void 0,!0),children:"管理素材库..."}),t.jsx(H,{className:"text-destructive",onClick:()=>B(!0),children:"清空素材库"})]})]}),t.jsxs(it,{children:[t.jsxs(Ue,{disabled:i.length===0,className:"data-[disabled]:text-gray-400",children:[t.jsx(Z.preview,{className:"size-4 mr-0.5"}),"预览"]}),t.jsxs(Ae,{children:[t.jsx(H,{disabled:!n,onClick:()=>{const N=e.getActiveSceneIndex();Wt(N,N+1)},children:"仅预览当前场景"}),t.jsx(H,{disabled:!n,onClick:()=>Wt(e.getActiveSceneIndex()),children:"从当前场景开始预览"}),t.jsx(H,{onClick:()=>Wt(),children:"预览全部场景"})]})]}),t.jsxs(it,{children:[t.jsxs(Ue,{disabled:i.length===0,className:"data-[disabled]:text-gray-400",children:[t.jsx(Z.download,{className:"size-4 mr-0.5"}),"导出"]}),t.jsxs(Ae,{children:[t.jsx(H,{disabled:!n,onClick:()=>{const N=e.getActiveSceneIndex();Lt(N,N+1)},children:"仅导出当前场景"}),t.jsx(H,{disabled:!n,onClick:()=>Lt(e.getActiveSceneIndex()),children:"从当前场景开始导出"}),t.jsx(H,{onClick:()=>Lt(),children:"导出全部场景"})]})]})]}),t.jsx(He,{className:"flex-1 rounded-md relative",children:t.jsx(Ve,{className:"relative h-full p-2",children:t.jsx("div",{className:"w-full h-full flex justify-center items-center",ref:r,children:t.jsx("canvas",{className:"shadow border border-b",ref:l})})})}),t.jsx(Xh,{isOpen:b,onClose:()=>T(!1)}),t.jsx(Nh,{isOpen:G,onClose:()=>v(!1)}),t.jsx(Ch,{progress:ha,url:ls,isOpen:S,onClose:Oi}),t.jsx(Zh,{progress:ha,ref:L,isOpen:W,onReplay:Ei,onClose:Ji,onExport:Qi}),t.jsx(Lh,{isOpen:f,onClose:()=>x(!1)}),t.jsx(Kh,{isOpen:A,onConfirm:eo,onClose:()=>B(!1)}),t.jsx(zh,{isOpen:$,onClose:()=>w(!1),onConfirm:$i})]})}function Ph(){const a=R(c=>c.editor),s=R(c=>c.activeChild),e=R(c=>c.activeScene),n=d.useMemo(()=>{if(!e)return[];const c=[],u=[],h=[],m=[],f=e.sounds;for(const x of e.children)x.assetType===C.Character?c.push(x):x.assetType===C.Background?h.push(x):x.assetType===C.Thing?u.push(x):x.name&&m.push(x);return[{label:"角色",children:c},{label:"物品",children:u},{label:"背景",children:h},{label:"其他",children:m},{label:"音频",children:f}]},[e]),i=c=>{c.assetType!==C.Audio&&a.setActiveChildByName(c.name)},o=c=>{if(c.assetType===C.Audio){a.removeSoundByName(c.name);return}a.removeChildByName(c.name),(s==null?void 0:s.name)===c.name&&a.setActiveChild(void 0)},r=c=>{a.toggleChildVisibleByName(c.name)},l=c=>{a.toggleChildInteractiveByName(c.name)};return t.jsx(we,{className:"h-full pr-2",children:t.jsx("div",{className:"space-y-4",children:n.map(c=>c.children.length>0&&t.jsxs("fieldset",{className:"rounded-md border p-2",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:c.label}),t.jsx("div",{className:"flex flex-col gap-1",children:c.children.map(u=>t.jsx("div",{className:"text-sm p-1 px-2 border rounded ".concat((s==null?void 0:s.name)===u.name?"bg-muted":""),children:t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("div",{onClick:()=>i(u),className:"cursor-pointer flex-1",children:u.label}),t.jsxs("div",{className:"flex space-x-2 items-center",children:[u.assetType!==C.Audio&&t.jsxs(t.Fragment,{children:[u.visible?t.jsx(Z.viewing,{onClick:()=>r(u),className:"size-4 cursor-pointer"}):t.jsx(Z.viewingOff,{onClick:()=>r(u),className:"size-4 cursor-pointer"}),u.interactive?t.jsx(Z.lockOpen,{onClick:()=>l(u),className:"size-4 cursor-pointer"}):t.jsx(Z.lock,{onClick:()=>l(u),className:"size-4 cursor-pointer"})]}),t.jsx(Z.trash2,{onClick:()=>o(u),className:"size-4 cursor-pointer hover:text-destructive"})]})]})},u.name))})]},c.label))})})}const os=d.forwardRef(({className:a,...s},e)=>t.jsxs(fn,{ref:e,className:g("relative flex w-full touch-none select-none items-center",a),...s,children:[t.jsx(gl,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:t.jsx(bl,{className:"absolute h-full bg-primary"})}),t.jsx(yl,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));os.displayName=fn.displayName;function Uh(){const a=R(i=>i.editor),s=R(i=>i.activeChild),e=(i,o)=>r=>{a.updateActiveChild(l=>{o==="number"?l[i]=Number(r.target.value):l[i]=r.target.value})},n=i=>o=>{a.updateActiveChild(r=>{r[i]=o})};return t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(ce,{className:"w-5",children:"宽"}),t.jsx(M,{value:s.width.toFixed(0),onChange:e("width","number"),type:"number",min:0,step:10,className:"h-6"})]}),t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(ce,{className:"w-5",children:"高"}),t.jsx(M,{value:s.height.toFixed(0),onChange:e("height","number"),type:"number",min:0,step:10,className:"h-6"})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(ce,{className:"w-5",children:"X"}),t.jsx(M,{value:s.x.toFixed(0),onChange:e("x","number"),type:"number",min:0,step:10,className:"h-6"})]}),t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(ce,{className:"w-5",children:"Y"}),t.jsx(M,{value:s.y.toFixed(0),onChange:e("y","number"),type:"number",min:0,step:10,className:"h-6"})]})]}),t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(ce,{className:"flex-shrink-0 mr-2",children:"透明度"}),t.jsx(os,{min:0,max:1,step:.1,value:[s.alpha],onValueChange:i=>n("alpha")(i[0])})]})]})}const ve=Gl,na=Tl,Se=Vl,he=d.forwardRef(({className:a,children:s,...e},n)=>t.jsxs(xn,{ref:n,className:g("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),"data-disable-click-outside":!0,...e,children:[s,t.jsx(vl,{asChild:!0,children:t.jsx(Sl,{"data-disable-click-outside":!0,className:"h-4 w-4 opacity-50"})})]}));he.displayName=xn.displayName;const Si=d.forwardRef(({className:a,...s},e)=>t.jsx(gn,{ref:e,className:g("flex cursor-default items-center justify-center py-1",a),"data-disable-click-outside":!0,...s,children:t.jsx(jl,{})}));Si.displayName=gn.displayName;const ji=d.forwardRef(({className:a,...s},e)=>t.jsx(bn,{ref:e,className:g("flex cursor-default items-center justify-center py-1",a),"data-disable-click-outside":!0,...s,children:t.jsx(wl,{})}));ji.displayName=bn.displayName;const ue=d.forwardRef(({className:a,children:s,position:e="popper",...n},i)=>t.jsx(Nl,{children:t.jsxs(yn,{ref:i,className:g("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:e,"data-disable-click-outside":!0,...n,children:[t.jsx(Si,{}),t.jsx(Cl,{className:g("p-1",e==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),"data-disable-click-outside":!0,children:s}),t.jsx(ji,{})]})}));ue.displayName=yn.displayName;const rs=d.forwardRef(({className:a,...s},e)=>t.jsx(vn,{ref:e,className:g("px-2 py-1.5 text-sm font-semibold",a),...s,"data-disable-click-outside":!0}));rs.displayName=vn.displayName;const ee=d.forwardRef(({className:a,children:s,...e},n)=>t.jsxs(Sn,{ref:n,className:g("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),"data-disable-click-outside":!0,...e,children:[t.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center","data-disable-click-outside":!0,children:t.jsx(Zl,{children:t.jsx(zs,{className:"h-4 w-4"})})}),t.jsx(kl,{"data-disable-click-outside":!0,children:s})]}));ee.displayName=Sn.displayName;const Ah=d.forwardRef(({className:a,...s},e)=>t.jsx(jn,{ref:e,className:g("-mx-1 my-1 h-px bg-muted",a),"data-disable-click-outside":!0,...s}));Ah.displayName=jn.displayName;const Et=Rl,Ot=Wl,bt=d.forwardRef(({className:a,align:s="center",sideOffset:e=4,...n},i)=>t.jsx(wn,{children:t.jsx(Ms,{ref:i,align:s,sideOffset:e,className:g("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...n})}));bt.displayName=Ms.displayName;function Bh(a){const s=d.useRef(null);return d.useEffect(()=>{a&&(typeof a=="function"?a(s.current):a.current=s.current)}),s}const ia=d.forwardRef(({disabled:a,value:s,onChange:e,onBlur:n,name:i,className:o,...r},l)=>{const c=Bh(l),[u,h]=d.useState(!1),m=d.useMemo(()=>s||"#FFFFFF",[s]);return t.jsxs(Et,{onOpenChange:h,open:u,children:[t.jsx(Ot,{asChild:!0,disabled:a,onBlur:n,children:t.jsx(V,{...r,className:g("block",o),name:i,onClick:()=>{h(!0)},size:"icon",style:{backgroundColor:m},variant:"outline",children:t.jsx("div",{})})}),t.jsxs(bt,{className:"w-full",children:[t.jsx(Ll,{color:m,onChange:e}),t.jsx(M,{className:"mt-2",maxLength:7,onChange:f=>{var x;e((x=f==null?void 0:f.currentTarget)==null?void 0:x.value)},ref:c,value:m})]})]})});ia.displayName="ColorPicker";const wi=oe("inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground"},size:{default:"h-9 px-3",sm:"h-8 px-2",lg:"h-10 px-3"}},defaultVariants:{variant:"default",size:"default"}}),Eh=d.forwardRef(({className:a,variant:s,size:e,...n},i)=>t.jsx(Nn,{ref:i,className:g(wi({variant:s,size:e,className:a})),...n}));Eh.displayName=Nn.displayName;const Ni=d.createContext({size:"default",variant:"default"}),Ci=d.forwardRef(({className:a,variant:s,size:e,children:n,...i},o)=>t.jsx(Cn,{ref:o,className:g("flex items-center justify-center gap-1",a),...i,children:t.jsx(Ni.Provider,{value:{variant:s,size:e},children:n})}));Ci.displayName=Cn.displayName;const ks=d.forwardRef(({className:a,children:s,variant:e,size:n,...i},o)=>{const r=d.useContext(Ni);return t.jsx(Zn,{ref:o,className:g(wi({variant:r.variant||e,size:r.size||n}),a),...i,children:s})});ks.displayName=Zn.displayName;function Oh(){const a=R(c=>c.editor),s=R(c=>c.activeChild),e=vt(()=>O.where("type").equals(C.Font).reverse().toArray()),n=d.useMemo(()=>{const c=[];if(!e)return c;for(const u of e)for(const h of u.states)c.push({ch:h.name,en:h.name});return c},[e]),i=(c,u)=>h=>{a.updateActiveChild(m=>{u==="number"?m[c]=Number(h.target.value):m[c]=h.target.value})},o=(c,u)=>h=>{a.updateActiveChild(m=>{u==="number"?m.style[c]=Number(h.target.value):m.style[c]=h.target.value})},r=c=>u=>{a.updateActiveChild(h=>{h.style[c]=u})},l=c=>{a.updateActiveChild(u=>{u.style.fontWeight=c.includes(rt.BOLD)?rt.BOLD:rt.NORMAL,u.style.fontStyle=c.includes(lt.ITALIC)?lt.ITALIC:lt.NORMAL})};return t.jsxs("div",{className:"flex flex-col gap-3",children:[!s.disableTextEdit&&t.jsx("div",{className:"flex gap-2",children:t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(Z.bookOpenText,{className:"w-5 h-5"}),t.jsx(M,{value:s.text,onChange:i("text")})]})}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(Z.color,{className:"w-5 h-5"}),t.jsx(ia,{value:s.style.fill,onChange:r("fill"),className:"w-6 h-6"})]}),t.jsx("div",{className:"flex-1 flex gap-1 items-center",children:t.jsxs(Ci,{type:"multiple",value:[s.style.fontWeight,s.style.fontStyle],onValueChange:l,children:[t.jsx(ks,{value:rt.BOLD,className:"p-2",children:t.jsx(Z.bold,{className:"size-4"})}),t.jsx(ks,{value:lt.ITALIC,className:"p-2",children:t.jsx(Z.italic,{className:"size-4"})})]})})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex-1 shrink-0 flex gap-1 items-center",children:[t.jsx(Z.type,{className:"w-5 h-5"}),t.jsxs(ve,{onValueChange:r("fontFamily"),value:s.style.fontFamily,children:[t.jsx(he,{className:"h-6 max-w-[150px]",children:t.jsx(Se,{placeholder:"---"})}),t.jsx(ue,{children:[...n,...Kd].map(c=>t.jsx(ee,{value:c.en,children:c.ch},c.en))})]})]}),t.jsxs("div",{className:"flex-1 shrink-0 flex gap-1 items-center",children:[t.jsx(Z.fontSize,{className:"w-5 h-5"}),t.jsx(M,{value:String(s.style.fontSize),onChange:o("fontSize","number"),type:"number",min:1,step:10,className:"h-6"})]})]})]})}function Jh(){const a=R(o=>o.editor),s=R(o=>o.activeChild),{selectAsset:e}=Gt(),n=o=>{a.updateActiveChild(r=>{const l=r.width,c=r.height;r.fillColor=o,r.clear().beginFill(o).drawRect(0,0,l,c).endFill()})},i=async()=>{const o=await e(C.Dialog),r=await gt(o,a);a.addChild(r),a.updateActiveScene(l=>{l.config.speak.dialogTargetName=r.name}),a.setActiveChildByName(r.name),a.removeChildByName(s.name)};return t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex-1 flex gap-1 items-center",children:[t.jsx(ce,{className:"flex-shrink-0 mr-2",children:"填充色"}),t.jsx(ia,{value:s.fillColor,onChange:n,className:"w-6 h-6"})]}),t.jsx(V,{size:"sm",onClick:i,children:"自定义对话框"})]})}function Qh(){const a=R(s=>s.activeChild);return t.jsx(we,{className:"h-full pr-2",children:a&&t.jsxs(t.Fragment,{children:[t.jsxs("fieldset",{className:"rounded-md border p-2",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:"基础属性"}),t.jsx(Uh,{})]}),a.type==="Text"&&t.jsxs("fieldset",{className:"rounded-md border p-2 mt-2",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:"文字属性"}),t.jsx(Oh,{})]}),a.type==="Graphics"&&t.jsxs("fieldset",{className:"rounded-md border p-2 mt-2",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:"对话框属性"}),t.jsx(Jh,{})]})]})})}const Zi=kn,ki=Gn,Gi=Tn,oa=d.forwardRef(({className:a,sideOffset:s=4,...e},n)=>t.jsx(Ps,{ref:n,sideOffset:s,className:g("z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...e}));oa.displayName=Ps.displayName;function _h(){const a=R(l=>l.editor),s=R(l=>l.activeChild),e=async()=>{const l=a.cloneChild();l.type==="Sprite"&&await l.load(),l.x+=l.width*.1,l.y+=l.height*.1,a.addChild(l),a.setActiveChildByName(l.name)},n=()=>{a.activeChild&&a.removeChildByName(a.activeChild.name),a.setActiveChild(void 0)},i=l=>()=>{switch(l){case"top":a.moveChildToTop();break;case"bottom":a.moveChildToBottom();break;case"up":a.moveUpChild();break;case"down":a.moveDownChild();break}},o=l=>()=>{a.setChildPosition(l)},r=()=>{const l=a.activeScene.getChildrenByAssetType(C.Character),c=l.length;let u=1;for(const h of l)h.x=a.options.width/(c+1)*u-h.width/2,h.y=a.options.height-h.height,u++};return t.jsx(we,{className:"h-full pr-2",children:s&&t.jsxs("div",{children:[t.jsxs("fieldset",{className:"rounded-md border p-1",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:"层级"}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsx(V,{size:"sm",variant:"ghost",onClick:i("top"),children:"置顶"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:i("up"),children:"上移"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:i("down"),children:"下移"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:i("bottom"),children:"置底"})]}),t.jsxs("div",{children:[t.jsx(V,{size:"sm",variant:"ghost",onClick:e,children:t.jsx(Z.copy,{className:"size-4"})}),t.jsx(V,{size:"sm",variant:"ghost",onClick:n,children:t.jsx(Z.delete,{className:"size-4"})})]})]})]}),t.jsxs("fieldset",{className:"rounded-md border p-1 mt-2",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:"水平位置"}),t.jsxs("div",{className:"flex justify-between",children:[t.jsxs("div",{children:[t.jsx(V,{size:"sm",variant:"ghost",onClick:o("left"),children:"左"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("near-left"),children:"1/3"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("center"),children:"中"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("near-right"),children:"2/3"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("right"),children:"右"})]}),s.assetType===C.Character&&t.jsx(Zi,{children:t.jsxs(ki,{children:[t.jsx(Gi,{asChild:!0,children:t.jsx(V,{size:"sm",variant:"ghost",onClick:r,children:"自动"})}),t.jsx(oa,{children:t.jsx("p",{children:"根据角色人数，自动排列全部角色"})})]})})]})]}),t.jsxs("fieldset",{className:"rounded-md border p-1 mt-2",children:[t.jsx("legend",{className:"-ml-1 px-1 text-sm font-medium",children:"垂直位置"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("top"),children:"上"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("middle"),children:"中"}),t.jsx(V,{size:"sm",variant:"ghost",onClick:o("bottom"),children:"下"})]})]})})}function $h(){return t.jsx(He,{className:"flex-1 shrink-0 max-h-[50%] sm:max-h-full rounded-md",children:t.jsx(Ve,{className:"h-full p-2",children:t.jsxs(aa,{defaultValue:"position",className:"h-full flex flex-col",children:[t.jsxs(is,{className:"self-center",children:[t.jsx(Xe,{value:"position",children:"位置"}),t.jsx(Xe,{value:"style",children:"样式"}),t.jsx(Xe,{value:"list",children:"列表"})]}),t.jsx(Oe,{className:"h-[calc(100%-2.5rem)]",value:"position",children:t.jsx(_h,{})}),t.jsx(Oe,{className:"h-[calc(100%-2.5rem)]",value:"style",children:t.jsx(Qh,{})}),t.jsx(Oe,{className:"h-[calc(100%-2.5rem)]",value:"list",children:t.jsx(Ph,{})})]})})})}function qh(){const a=R(s=>s.project);return t.jsxs("header",{className:"sticky top-0 z-10 flex h-[53px] items-center justify-between gap-1 border-b bg-background px-4",children:[t.jsxs("h1",{className:"text-xl font-bold",children:["V N V E",a&&t.jsxs("span",{className:"text-xs text-muted-foreground",children:["【",a.name,"】"]})]}),t.jsx(Z.gitHub,{className:"size-5 cursor-pointer",onClick:()=>{window.location.href="https://github.com/vnve/vnve"}})]})}const eu=oe(J("relative overflow-x-auto whitespace-pre-wrap break-words","min-h-[80px] w-full rounded-md bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none","[&_[data-slate-placeholder]]:text-muted-foreground [&_[data-slate-placeholder]]:!opacity-100","[&_[data-slate-placeholder]]:top-[auto_!important]","[&_strong]:font-bold"),{defaultVariants:{focusRing:!0,size:"sm",variant:"outline"},variants:{disabled:{true:"cursor-not-allowed opacity-50"},focusRing:{false:"",true:"focus-visible:ring-1 focus-visible:ring-ring"},focused:{true:"ring-1 ring-ring"},size:{md:"text-base",sm:"text-sm"},variant:{ghost:"",outline:"border border-input"}}}),Ti=Te.forwardRef(({className:a,disabled:s,focusRing:e,focused:n,readOnly:i,size:o,variant:r,...l},c)=>t.jsx("div",{className:"relative w-full",ref:c,children:t.jsx(Xl,{"aria-disabled":s,className:J(eu({disabled:s,focusRing:e,focused:n,size:o,variant:r}),a),"data-plate-selectable":!0,disableDefaultStyles:!0,readOnly:s!=null?s:i,...l})}));Ti.displayName="Editor";const tu=oe("shrink-0 bg-border",{defaultVariants:{orientation:"horizontal"},variants:{orientation:{horizontal:"h-px w-full",vertical:"h-full w-px"}}}),su=_t(Us(Il,{decorative:!0,orientation:"horizontal"}),tu),au=kn,nu=Gn,iu=Tn,ou=Fl,ru=je(Us(Ps,{sideOffset:4}),"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md");function lu(a){return Te.forwardRef(function({tooltip:e,tooltipContentProps:n,tooltipProps:i,...o},r){const[l,c]=Te.useState(!1);Te.useEffect(()=>{c(!0)},[]);const u=t.jsx(a,{ref:r,...o});return e&&l?t.jsx(au,{children:t.jsxs(nu,{...i,children:[t.jsx(iu,{asChild:!0,children:u}),t.jsx(ou,{children:t.jsx(ru,{...n,children:e})})]})}):u})}const cu=je(zl,"relative flex select-none items-center gap-1 bg-background"),du=je(Dl,"flex items-center");je(Yl,"font-medium underline underline-offset-4");je(Hl,"my-1 w-px shrink-0 bg-border");const Gs=oe(J("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50","[&_svg:not([data-icon])]:size-5"),{defaultVariants:{size:"sm",variant:"default"},variants:{size:{default:"h-10 px-3",lg:"h-11 px-5",sm:"h-9 px-2"},variant:{default:"bg-transparent hover:bg-muted hover:text-muted-foreground aria-checked:bg-accent aria-checked:text-accent-foreground",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"}}}),Ee=lu(d.forwardRef(({children:a,className:s,isDropdown:e,pressed:n,size:i,variant:o,...r},l)=>typeof n=="boolean"?t.jsx(du,{disabled:r.disabled,type:"single",value:"single",children:t.jsx(hu,{className:J(Gs({size:i,variant:o}),e&&"my-1 justify-between pr-1",s),ref:l,value:n?"single":"",...r,children:e?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex flex-1",children:a}),t.jsx("div",{children:t.jsx(Z.arrowDown,{className:"ml-0.5 size-4","data-icon":!0})})]}):a})}):t.jsx(Kl,{className:J(Gs({size:i,variant:o}),e&&"pr-1",s),ref:l,...r,children:a})));Ee.displayName="ToolbarButton";const hu=_t(Ml,Gs,["variant","size"]),Na=Ye(({children:a,className:s,noSeparator:e},n)=>{const i=d.Children.map(a,o=>o);return!i||i.length===0?null:t.jsxs("div",{className:J("flex",s),ref:n,children:[!e&&t.jsx("div",{className:"h-full py-2",children:t.jsx(su,{orientation:"vertical"})}),t.jsx("div",{className:"mx-1 flex items-center gap-1",children:a})]})}),uu=je(cu,"supports-backdrop-blur:bg-background/60 z-40 w-full justify-between overflow-x-auto rounded-t-lg border-b border-b-border bg-background/95 backdrop-blur"),mu=Fa,pu=Ka;Ye(({children:a,className:s,inset:e,...n},i)=>t.jsxs(Ws,{className:J("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent","data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e&&"pl-8",s),ref:i,...n,children:[a,t.jsx(Z.chevronRight,{className:"ml-auto size-4"})]}));je(Ls,"z-50 min-w-32 overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2");const fu=Us(Is,{className:J("z-50 min-w-32 overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2"),sideOffset:4}),xu=Ye(({...a},s)=>t.jsx(Xs,{children:t.jsx(fu,{ref:s,...a})})),gu=oe(J("relative flex h-9 cursor-pointer select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors","focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50"),{variants:{inset:{true:"pl-8"}}}),bu=_t(Fs,gu,["inset"]);Ye(({children:a,className:s,...e},n)=>t.jsxs(Ks,{className:J("relative flex select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50","cursor-pointer",s),ref:n,...e,children:[t.jsx("span",{className:"absolute left-2 flex size-3.5 items-center justify-center",children:t.jsx(Qt,{children:t.jsx(Z.check,{className:"size-4"})})}),a]}));Ye(({children:a,className:s,hideIcon:e,...n},i)=>t.jsxs(Ds,{className:J("relative flex select-none items-center rounded-sm pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50","h-9 cursor-pointer px-2 data-[state=checked]:bg-accent data-[state=checked]:text-accent-foreground",s),ref:i,...n,children:[!e&&t.jsx("span",{className:"absolute right-2 flex size-3.5 items-center justify-center",children:t.jsx(Qt,{children:t.jsx(Z.check,{className:"size-4"})})}),a]}));const yu=oe(J("select-none px-2 py-1.5 text-sm font-semibold"),{variants:{inset:{true:"pl-8"}}}),vu=_t(Ys,yu,["inset"]),Su=je(Hs,"-mx-1 my-1 h-px bg-muted");je(Pl("span"),"ml-auto text-xs tracking-widest opacity-60");const ju=()=>{const[a,s]=d.useState(!1);return{onOpenChange:d.useCallback((n=!a)=>{s(n)},[a]),open:a}},ze=Ul(Al({key:"directive",node:{isElement:!0,isInline:!0,isMarkableVoid:!0,isVoid:!0},options:{openEditorId:null,mode:"",editingDirective:null,directiveType:null}}).extendOptions(({getOptions:a})=>({isOpen:s=>a().openEditorId===s})).extendEditorApi(({setOptions:a})=>({floatingDirective:{hide:()=>{a({mode:"",openEditorId:null,editingDirective:null,directiveType:null})},show:(s,e,n,i)=>{a({mode:s,openEditorId:e,editingDirective:n,directiveType:i})}}})).extendEditorTransforms(({editor:a,type:s})=>({insert:{directive:({value:e})=>{Bl(a,{children:[{text:""}],type:s,value:e})}},edit:{directive:({value:e,at:n})=>{El(a,{children:[{text:""}],type:s,value:e},{at:n})}}})));var Je=(a=>(a.Animation="Animation",a.Sound="Sound",a.Util="Util",a.Filter="Filter",a.Transition="Transition",a))(Je||{});const ge={[j.Speak]:"发言",[j.Speaker]:"发言角色",[j.ChangeSource]:"变更",[j.Show]:"显示",[j.Hide]:"隐藏",[j.FadeIn]:"渐入",[j.FadeOut]:"渐出",[j.ShakeX]:"左右晃动",[j.ShakeY]:"上下晃动",[j.ZoomIn]:"放大",[j.ZoomOut]:"缩小",[j.EnterFromLeft]:"从左进入",[j.LeaveFromLeft]:"向左离开",[j.EnterFromRight]:"从右进入",[j.LeaveFromRight]:"向右离开",[j.Play]:"播放",[j.Pause]:"暂停",[j.Stop]:"停止",[j.Wait]:"停顿",[j.FadeInTransition]:"渐入转场",[j.AddFilter]:"添加滤镜",[j.RemoveFilter]:"移除滤镜"},yt=[j.ChangeSource,j.Show,j.Hide,j.FadeIn,j.FadeOut,j.ShakeX,j.ShakeY,j.ZoomIn,j.ZoomOut,j.EnterFromLeft,j.LeaveFromLeft,j.EnterFromRight,j.LeaveFromRight],wu=yt.map(a=>({name:ge[a],value:a})),ra=[j.Play,j.Pause,j.Stop],Nu=ra.map(a=>({name:ge[a],value:a})),la=[j.Wait],ca=[j.AddFilter,j.RemoveFilter],Vi=[j.FadeInTransition],Cu=la.map(a=>({name:ge[a],value:a})),Zu=ca.map(a=>({name:ge[a],value:a})),ku=Vi.map(a=>({name:ge[a],value:a})),Gu=[{name:"动画指令",type:"Animation",options:wu},{name:"音频指令",type:"Sound",options:Nu},{name:"工具指令",type:"Util",options:Cu},{name:"滤镜指令",type:"Filter",options:Zu},{name:"转场指令",type:"Transition",options:ku}];function Tu(a){if(yt.includes(a))return"Animation";if(ra.includes(a))return"Sound";if(la.includes(a))return"Util";if(ca.includes(a))return"Filter";if(Vi.includes(a))return"Transition"}const Ca=[{name:"纯黑",value:"BlackMaskFilter"},{name:"模糊",value:"BlurFilter"},{name:"噪点",value:"NoiseFilter"},{name:"老电影",value:"OldFilmFilter"},{name:"暗角",value:"VignetteFilter"}],da=(a,{directiveElement:s,directiveType:e}={})=>{const{api:n}=Ol(a,ze);if(s){const i=s.value.directive,o=Tu(i);n.floatingDirective.show("edit",a.id,s,o)}else n.floatingDirective.show("insert",a.id,null,e)};function Tt(a){const[s,e]=d.useState(window.matchMedia(a).matches);return d.useEffect(()=>{const n=window.matchMedia(a);n.matches!==s&&e(n.matches);const i=()=>e(n.matches);return n.addEventListener("change",i),()=>n.removeEventListener("change",i)},[s,a]),s}function Vu({triggerFloatingLinkHotkeys:a,floatingOptions:s}){const e=Tt("(min-width: 640px)"),{editor:n,api:i,tf:o,useOption:r,setOption:l,getOptions:c}=As(ze),u=r("mode"),h=r("isOpen",n.id),m=r("editingDirective"),f=Jl({onOpenChange:k=>l("openEditorId",k?n.id:null),getBoundingClientRect:Ql,open:h&&["insert","edit"].includes(u),...s}),x=_l(k=>{const W=k.target;W!==document.documentElement&&(W.closest("[data-disable-click-outside]")||W.closest("#asset-library")||["insert","edit"].includes(c().mode)&&(i.floatingDirective.hide(),dt(n,n.selection)))},{disabled:!h});Te.useEffect(()=>{h&&f.update()},[h,f.update]);const b=k=>{o.insert.directive({value:k}),ql(n,{unit:"offset"}),i.floatingDirective.hide(),setTimeout(()=>{dt(n,n.selection)},0)},T=k=>{const W=n.selection,[,X]=ec(n,{at:W,match:{type:n.getType(ze)}});o.edit.directive({value:k,at:X}),i.floatingDirective.hide()},G=k=>{m?T(k):b(k)},v=()=>{i.floatingDirective.hide(),setTimeout(()=>{dt(n,n.selection)},0)};return{props:{style:e?{...f.style,zIndex:50}:{...f.style,position:"fixed",left:"50%",top:"50%",transform:"translate(-50%, -50%)",zIndex:50}},ref:$l(f.refs.setFloating,x),onSubmit:G,onCancel:v}}const Ru=[{items:[{description:"工具指令",icon:Z.squarePlus,label:"工具指令",value:Je.Util},{description:"转场指令",icon:Z.squarePlus,label:"转场指令",value:Je.Transition},{description:"滤镜指令",icon:Z.squarePlus,label:"滤镜指令",value:Je.Filter}],label:"更多指令"}];function Wu(a){const s=Tt("(min-width: 640px)"),e=Vn(),n=ju();function i(o){da(e,{directiveType:o}),s&&dt(e)}return t.jsxs(mu,{modal:!1,...n,...a,children:[t.jsx(pu,{asChild:!0,children:t.jsx(Ee,{isDropdown:!0,pressed:n.open,tooltip:"更多指令",children:t.jsx(Z.add,{className:"size-4"})})}),t.jsx(xu,{align:"start",className:"flex max-h-[500px] min-w-0 flex-col gap-0.5 overflow-y-auto",children:Ru.map(({items:o,label:r},l)=>t.jsxs(Te.Fragment,{children:[l!==0&&t.jsx(Su,{}),t.jsx(vu,{children:r}),o.map(({icon:c,label:u,value:h})=>t.jsxs(bu,{className:"min-w-[180px]",onSelect:()=>i(h),children:[t.jsx(c,{className:"mr-2 size-4"}),u]},h))]},r))})]})}const De=d.forwardRef(({className:a,...s},e)=>t.jsx(Rn,{className:g("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...s,ref:e,children:t.jsx(tc,{className:g("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));De.displayName=Rn.displayName;const Lu=y.object({wordsPerMin:y.number().optional(),interval:y.number().optional(),effect:y.string().optional(),speaker:y.object({name:y.string().optional(),autoShowSpeaker:y.object({inEffect:y.string()}).optional(),autoMaskOtherSpeakers:y.object({alpha:y.number()}).optional()})});function Ri({speak:a,onChangeSpeak:s,disableCustomName:e=!1}){const n=qe({resolver:et(Lu),defaultValues:a}),i=ne({control:n.control});return d.useEffect(()=>{n.formState.isDirty&&s({...a,...i,speaker:{...a.speaker,...i.speaker}})},[n.formState.isDirty,i]),t.jsx(at,{...n,children:t.jsxs("form",{className:"space-y-2",children:[!e&&t.jsx(D,{control:n.control,name:"speaker.name",render:({field:o})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"自定义角色名"}),t.jsx(ct,{children:"用于自定义对话中显示的角色名"}),t.jsx(F,{children:t.jsx(M,{className:"h-8",placeholder:"请输入自定义角色名",...o})}),t.jsx(Y,{})]})}),t.jsx(D,{control:n.control,name:"wordsPerMin",render:({field:o})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"语速（字/分钟）"}),t.jsx(ct,{children:"角色发言的速度，默认值参考平均阅读速度"}),t.jsx(F,{children:t.jsx(M,{className:"h-8",type:"number",min:0,step:100,placeholder:"请输入语速",value:String(o.value),onChange:r=>{const l=Number(r.target.value);o.onChange(l)}})}),t.jsx(Y,{})]})}),t.jsx(D,{control:n.control,name:"interval",render:({field:o})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"停顿时长（秒）"}),t.jsx(ct,{children:"角色发言后的停顿时长"}),t.jsx(F,{children:t.jsx(M,{className:"h-8",type:"number",min:0,step:.1,placeholder:"请输入停顿时长",value:String(o.value),onChange:r=>{const l=Number(r.target.value);o.onChange(l)}})}),t.jsx(Y,{})]})}),t.jsx(D,{control:n.control,name:"effect",render:({field:o})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"台词效果"}),t.jsx(ct,{children:"台词的输出效果"}),t.jsx(F,{children:t.jsxs(ve,{onValueChange:o.onChange,value:o.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"请选择台词效果"})}),t.jsxs(ue,{children:[t.jsx(ee,{value:"typewriter",children:"打字机"}),t.jsx(ee,{value:"fadeIn",children:"渐入"}),t.jsx(ee,{value:"none",children:"无"})]})]})}),t.jsx(Y,{})]})}),t.jsx(D,{control:n.control,name:"speaker.autoShowSpeaker",render:({field:o})=>t.jsxs(I,{className:"flex flex-row items-center space-y-0",children:[t.jsx(K,{className:"w-[8rem]",children:"自动显示发言角色"}),t.jsx(F,{children:t.jsx(De,{checked:!!o.value,onCheckedChange:o.onChange})}),t.jsx(Y,{})]})}),t.jsx(D,{control:n.control,name:"speaker.autoMaskOtherSpeakers",render:({field:o})=>t.jsxs(I,{className:"flex flex-row items-center space-y-0",children:[t.jsx(K,{className:"w-[8rem]",children:"自动阴影其他角色"}),t.jsx(F,{children:t.jsx(De,{checked:!!o.value,onCheckedChange:o.onChange})}),t.jsx(Y,{})]})})]})})}const Xu=y.object({voice:y.object({label:y.string(),targetName:y.string(),volume:y.number().optional()})});function Iu({speak:a,onChangeSpeak:s}){const{selectAsset:e}=Gt(),n=R(c=>c.editor),i=qe({resolver:et(Xu),defaultValues:a}),o=ne({control:i.control}),r=async c=>{const u=await e(C.Audio);if(u){const h=ii(u);n.addSound(h),i.setValue("voice.label",h.label),c(h.name)}},l=c=>{n.removeSoundByName(o.voice.targetName),i.setValue("voice.label",""),c("")};return d.useEffect(()=>{i.formState.isDirty&&s({...a,...o})},[i.formState.isDirty,o]),t.jsx(at,{...i,children:t.jsxs("form",{className:"space-y-2",children:[t.jsx(D,{control:i.control,name:"voice.targetName",render:({field:c})=>{var u;return t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"配音文件"}),t.jsx(F,{children:t.jsx("div",{className:"flex gap-1 items-center",children:c.value&&((u=o.voice)!=null&&u.label)?t.jsxs(t.Fragment,{children:[t.jsx("span",{children:o.voice.label}),t.jsx(V,{type:"button",size:"sm",variant:"ghost",className:"px-1",children:t.jsx(Z.edit,{className:"size-4 cursor-pointer",onClick:()=>r(c.onChange)})}),t.jsx(V,{type:"button",size:"sm",variant:"ghost",className:"px-1",children:t.jsx(Z.delete,{className:"size-4 cursor-pointer",onClick:()=>l(c.onChange)})})]}):t.jsx(V,{type:"button",size:"sm",onClick:()=>r(c.onChange),children:"选择素材"})})}),t.jsx(Y,{})]})}}),t.jsx(D,{control:i.control,name:"voice.volume",render:({field:c})=>{var u;return t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"音量"}),t.jsx(F,{children:t.jsx(os,{min:0,max:1,step:.1,value:[(u=c.value)!=null?u:1],onValueChange:h=>c.onChange(h[0])})}),t.jsx(Y,{})]})}})]})})}const Za={name:"Narrator",label:"旁白"};function Fu({speak:a,onChangeSpeak:s,children:e}){var T;const n=Tt("(min-width: 640px)"),i=R(G=>G.activeScene),o=d.useMemo(()=>{const G=[Za];return i?[...G,...i.children.filter(v=>v.assetType===C.Character)]:G},[i]),r=Vn(),{selectAsset:l}=Gt(),[c,u]=d.useState(!1),h=R(G=>G.editor),m=G=>{const v=o.find(S=>S.name===G);s({...a,speaker:{...a.speaker,speakerTargetName:v==null?void 0:v.name,name:(v==null?void 0:v.name)===Za.name?"":(v==null?void 0:v.label)||""}})},f=G=>{da(r,{directiveType:G}),n&&dt(r)},x=async()=>{u(!1);const G=await l(C.Character);if(G){const v=await gt(G,h);h.addChild(v),s({...a,speaker:{...a.speaker,speakerTargetName:v.name,name:v.label}})}},b=G=>{if(G.target.closest("#asset-library")){G.preventDefault();return}};return t.jsxs("div",{className:"w-full flex flex-wrap",children:[t.jsxs(Na,{noSeparator:!0,children:[t.jsxs(ve,{open:c,onOpenChange:u,value:a.speaker.speakerTargetName||"",onValueChange:m,children:[t.jsx(he,{className:"w-[100px] md:w-[130px] h-8",children:t.jsx(Se,{placeholder:"选择发言角色"})}),t.jsxs(ue,{children:[o.map(G=>t.jsx(ee,{value:G.name,children:G.label},G.name)),t.jsx("div",{onClick:x,className:"cursor-pointer select-none py-1.5 pl-2 pr-8 text-sm hover:bg-slate-100 rounded-sm","data-disable-click-outside":!0,children:"添加并选择角色..."})]})]}),t.jsxs(Et,{children:[t.jsx(Ot,{asChild:!0,children:t.jsx(Ee,{className:"px-1",tooltip:"发言设置",children:t.jsx(Z.settings,{className:"!size-4 cursor-pointer mx-1"})})}),t.jsx(bt,{children:t.jsx(Ri,{speak:a,onChangeSpeak:s})})]}),t.jsxs(Et,{children:[t.jsx(Ot,{asChild:!0,children:t.jsx(Ee,{className:"px-1",tooltip:"配音设置",children:t.jsx(Z.mic,{className:g("!size-4 cursor-pointer mx-1",(T=a.voice)!=null&&T.targetName?"text-blue-500":"")})})}),t.jsx(bt,{onInteractOutside:b,children:t.jsx(Iu,{speak:a,onChangeSpeak:s})})]}),t.jsxs(Ee,{className:"px-1 text-xs",onClick:()=>f(Je.Animation),tooltip:"插入动画",children:[t.jsx(Z.squarePlus,{className:"!size-4 md:mr-0.5 hidden md:flex"}),"动画"]}),t.jsxs(Ee,{className:"px-1 text-xs",onClick:()=>f(Je.Sound),tooltip:"插入音频",children:[t.jsx(Z.squarePlus,{className:"!size-4 md:mr-0.5 hidden md:flex"}),"音频"]}),t.jsx(Wu,{})]}),t.jsx(Na,{className:"ml-auto",children:e})]})}function Ku(){const[a,s]=d.useState(!1);return d.useEffect(()=>{s(!0)},[]),a}const zu=Ye(({children:a,className:s,prefix:e,...n},i)=>{const o=sc(),r=ac(),l=nc(),c=Ku(),{editor:u}=As(ze),h=()=>{da(u,{directiveElement:o})};return t.jsx(ic,{className:J("inline-block cursor-pointer rounded-md bg-muted px-1.5 py-0.5 align-baseline text-sm font-medium select-none mx-0.5",r&&l&&"ring-2 ring-ring",o.children[0].bold===!0&&"font-bold",o.children[0].italic===!0&&"italic",o.children[0].underline===!0&&"underline",s),contentEditable:!1,onClick:h,ref:i,...n,children:c&&oc?t.jsxs(Te.Fragment,{children:[a,e,o.value.label||""]}):t.jsxs(Te.Fragment,{children:[e,o.value.label||"",a]})})}),Wi=oe("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 print:hidden");Ye(({align:a="center",className:s,sideOffset:e=4,style:n,...i},o)=>t.jsx(wn,{children:t.jsx(Ms,{align:a,className:J(Wi(),s),ref:o,sideOffset:e,style:{zIndex:1e3,...n},...i})}));const Du=d.forwardRef(({form:a},s)=>{const e=R(h=>h.activeScene),[n,i]=d.useState([]),[o,r]=d.useState([]),l=ne({control:a.control,name:"directive"}),c=ne({control:a.control,name:"params.targetName"}),u=ne({control:a.control,name:"params.source"});return d.useEffect(()=>{if(e){const h=[],m=[],f=[];let x=[];for(const b of e.children){const T={value:b.name,label:b.label};b.assetType===C.Character?h.push(T):b.assetType===C.Background?f.push(T):b.assetType===C.Thing?m.push(T):b.name&&x.push(T)}l===j.ChangeSource&&(x=x.filter(b=>b.assetID)),i([{label:"角色",options:h},{label:"背景",options:f},{label:"物品",options:m},{label:"其他",options:x}])}},[e,l]),d.useEffect(()=>{if(e&&l===j.ChangeSource&&c){const h=e.children.find(m=>m.name===c);h!=null&&h.assetID?O.get(h.assetID).then(m=>{const f=m.states.map(x=>({value:ie(x),label:x.name}));r(f)}):r([])}},[e,l,c,a]),d.useImperativeHandle(s,()=>({getDirectiveLabel:()=>{var h,m;if(e&&l&&c){const f=ge[l],x=((h=e.children.find(T=>T.name===c))==null?void 0:h.label)||"",b=[f,x];if(l===j.ChangeSource&&u){const T=((m=o.find(G=>G.value===u))==null?void 0:m.label)||"";b.push(T)}return b.join(":")}return""}}),[e,l,c,u,o]),t.jsxs(t.Fragment,{children:[t.jsx(D,{control:a.control,name:"params.targetName",render:({field:h})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"动画对象"}),t.jsx(F,{children:t.jsxs(ve,{onValueChange:m=>{h.onChange(m),a.setValue("params.source","")},value:h.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"请选择动画对象"})}),t.jsxs(ue,{children:[n.map(m=>m.options.length>0&&t.jsxs(na,{children:[t.jsx(rs,{children:m.label}),m.options.map(f=>t.jsx(ee,{value:f.value,children:f.label},f.value))]},m.label)),n.every(m=>m.options.length===0)&&t.jsx("div",{className:"select-none py-1.5 pl-2 pr-8 text-sm opacity-50",children:"请先在画布中添加角色、背景等素材"})]})]})}),t.jsx(Y,{})]})}),l===j.ChangeSource&&o.length>0&&t.jsx(D,{control:a.control,name:"params.source",render:({field:h})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"目标状态"}),t.jsx(F,{children:t.jsxs(ve,{onValueChange:h.onChange,value:h.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"请选择目标状态"})}),t.jsx(ue,{children:o.map(m=>t.jsx(ee,{value:m.value,children:m.label},m.value))})]})}),t.jsx(Y,{})]})}),l!==j.ChangeSource&&t.jsx(D,{control:a.control,name:"params.duration",render:({field:h})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"动画时长(秒)"}),t.jsx(F,{children:t.jsx(M,{type:"number",min:0,step:.1,placeholder:"不填则使用默认值",value:h.value||"",onChange:m=>{const f=Number(m.target.value);h.onChange(f)},className:"h-8"})}),t.jsx(Y,{})]})})]})}),Yu=d.forwardRef(({form:a},s)=>{const e=ne({control:a.control,name:"directive"}),n=ne({control:a.control,name:"params.duration"});return d.useImperativeHandle(s,()=>({getDirectiveLabel:()=>"".concat(ge[e],":").concat(n!=null?n:0,"秒")}),[n,e]),t.jsx(D,{control:a.control,name:"params.duration",render:({field:i})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"停顿时间(秒)"}),t.jsx(F,{children:t.jsx(M,{type:"number",min:0,step:.1,placeholder:"请输入停顿时间",value:String(i.value),onChange:o=>{const r=Number(o.target.value);i.onChange(r)},className:"h-8"})}),t.jsx(Y,{})]})})}),Hu=d.forwardRef(({form:a},s)=>{const e=R(f=>f.activeScene),n=R(f=>f.editor),[i,o]=d.useState([]),r=ne({control:a.control,name:"directive"}),l=ne({control:a.control,name:"params.targetName"}),{selectAsset:c}=Gt(),[u,h]=d.useState(!1),m=async f=>{h(!1);const x=await c(C.Audio);if(x){const b=ii(x);n.addSound(b),setTimeout(()=>{f(b.name)},150)}};return d.useEffect(()=>{if(e){const f=e.sounds.map(x=>({label:x.label,value:x.name}));o([{label:"音频",options:f}])}},[e]),d.useImperativeHandle(s,()=>({getDirectiveLabel:()=>{var f;if(e&&r&&l){const x=ge[r],b=((f=e.sounds.find(G=>G.name===l))==null?void 0:f.label)||"";return[x,b].join(":")}return""}}),[e,r,l]),t.jsxs(t.Fragment,{children:[t.jsx(D,{control:a.control,name:"params.targetName",render:({field:f})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"目标音频"}),t.jsx(F,{children:t.jsxs(ve,{open:u,onOpenChange:h,onValueChange:f.onChange,value:f.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"请选择目标音频"})}),t.jsxs(ue,{children:[i.map(x=>x.options.length>0&&t.jsxs(na,{children:[t.jsx(rs,{children:x.label}),x.options.map(b=>t.jsx(ee,{value:b.value,children:b.label},b.value))]},x.label)),t.jsx("div",{onClick:()=>m(f.onChange),className:"cursor-pointer select-none py-1.5 pl-2 pr-8 text-sm hover:bg-slate-100 rounded-sm","data-disable-click-outside":!0,children:"添加并选择音频..."})]})]})}),t.jsx(Y,{})]})}),r===j.Play&&t.jsxs(t.Fragment,{children:[t.jsx(D,{control:a.control,name:"params.start",render:({field:f})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"开始时间(秒)"}),t.jsx(F,{children:t.jsx(M,{type:"number",min:0,step:1,placeholder:"默认从0秒开始",value:f.value||"",onChange:x=>{const b=Number(x.target.value);f.onChange(b)},className:"h-8"})}),t.jsx(Y,{})]})}),t.jsx(D,{control:a.control,name:"params.volume",render:({field:f})=>{var x;return t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"音量"}),t.jsx(F,{children:t.jsx(os,{min:0,max:1,step:.1,value:[(x=f.value)!=null?x:1],onValueChange:b=>f.onChange(b[0])})}),t.jsx(Y,{})]})}}),t.jsx(D,{control:a.control,name:"params.loop",render:({field:f})=>t.jsxs(I,{className:"space-y-0 flex flex-row items-center",children:[t.jsx(K,{className:"flex flex-col w-[4rem]",children:"循环"}),t.jsx(F,{children:t.jsx(De,{checked:f.value,onCheckedChange:f.onChange})}),t.jsx(Y,{})]})}),t.jsx(D,{control:a.control,name:"params.untilEnd",render:({field:f})=>t.jsxs(I,{className:"space-y-0 flex flex-row items-center",children:[t.jsx(K,{className:"flex flex-col w-[4rem]",children:"跨场景"}),t.jsx(F,{children:t.jsx(De,{checked:f.value,onCheckedChange:f.onChange})}),t.jsx(Y,{})]})})]})]})}),Mu=d.forwardRef(({form:a},s)=>{const e=R(r=>r.activeScene),[n,i]=d.useState([]),o=ne({control:a.control,name:"directive"});return d.useEffect(()=>{if(e){const r=[],l=[],c=[],u=[];for(const h of e.children){const m={value:h.name,label:h.label};h.assetType===C.Character?r.push(m):h.assetType===C.Background?c.push(m):h.assetType===C.Thing?l.push(m):h.name&&u.push(m)}i([{label:"角色",options:r},{label:"背景",options:c},{label:"物品",options:l},{label:"其他",options:u}])}},[e]),d.useImperativeHandle(s,()=>({getDirectiveLabel:()=>{const r=[ge[o]],l=a.getValues("params.targetName"),c=n.flatMap(m=>m.options).find(m=>m.value===l),u=c?c.label:"全场景";r.push(u);const h=a.getValues("params.filterName");if(h){const m=Ca.find(x=>x.value===h),f=m?m.name:"";r.push(f)}return r.join(":")}}),[a,o,n]),t.jsxs(t.Fragment,{children:[t.jsx(D,{control:a.control,name:"params.targetName",render:({field:r})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"滤镜对象"}),t.jsx(F,{children:t.jsxs(ve,{onValueChange:r.onChange,value:r.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"为空则默认全场景滤镜"})}),t.jsx(ue,{children:n.map(l=>l.options.length>0&&t.jsxs(na,{children:[t.jsx(rs,{children:l.label}),l.options.map(c=>t.jsx(ee,{value:c.value,children:c.label},c.value))]},l.label))})]})}),t.jsx(Y,{})]})}),o===j.AddFilter&&t.jsx(D,{control:a.control,name:"params.filterName",render:({field:r})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"滤镜效果"}),t.jsx(F,{children:t.jsxs(ve,{onValueChange:r.onChange,value:r.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"请选择滤镜效果"})}),t.jsx(ue,{children:Ca.map(l=>t.jsx(ee,{value:l.value,children:l.name},l.value))})]})}),t.jsx(Y,{})]})})]})}),Pu=d.forwardRef(({form:a},s)=>(d.useImperativeHandle(s,()=>({getDirectiveLabel:()=>{const e=a.getValues("directive");return ge[e]}})),t.jsx(t.Fragment,{children:t.jsx(D,{control:a.control,name:"params.duration",render:({field:e})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:"转场时长"}),t.jsx(F,{children:t.jsx(M,{type:"number",min:0,step:.1,placeholder:"不填则使用默认值",value:e.value||"",onChange:n=>{const i=Number(n.target.value);e.onChange(i)},className:"h-8"})}),t.jsx(Y,{})]})})}))),Uu=y.discriminatedUnion("directive",[y.object({directive:y.literal(yt[0]),params:y.object({targetName:y.string({message:"请选择动画对象"}),source:y.string().min(1,{message:"请输入目标状态"}),duration:y.number().optional(),sequential:y.boolean().optional()})}),...yt.slice(1).map(a=>y.object({directive:y.literal(a),params:y.object({targetName:y.string({message:"请选择动画对象"}),duration:y.number().optional(),sequential:y.boolean().optional()})})),y.object({directive:y.literal(j.Wait),params:y.object({duration:y.number().optional(),sequential:y.boolean().optional()})}),y.object({directive:y.literal(j.Play),params:y.object({targetName:y.string({message:"请选择音频对象"}),start:y.number().optional(),volume:y.number().optional(),loop:y.boolean().optional(),untilEnd:y.boolean().optional(),sequential:y.boolean().optional()})}),...[j.Pause,j.Stop].map(a=>y.object({directive:y.literal(a),params:y.object({targetName:y.string({message:"请选择音频对象"}),sequential:y.boolean().optional()})})),y.object({directive:y.literal(j.AddFilter),params:y.object({targetName:y.string({message:"请选择滤镜对象"}),filterName:y.string({message:"请选择滤镜"}),sequential:y.boolean().optional()})}),y.object({directive:y.literal(j.RemoveFilter),params:y.object({targetName:y.string({message:"请选择滤镜对象"}),sequential:y.boolean().optional()})}),y.object({directive:y.literal(j.FadeInTransition),params:y.object({duration:y.number().optional(),sequential:y.boolean().optional()})})]);function Au({editingDirective:a,directiveType:s,onSubmitDirective:e,onCancel:n}){const i=qe({resolver:et(Uu),defaultValues:{directive:void 0,params:{}}}),o=ne({control:i.control,name:"directive"}),r=d.useRef(null),l=d.useRef(null),c=d.useRef(null),u=d.useRef(null),h=d.useRef(null),m=d.useMemo(()=>Gu.find(x=>x.type===s),[s]);d.useEffect(()=>{a?i.reset(a.value,{keepDefaultValues:!0}):i.reset()},[a,i.reset,i]);function f(x){let b="";r.current?b=r.current.getDirectiveLabel():l.current?b=l.current.getDirectiveLabel():c.current?b=c.current.getDirectiveLabel():u.current?b=u.current.getDirectiveLabel():h.current&&(b=h.current.getDirectiveLabel()),e({...x,label:b})}return t.jsx(at,{...i,children:t.jsxs("form",{onSubmit:i.handleSubmit(f),className:"space-y-2 flex flex-col h-full",children:[t.jsx(D,{control:i.control,name:"directive",render:({field:x})=>t.jsxs(I,{className:"space-y-1",children:[t.jsx(K,{children:m==null?void 0:m.name}),t.jsx(F,{children:t.jsxs(ve,{onValueChange:x.onChange,value:x.value,children:[t.jsx(he,{className:"h-8",children:t.jsx(Se,{placeholder:"请选择指令"})}),t.jsx(ue,{children:m==null?void 0:m.options.map(b=>t.jsx(ee,{value:b.value,children:b.name},b.value))})]})})]})}),yt.includes(o)&&t.jsx(Du,{form:i,ref:r}),la.includes(o)&&t.jsx(Yu,{form:i,ref:l}),ra.includes(o)&&t.jsx(Hu,{form:i,ref:c}),ca.includes(o)&&t.jsx(Mu,{form:i,ref:u}),o===j.FadeInTransition&&t.jsx(Pu,{form:i,ref:h}),o&&o!==j.Wait&&t.jsx(D,{control:i.control,name:"params.sequential",render:({field:x})=>t.jsxs(I,{className:"space-y-0 flex flex-row items-center !mb-4",children:[t.jsx(K,{className:"flex flex-col w-[4rem]",children:"串行执行"}),t.jsx(F,{children:t.jsx(De,{checked:x.value,onCheckedChange:x.onChange})}),t.jsx(Y,{})]})}),t.jsxs("div",{className:"pt-2 !mt-auto sticky left-0 bottom-0 bg-white w-full flex justify-center border-t border-t-border gap-2",children:[t.jsx(V,{size:"sm",type:"submit",children:"确定"}),t.jsx(V,{size:"sm",type:"button",onClick:n,variant:"outline",children:"取消"})]})]})})}const Bu={middleware:[rc(12),lc({fallbackPlacements:["bottom-end","top-start","top-end"],padding:12})],placement:"bottom-start"};function Eu(){const a=dc({preventDefaultOnEnterKeydown:!0}),{useOption:s}=As(ze),e=s("editingDirective"),n=s("directiveType"),{ref:i,props:o,onSubmit:r,onCancel:l}=Vu({floatingOptions:Bu,triggerFloatingLinkHotkeys:"mod+k"});return t.jsx(cc,{children:t.jsx("div",{className:J(Wi(),"w-auto p-1"),...o,ref:i,children:t.jsx("div",{className:"flex w-[200px] h-[400px] overflow-auto flex-col p-2",...a,children:n&&t.jsx(Au,{editingDirective:e,directiveType:n,onSubmitDirective:r,onCancel:l})})})})}function Ou({value:a,onChange:s,onFocus:e,children:n}){const i=hc({plugins:[uc,ze.extend({render:{afterEditable:()=>t.jsx(Eu,{})}}),mc],override:{components:{[ze.key]:zu}},value:a.lines}),o=d.useRef(!1),r=({value:u})=>{if(o.current){o.current=!1;return}s({...a,lines:u})},l=u=>{s({...a,speak:u})},c=()=>{e(a)};return d.useEffect(()=>{i.children!==a.lines&&(o.current=!0,i.tf.setValue(a.lines))},[a.lines,i]),t.jsx(pc,{editor:i,onValueChange:r,children:t.jsxs("div",{className:"relative rounded-md border bg-background border-border",onFocus:c,children:[t.jsx(uu,{children:t.jsx(Fu,{speak:a.speak,onChangeSpeak:l,children:n})}),t.jsx(Ti,{focusRing:!1,variant:"ghost",size:"sm"})]})})}function ka({onClose:a}){const s=R(v=>v.editor),e=R(v=>v.project),n=R(v=>v.activeScene),[i,o]=d.useState(!1),r=d.useRef(null),l=v=>{s.updateActiveScene(S=>{S.config.speak=v})},c=v=>{s.updateActiveScene(S=>{S.config.autoShowBackground=v})},u=v=>{const{config:S}=n;s.addDialogue({speak:s.cloneDialogueSpeak(S.speak),lines:[]},v),G()},h=(v,S)=>{s.addDialogue({speak:s.cloneDialogueSpeak(S.speak),lines:[]},v)},m=v=>{s.updateActiveScene(S=>{S.label=v})},f=(v,S)=>{if(s.activeScene){const{speaker:k,targetName:W}=s.activeScene.config.speak||{};if(k){const X=s.activeScene.getChildByName(k.targetName);X&&(X.text=S.speak.speaker.name)}if(S.lines.length>0){const X=s.activeScene.getChildByName(W);let A="";S.lines.forEach(B=>{if(B.type==="p")for(let $=0;$<B.children.length;$++){const w=B.children[$];if(!w.type){let L=w.text;$===B.children.length-1&&(L+="\n"),A+=L}}}),A&&X&&(X.text=A)}}},x=(v,S)=>{s.updateDialogue(v,S),f(v,S)},b=(v,S)=>{const k=s.cloneDialogue(v);s.addDialogue(k,S)},T=(v,S)=>{s.swapDialogue(v,S)},G=()=>{setTimeout(()=>{r.current&&r.current.scrollToBottom()},100)};return t.jsx(He,{className:"w-full flex-1 h-full border-0 md:border shadow-none md:shadow rounded-md",children:t.jsx(Ve,{className:"h-full p-1 md:p-2",children:n?t.jsxs(t.Fragment,{children:[t.jsx(we,{className:"w-full h-full pr-2",ref:r,children:t.jsxs("div",{className:"flex flex-col m-1 mr-0 pr-1",children:[t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsxs(ce,{htmlFor:"sceneName",className:"flex justify-between items-center",children:[t.jsx("span",{children:"场景标题"}),t.jsxs("div",{className:"flex items-center",children:[t.jsxs(Et,{children:[t.jsx(Ot,{asChild:!0,children:t.jsx(V,{size:"sm",variant:"ghost",children:t.jsx(Z.settings,{className:"size-4"})})}),t.jsx(bt,{children:t.jsxs("div",{className:"flex flex-col",children:[t.jsx("h3",{className:"text-base font-bold",children:"场景设置"}),t.jsx(Ri,{speak:n.config.speak,onChangeSpeak:l,disableCustomName:!0}),t.jsxs("div",{className:"flex mt-2",children:[t.jsx("span",{className:"text-sm font-medium w-[8rem]",children:"自动展示背景"}),t.jsx(De,{checked:n.config.autoShowBackground,onCheckedChange:c})]})]})})]}),t.jsx(Zi,{children:t.jsxs(ki,{children:[t.jsx(Gi,{asChild:!0,children:t.jsx(V,{size:"sm",variant:"ghost",onClick:()=>o(!0),children:t.jsx(Z.bookmark,{className:"size-4"})})}),t.jsx(oa,{children:t.jsx("p",{children:"保存为模版"})})]})}),a&&t.jsx(V,{className:"-mr-3",size:"sm",variant:"ghost",onClick:a,children:t.jsx(Z.close,{className:"size-4"})})]})]}),t.jsx(M,{type:"text",id:"sceneName",placeholder:"请输入场景标题",value:n.label,onChange:v=>m(v.target.value)})]}),t.jsxs("div",{className:"flex flex-col gap-2 mt-4",children:[t.jsx(ce,{children:"场景对白"}),n.dialogues.map((v,S)=>t.jsx("div",{children:t.jsx(Ou,{value:v,onChange:k=>x(S,k),onFocus:k=>f(S,k),children:t.jsxs(Js,{children:[t.jsx(Qs,{children:t.jsx(Z.more,{className:"size-4 cursor-pointer mx-1"})}),t.jsxs(ss,{children:[t.jsx(q,{onClick:()=>h(S+1,v),children:"插入"}),t.jsx(q,{onClick:()=>b(v,S+1),children:"复制"}),t.jsx(q,{className:"text-destructive",onClick:()=>{s.removeDialogue(v)},children:"删除"}),t.jsx(_s,{}),S>0&&t.jsx(q,{onClick:()=>T(S,S-1),children:"上移"}),S<n.dialogues.length-1&&t.jsx(q,{onClick:()=>T(S,S+1),children:"下移"})]})]})})},S))]}),t.jsx(V,{className:"mt-2",onClick:()=>u(),children:"新增对白"})]})}),t.jsx(wh,{isOpen:i,onClose:()=>o(!1),sceneName:n.name})]}):t.jsx("div",{className:"h-full text-lg flex items-center justify-center text-muted-foreground/50",children:e?"请先创建场景":"请先创建或打开作品"})})})}function Ju({url:a,className:s}){const[e,n]=d.useState(!1),i=d.useRef(null),o=r=>{r.stopPropagation(),i.current&&(e?i.current.pause():i.current.play(),n(!e))};return t.jsxs("div",{className:g("w-full aspect-[1/1] flex justify-center items-center cursor-pointer relative",s),children:[t.jsx("audio",{ref:i,src:a,className:"hidden"}),t.jsx(V,{onClick:o,variant:"outline",size:"icon",className:"w-12 h-12",children:e?t.jsx(fc,{className:"h-6 w-6"}):t.jsx(xc,{className:"h-6 w-6"})})]})}function Qu({url:a,className:s}){return t.jsx("div",{className:g("w-full h-full cursor-pointer flex justify-center items-center relative",s),style:{backgroundImage:'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><rect width="10" height="10" fill="%23ccc"/><rect x="10" y="10" width="10" height="10" fill="%23ccc"/></svg>\')'},children:a&&t.jsx("img",{src:a,className:"absolute left-0 top-0 h-full w-full object-contain"})})}function _u(){return"font-".concat(Date.now())}function $u({fontName:a,fontUrl:s,className:e}){const n=d.useMemo(()=>{if(a)return a;if(s)return _u()},[a,s]);return d.useEffect(()=>{if(a)return;const i=document.createElement("style");return i.innerHTML="\n      @font-face {\n        font-family: '".concat(n,"';\n        src: url('").concat(s,"');\n      }\n    "),document.head.appendChild(i),()=>{a||document.head.removeChild(i)}},[n,a,s]),t.jsxs("div",{className:g("w-full aspect-[1/1] flex flex-col justify-center items-center relative",e),style:{fontFamily:n},children:[t.jsx("span",{children:"示例文字"}),t.jsx("span",{children:"Sample Text"}),t.jsx("span",{children:"0123456789"})]})}function qu({url:a,className:s}){return t.jsx("video",{src:a,className:g("w-full h-full",s),controls:!0,muted:!0})}const em={[C.Background]:"240px",[C.Character]:"135px",[C.Thing]:"200px",[C.Dialog]:"240px",[C.Audio]:"150px",[C.Font]:"150px"},js={[C.Background]:"aspect-[16/9]",[C.Character]:"aspect-[9/16]",[C.Thing]:"aspect-[1/1]",[C.Dialog]:"aspect-[16/3]"};function Li({type:a,url:s,ext:e,state:n}){const i=d.useMemo(()=>s||(n?ie(n):""),[s,n]),o=d.useMemo(()=>e||(n?n.ext:""),[e,n]);return Object.keys(js).includes(a)?o==="mp4"?t.jsx(qu,{url:i,className:js[a]}):t.jsx(Qu,{url:i,className:js[a]}):a===C.Audio?t.jsx(Ju,{url:i}):a===C.Font?t.jsx($u,{fontName:n==null?void 0:n.name,fontUrl:i}):null}function Xi({type:a,state:s,children:e,onSelect:n}){return t.jsx(He,{className:"rounded-md cursor-pointer",style:{width:em[a]},onClick:n,children:e||t.jsxs(t.Fragment,{children:[t.jsx(Ve,{className:"p-2 flex justify-center",children:t.jsx(Li,{type:a,state:s})}),t.jsx(ts,{className:"font-medium p-2 pt-0 flex justify-center text-sm break-all",children:s.name})]})})}function tm({asset:a,onSelect:s,onEdit:e,onDelete:n}){return t.jsxs(He,{className:"rounded-md",children:[t.jsx(Ve,{className:"p-0 flex justify-center cursor-pointer",onClick:s,children:t.jsx(Z.folder,{className:"w-[120px] h-[120px] text-neutral-600 p-2"})}),t.jsxs(ts,{className:"w-[120px] font-medium p-2 pt-0 flex justify-between text-sm",children:[t.jsx("div",{className:"max-w-[100px] overflow-hidden text-ellipsis cursor-pointer",onClick:s,children:a.name}),t.jsxs(Js,{children:[t.jsx(Qs,{children:t.jsx(Z.more,{className:"w-4 h-4 pointer"})}),t.jsxs(ss,{children:[t.jsx(q,{onClick:e,children:"编辑"}),t.jsx(q,{className:"text-destructive",onClick:n,children:"删除"})]})]})]})]})}function sm({type:a,url:s,ext:e,className:n,onChange:i}){const[o,r]=d.useState(null),[l,c]=d.useState(null),u=d.useMemo(()=>o||s||"",[s,o]),h=d.useMemo(()=>l||e||"",[e,l]),m=d.useMemo(()=>ai(a),[a]),f=d.useRef(null),x=T=>{var v;o&&URL.revokeObjectURL(o);const G=(v=T.target.files)==null?void 0:v[0];r(URL.createObjectURL(G)),c(ut(G).ext),i(G)},b=()=>{var T;(T=f.current)==null||T.click()};return d.useEffect(()=>()=>{o&&URL.revokeObjectURL(o)},[o]),t.jsxs("div",{className:g("flex cursor-pointer group relative",n),onClick:b,children:[t.jsx("input",{type:"file",ref:f,onChange:x,className:"hidden",accept:m}),t.jsxs("div",{className:"size-full flex justify-center items-center text-sm invisible group-hover:visible bg-muted/80 absolute left-0 right-0 z-20",children:[t.jsx(gc,{className:"size-4"}),t.jsx("div",{children:"选择文件"})]}),t.jsx(Li,{url:u,type:a,ext:h})]})}const am=oe("relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),Ii=d.forwardRef(({className:a,variant:s,...e},n)=>t.jsx("div",{ref:n,role:"alert",className:g(am({variant:s}),a),...e}));Ii.displayName="Alert";const nm=d.forwardRef(({className:a,...s},e)=>t.jsx("h5",{ref:e,className:g("mb-1 font-medium leading-none tracking-tight",a),...s}));nm.displayName="AlertTitle";const Fi=d.forwardRef(({className:a,...s},e)=>t.jsx("div",{ref:e,className:g("text-sm [&_p]:leading-relaxed",a),...s}));Fi.displayName="AlertDescription";const im=y.object({id:y.number().optional(),name:y.string().min(1,{message:"名称必填"}),type:y.string().min(1,{message:"类型必选"}),states:y.array(y.object({id:y.number().optional(),name:y.string().min(1,{message:"状态名称必填"}),ext:y.string().optional(),file:y.instanceof(File).optional()}).refine(a=>a.id||a.file,{message:"状态文件必选"})).min(1,{message:"至少需要一个状态"})});function om({asset:a,onSubmit:s,onCancel:e}){const n=d.useMemo(()=>zd[a.type],[a.type]),i=qe({resolver:et(im),defaultValues:{name:"",type:"",states:[]}}),{fields:o,append:r,remove:l}=bc({control:i.control,name:"states",keyName:"_id"}),c=h=>{s(h)},u=(h,m)=>{i.setValue("states.".concat(m,".file"),h),i.getValues("states.".concat(m,".name"))||i.setValue("states.".concat(m,".name"),ut(h).name)};return d.useEffect(()=>{i.reset({id:a.id,name:a.name,type:a.type,states:a.states})},[a,i]),t.jsxs("div",{children:[t.jsxs("h3",{className:"text-base font-bold mb-2",children:[a.id?"编辑":"新增",n,t.jsx(Ii,{className:"p-2 mt-1",children:t.jsxs(Fi,{className:"text-muted-foreground font-normal flex gap-1 items-center",children:[t.jsx(Z.tip,{className:"size-4"}),[C.Background,C.Character,C.Thing,C.Dialog].includes(a.type)&&t.jsx("span",{children:"画布的尺寸为1920*1080"}),a.type===C.Audio&&t.jsx("span",{children:"音频采样率建议>=44100Hz"}),a.type===C.Font&&t.jsx("span",{children:"请使用woff/woff2/ttf字体格式"})]})})]}),t.jsx(at,{...i,children:t.jsxs("form",{onSubmit:i.handleSubmit(c),className:"space-y-4",children:[t.jsx(D,{control:i.control,name:"name",render:({field:h})=>t.jsxs(I,{children:[t.jsxs(K,{children:[n,"名"]}),t.jsx(F,{children:t.jsx(M,{placeholder:"请输入".concat(n,"名"),...h})}),t.jsx(Y,{})]})}),t.jsxs(I,{children:[t.jsxs(K,{className:"flex items-center",children:[n,"状态",t.jsxs(V,{size:"sm",variant:"outline",onClick:()=>r({name:""}),className:"ml-2",children:[t.jsx(Z.squarePlus,{className:"size-4 mr-1"}),"新增状态"]})]}),t.jsx(F,{children:t.jsx("div",{children:o.length>0&&t.jsxs(we,{className:"w-full whitespace-nowrap rounded-md border",children:[t.jsx("div",{className:"flex w-full gap-2 p-2",children:o.map((h,m)=>t.jsx(Xi,{type:a.type,state:h,children:t.jsxs(t.Fragment,{children:[t.jsx(Ve,{className:"p-2 flex justify-center",children:t.jsx(sm,{className:"w-full h-full",type:a.type,ext:h.ext,url:h.id&&ie(h),onChange:f=>u(f,m)})}),t.jsx(ts,{className:"font-medium p-2 pt-0 flex flex-col gap-1",children:t.jsxs("div",{className:"flex w-full justify-between",children:[t.jsx(D,{control:i.control,name:"states.".concat(m,".name"),render:({field:f})=>t.jsx(I,{children:t.jsx(F,{children:t.jsx(M,{className:"h-6 text-sm",placeholder:"请输入状态名",...f})})})}),t.jsx(Z.delete,{className:"size-4 ml-1 mt-1 flex-shrink-0 cursor-pointer hover:text-destructive",onClick:()=>l(m)})]})})]})},m))}),t.jsx(Os,{orientation:"horizontal"})]})})}),t.jsx(Y,{})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(V,{type:"submit",children:"确定"}),t.jsx(V,{type:"button",className:"mr-2",variant:"outline",onClick:e,children:"取消"})]})]})})]})}function rm({asset:a,onEdit:s,onSelectState:e,onCancel:n}){var i;return t.jsxs("div",{className:"h-[calc(100%-2.5rem)] flex flex-col",children:[t.jsxs("h3",{className:"text-base font-bold mb-4 flex justify-between items-center",children:["选择默认状态",t.jsx(V,{className:"ml-1 mr-auto",variant:"ghost",size:"sm",onClick:()=>s(a),children:t.jsx(Z.edit,{className:"size-4"})}),t.jsx(V,{variant:"outline",size:"sm",onClick:n,children:"返回列表"})]}),t.jsx(we,{className:"flex-1",children:t.jsx("div",{className:"flex gap-2 flex-wrap",children:(i=a.states)==null?void 0:i.map(o=>t.jsx(Xi,{type:a.type,state:o,onSelect:()=>e(o)},o.id))})})]})}function lm(){const a=Tt("(min-width: 640px)"),s=le(w=>w.isOpen),e=le(w=>w.confirm),n=le(w=>w.cancel),i=le(w=>w.disableSelect),o=le(w=>w.type),[r,l]=d.useState(o),[c,u]=d.useState(null),[h,m]=d.useState(null),f=vt(()=>r?O.where("type").equals(r).reverse().toArray():[],[r]),x=w=>{l(w)},b=()=>{u({name:"",type:r,states:[]})},T=w=>{u(w)},G=w=>{w.states.forEach(L=>{Ge.delete(L.id)}),O.delete(w.id)},v=()=>{n(),u(null),m(null)},S=async w=>{for(const L of w.states){const re=ut(L.file).ext,nt=await Ge.add({mime:L.file.type,blob:L.file,ext:re});L.id=nt,L.ext=re,delete L.file,w.type===C.Font&&Cs(L.name,ie(L))}await O.add(w)},k=async w=>{for(const L of w.states){if(L.file){L.id&&await Ge.delete(L.id);const re=ut(L.file).ext,nt=await Ge.add({mime:L.file.type,blob:L.file,ext:re});L.id=nt,L.ext=re,w.type===C.Font&&Cs(L.name,ie(L))}delete L.file}await O.update(w.id,w)},W=async w=>{if(w.id){if(await k(w),h){const L=await O.get(w.id);m(L)}}else await S(w);u(null)},X=()=>{u(null)},A=w=>{i||(e({...h,stateId:w.id}),m(null))},B=()=>{m(null)};d.useEffect(()=>{l(o||C.Character)},[o]);const $=()=>c?t.jsx(om,{asset:c,onSubmit:W,onCancel:X}):h?t.jsx(rm,{asset:h,onEdit:w=>T(w),onSelectState:A,onCancel:B}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx(aa,{value:r,onValueChange:x,children:t.jsx(is,{children:$s.map(w=>t.jsx(Xe,{value:w.value,disabled:o&&o!==w.value,children:w.name},w.value))})}),t.jsxs(V,{size:"sm",onClick:b,children:[t.jsx(Z.squarePlus,{className:"w-3.5 h-3.5 mr-0.5"}),a&&"新增"]})]}),t.jsx(we,{className:"flex-grow",children:t.jsx("div",{className:"flex gap-2 flex-wrap",children:f==null?void 0:f.map(w=>t.jsx(tm,{asset:w,onSelect:()=>m(w),onEdit:()=>T(w),onDelete:()=>G(w)},w.id))})})]});return t.jsx(Ne,{open:s,onOpenChange:v,children:t.jsxs(me,{id:"asset-library",className:g("min-w-[90vw] h-[90vh] flex flex-col",!a&&"px-2"),children:[t.jsxs(pe,{children:[t.jsx(fe,{children:"素材库"}),t.jsx(xe,{})]}),$()]})})}const cm=yc,Ki=d.forwardRef(({className:a,...s},e)=>t.jsx(Wn,{ref:e,className:g("fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",a),...s}));Ki.displayName=Wn.displayName;const dm=oe("group pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground"}},defaultVariants:{variant:"default"}}),zi=d.forwardRef(({className:a,variant:s,...e},n)=>t.jsx(Ln,{ref:n,className:g(dm({variant:s}),a),...e}));zi.displayName=Ln.displayName;const hm=d.forwardRef(({className:a,...s},e)=>t.jsx(Xn,{ref:e,className:g("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium transition-colors hover:bg-secondary focus:outline-none focus:ring-1 focus:ring-ring disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",a),...s}));hm.displayName=Xn.displayName;const Di=d.forwardRef(({className:a,...s},e)=>t.jsx(In,{ref:e,className:g("absolute right-1 top-1 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-1 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",a),"toast-close":"",...s,children:t.jsx(_a,{className:"h-4 w-4"})}));Di.displayName=In.displayName;const Yi=d.forwardRef(({className:a,...s},e)=>t.jsx(Fn,{ref:e,className:g("text-sm font-semibold [&+div]:text-xs",a),...s}));Yi.displayName=Fn.displayName;const Hi=d.forwardRef(({className:a,...s},e)=>t.jsx(Kn,{ref:e,className:g("text-sm opacity-90",a),...s}));Hi.displayName=Kn.displayName;function um(){const{toasts:a}=ns();return t.jsxs(cm,{children:[a.map(function({id:s,title:e,description:n,action:i,...o}){return t.jsxs(zi,{...o,children:[t.jsxs("div",{className:"grid gap-1",children:[e&&t.jsx(Yi,{children:e}),n&&t.jsx(Hi,{children:n})]}),i,t.jsx(Di,{})]},s)}),t.jsx(Ki,{})]})}const mm=({className:a})=>t.jsx(vc,{className:g("h-6 w-6 text-primary/60 animate-spin",a)});function pm(){const a=At(e=>e.isOpen),s=At(e=>e.loadingText);return t.jsx(Ne,{open:a,children:t.jsxs(me,{disableClose:!0,onPointerDownOutside:e=>e.preventDefault(),children:[t.jsxs(pe,{className:"hidden",children:[t.jsx(fe,{}),t.jsx(xe,{})]}),t.jsxs("div",{className:"w-full flex gap-2 justify-center items-center",children:[t.jsx("div",{className:"font-bold text-xl",children:s}),t.jsx(mm,{})]})]})})}function fm(){const[a,s]=d.useState(!1),e=Tt("(min-width: 768px)"),[n,i]=d.useState(null),{toast:o}=ns(),r=()=>{s(!0)};return d.useEffect(()=>{Vc().then(l=>{i(l.video),l.audio||(ph(!0),o({title:"提示",description:"当前浏览器不支持音频合成，请使用最新桌面版的Chrome或Edge浏览器获取完整体验～",duration:1500}))})},[o]),n?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"h-screen flex flex-col",children:[t.jsx(qh,{}),t.jsxs("main",{className:"grid flex-1 gap-2 overflow-auto p-2 grid-cols-1 md:grid-cols-[minmax(450px,1fr)_2fr] bg-muted/50",children:[t.jsx("div",{className:"relative hidden md:flex h-[calc(100vh-53px-1rem)]",children:e&&t.jsx(ka,{})}),t.jsxs("div",{className:"relative flex h-full flex-col gap-2",children:[t.jsx(Mh,{}),t.jsxs("div",{className:"flex gap-2 h-[50vh] md:h-[30vh] flex-col sm:flex-row",children:[t.jsx($h,{}),t.jsx(uh,{onOpenSceneDetailDialog:r})]})]})]})]}),!e&&a&&t.jsx("div",{className:"fixed top-0 left-0 size-full z-50",children:t.jsx(ka,{onClose:()=>s(!1)})}),t.jsx(lm,{}),t.jsx(um,{}),t.jsx(pm,{})]}):t.jsx("div",{className:"flex h-screen items-center justify-center",children:n===!1?t.jsxs("div",{className:"text-center",children:[t.jsx("h1",{className:"text-2xl font-semibold",children:"您的浏览器不支持"}),t.jsx("p",{className:"text-sm",children:"请使用最新桌面版的Chrome或Edge浏览器～"})]}):t.jsx("div",{className:"text-center",children:"环境检测中..."})})}const xm=Sc([{path:"/",element:t.jsx(fm,{})}]);function gm(){return t.jsx(jc,{router:xm})}window.onbeforeunload=function(){return"确认离开？"};dh().finally(()=>{Md()});const bm=document.getElementById("root");wc.createRoot(bm).render(t.jsx(gm,{}));export{vm as __vite_legacy_guard};
